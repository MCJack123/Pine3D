local a=(...):match("(.-)[^%.]+$")local b=require(a.."betterblittle")local c={}for d=1,16 do c[2^(d-1)]=("0123456789abcdef"):sub(d,d)end;local e=math.pow(10,99)local function f(g,h,i,j)local k=i-g;if k==0 then return e,-e*g end;local l=(j-h)/k;return l,h-l*g end;local m=math.min;local n=math.max;local o=math.floor;local p=math.ceil;local function q(g,h,i,j)local r={x1=g,y1=h,x2=i,y2=j,width=i-g+1,height=j-h+1,screenBuffer={{}},blittleWindow=nil,blittleOn=false,backgroundColor=colors.lightBlue}function r:setBufferSize(s,t,u,v)self.x1=s;self.y1=t;self.x2=u;self.y2=v;self.width=u-s+1;self.height=v-t+1;if self.blittleWindow then self.blittleWindow=self.blittleWindow.reposition(self.x1,self.y1,self.x1+self.width-1,self.y1+self.height-1)end;self:clear()end;function r:clear()local w=self.screenBuffer;w.c2={}local x=w.c2;local y=self.width;local z=self.backgroundColor;if self.blittleOn then for A=1,self.height do x[A]={}local B=x[A]for C=1,y do B[C]=z end end else local D=c[z]w.c1={}local E=w.c1;w.chars={}local F=w.chars;for A=1,self.height do E[A]={}x[A]={}F[A]={}local G=E[A]local B=x[A]local H=F[A]for C=1,y do G[C]=D;B[C]=D;H[C]=" "end end end end;function r:fastClearNormal()local I=self.backgroundColor;local w=self.screenBuffer;local F=w.chars;local E=w.c1;local x=w.c2;local I=c[I]local y=self.width;for A=1,self.height do local H=F[A]local G=E[A]local B=x[A]for C=1,y do H[C]=" "G[C]=I;B[C]=I end end end;function r:fastClearBLittle()local I=self.backgroundColor;local x=self.screenBuffer.c2;local y=self.width;for A=1,self.height do local B=x[A]for C=1,y do B[C]=I end end end;function r:setPixel(C,A,E,x,J)C=math.floor(C+0.5)A=math.floor(A+0.5)if C>=1 and C<=self.width then if A>=1 and A<=self.height then local w=self.screenBuffer;if self.blittleOn then w.c2[A][C]=x or E else w.c1[A][C]=c[E]w.c2[A][C]=c[x or E]w.chars[A][C]=" "end end end end;function r:image(k,K,L)for A,M in pairs(L)do for C,N in pairs(M)do if N and N>0 then if self.blittleOn then self:setPixel(C+(k-1)*2,A+(K-1)*3,N,N," ")else self:setPixel(C+k-1,A+K-1,N,N," ")end end end end end;function r:loadLineNormal(g,h,i,j,I,J,O,l,P)local w=self.screenBuffer;local E=w.c1;local x=w.c2;local F=w.chars;local Q=self.width;local R=self.height;if i>=g then for C=n(p(g),1),m(o(i),Q)do local A=o(l*C+P+0.5)if A>0 and A<=R then E[A][C]=O;x[A][C]=I;F[A][C]=J end end else for C=n(p(i),1),m(o(g),Q)do local A=o(l*C+P+0.5)if A>0 and A<=R then E[A][C]=O;x[A][C]=I;F[A][C]=J end end end;if j>=h then for A=n(p(h),1),m(o(j),R)do local C=o((A-P)/l+0.5)if C>0 and C<=Q then E[A][C]=O;x[A][C]=I;F[A][C]=J end end else for A=n(p(j),1),m(o(h),R)do local C=o((A-P)/l+0.5)if C>0 and C<=Q then E[A][C]=O;x[A][C]=I;F[A][C]=J end end end end;function r:loadLineBLittle(g,h,i,j,I,l,P)local w=self.screenBuffer;local x=w.c2;local Q=self.width;local R=self.height;if i>=g then for C=n(p(g),1),m(o(i),Q)do local A=o(l*C+P+0.5)if A>0 and A<=R then x[A][C]=I end end else for C=n(p(i),1),m(o(g),Q)do local A=o(l*C+P+0.5)if A>0 and A<=R then x[A][C]=I end end end;if j>=h then for A=n(p(h),1),m(o(j),R)do local C=o((A-P)/l+0.5)if C>0 and C<=Q then x[A][C]=I end end else for A=n(p(j),1),m(o(h),R)do local C=o((A-P)/l+0.5)if C>0 and C<=Q then x[A][C]=I end end end end;local S=colors.black;function r:drawTriangleNormal(g,h,i,j,T,U,I,J,O,V)if g<1 and i<1 and T<1 or h<1 and j<1 and U<1 then return end;local Q=self.width;if g>Q and i>Q and T>Q then return end;local R=self.height;if h>R and j>R and U>R then return end;if h>j then h,j=j,h;g,i=i,g end;if j>U then U,j=j,U;T,i=i,T end;if h>j then h,j=j,h;g,i=i,g end;local w=self.screenBuffer;local o,p=o,p;local m,n=m,n;local W=m(n(1,p(h)),R)local X=m(n(0,o(j)),R)local Y=m(n(1,o(U)),R)local E=w.c1;local x=w.c2;local F=w.chars;local Z=(i-g)/(j-h)local _=(g-T)/(h-U)J=J or" "O=O or I;local I=c[I]local O=c[O]for A=W,X do local G=E[A]local B=x[A]local H=F[A]local a0=(A-h)*Z+g;local a1=(A-U)*_+T;if a1<a0 then a0,a1=a1,a0 end;if a0<1 then a0=1 end;if a0>Q then a0=Q end;if a1<1 then a1=1 end;if a1>Q then a1=Q end;for C=o(a0+0.5),o(a1+0.5)do G[C]=O;B[C]=I;H[C]=J end end;local a2=(T-i)/(U-j)local _=(g-T)/(h-U)for A=X+1,Y do local G=E[A]local B=x[A]local H=F[A]local a0=(A-j)*a2+i;local a1=(A-U)*_+T;if a1<a0 then a0,a1=a1,a0 end;if a0<1 then a0=1 end;if a0>Q then a0=Q end;if a1<1 then a1=1 end;if a1>Q then a1=Q end;for C=o(a0+0.5),o(a1+0.5)do G[C]=O;B[C]=I;H[C]=J end end;local V=V;if V or self.triangleEdges then local a3,a4=f(g,h,i,j)local a5,a6=f(i,j,T,U)local a7,a8=f(g,h,T,U)local a9=self.loadLineNormal;local I=c[V or S]a9(self,g,h,i,j,I,J,O,a3,a4)a9(self,i,j,T,U,I,J,O,a5,a6)a9(self,T,U,g,h,I,J,O,a7,a8)end end;function r:drawTriangleBLittle(g,h,i,j,T,U,I,J,O,V)if g<1 and i<1 and T<1 or h<1 and j<1 and U<1 then return end;local Q=self.width;if g>Q and i>Q and T>Q then return end;local R=self.height;if h>R and j>R and U>R then return end;if h>j then h,j=j,h;g,i=i,g end;if j>U then U,j=j,U;T,i=i,T end;if h>j then h,j=j,h;g,i=i,g end;local w=self.screenBuffer;local o,p=o,p;local m,n=m,n;local W=m(n(1,p(h)),R)local X=m(n(0,o(j)),R)local Y=m(n(1,o(U)),R)local x=w.c2;local Z=(i-g)/(j-h)local _=(g-T)/(h-U)if h~=j and h~=U then for A=W,X do local B=x[A]local a0=(A-h)*Z+g;local a1=(A-U)*_+T;if a1<a0 then a0,a1=a1,a0 end;if a0<1 then a0=0 end;if a0>Q then a0=Q+1 end;if a1<1 then a1=0 end;if a1>Q then a1=Q+1 end;for C=o(a0+0.5),o(a1+0.5)do B[C]=I end end end;local a2=(T-i)/(U-j)local _=(g-T)/(h-U)if U~=j and h~=U then for A=X+1,Y do local B=x[A]local a0=(A-j)*a2+i;local a1=(A-U)*_+T;if a1<a0 then a0,a1=a1,a0 end;if a0<1 then a0=0 end;if a0>Q then a0=Q+1 end;if a1<1 then a1=0 end;if a1>Q then a1=Q+1 end;for C=o(a0+0.5),o(a1+0.5)do B[C]=I end end end;local V=V;if V or self.triangleEdges then local a3,a4=f(g,h,i,j)local a5,a6=f(i,j,T,U)local a7,a8=f(g,h,T,U)local a9=self.loadLineBLittle;local I=V or S;a9(self,g,h,i,j,I,a3,a4)a9(self,i,j,T,U,I,a5,a6)a9(self,T,U,g,h,I,a7,a8)end end;function r:drawBufferNormal()local g=self.x1;local h=self.y1;local w=self.screenBuffer;local aa=term.setCursorPos;local ab=term.blit;local F=w.chars;local E=w.c1;local x=w.c2;local ac=table.concat;for A=1,self.height do aa(g,A+h-1)local F=ac(F[A])local E=ac(E[A])local x=ac(x[A])ab(F,E,x)end end;function r:drawBufferBLittle()local ad=self.blittleWindow;if not ad then self.blittleWindow=window.create(term.current(),self.x1,self.y1,self.x1+self.width-1,self.y1+self.height-1,false)ad=self.blittleWindow end;b.drawBuffer(self.screenBuffer.c2,ad)ad.setVisible(true)ad.setVisible(false)end;function r:highResMode(ae)self.blittleOn=ae;self.drawTriangle=ae and self.drawTriangleBLittle or self.drawTriangleNormal;self.fastClear=ae and self.fastClearBLittle or self.fastClearNormal;self.drawBuffer=ae and self.drawBufferBLittle or self.drawBufferNormal;self:clear()end;function r:useTriangleEdges(ae)self.triangleEdges=ae end;r:highResMode(true)return r end;local af=table.sort;local function ag(l,P,table)if table[l]==nil or table[P]==nil then return false end;if table[l][16]<table[P][16]then table[l],table[P]=table[P],table[l]return true end;return false end;local function ah(ai)for d=1,#ai do local aj=d;while ag(aj,aj+1,ai)do aj=aj-1 end end end;local function ak(ai)local al=#ai;local am=0;local an=ai[1][16]for d=2,al do local ao=ai[d][16]if ao<=an then am=am+1 end;an=ao end;local ap=am/(al-1)return ap end;local l=8;local function P(I)local aq=0;while I>=l do aq=bit.bor(aq,bit.band(I,1))I=bit.brshift(I,1)end;return I+aq end;local function ar(as,at,au)for d=at+1,au do local av=as[d]local aw=av[16]local ax=d-1;while ax>=at and as[ax][16]>aw do as[ax+1]=as[ax]ax=ax-1 end;as[ax+1]=av end end;local function ay(as,at,au,al,az,aq)local aA=az-al+1;local aB=aq-az;for aC=0,aA-1 do at[aC]=as[al+aC]end;for aC=0,aB-1 do au[aC]=as[az+1+aC]end;local d=0;local ax=0;local aD=al;while d<aA and ax<aB do if at[d][16]<=au[ax][16]then as[aD]=at[d]d=d+1 else as[aD]=au[ax]ax=ax+1 end;aD=aD+1 end;while d<aA do as[aD]=at[d]aD=aD+1;d=d+1 end;while ax<aB do as[aD]=au[ax]aD=aD+1;ax=ax+1 end end;local function aE(as)local I=#as;local aF=P(l)local aG=math.min;for d=1,I,aF do ar(as,d,aG(d+l-1,I))end;local aH,aI={},{}local C=aF;while C<=I do for at=1,I,2*C do local A=at+C-1;local au=aG(A+C,I)if A<au then ay(as,aH,aI,at,A,au)end end;C=2*C end;for d=1,math.floor(I/2)do as[d],as[I-d+1]=as[I-d+1],as[d]end end;local function aJ(aK,aL,aM,aN,aO)local aP=aO[1]local aQ=aO[2]local aR=aO[3]local aS=aL and aL-aP or 0;local aT=aM and aM-aQ or 0;local aU=aN and aN-aR or 0;for d=1,#aK do local aV=aK[d]local aW=aS+(aV[1]+aV[4]+aV[7])/3;local aX=aT+(aV[2]+aV[5]+aV[8])/3;local aY=aU+(aV[3]+aV[6]+aV[9])/3;aV[16]=aW*aW+aX*aX+aY*aY end;local ap=ak(aK)if ap==1 then elseif ap>0.7 then ah(aK)else aE(aK)end end;local aZ=math.rad;local a_=math.sin;local b0=math.cos;local function b1(C,A,b2,b3,b4)local b5=b4*b2-b3*A;local A=b3*b2+b4*A;local b2=b5;return C,A,b2 end;local function b6(C,A,b2,b3,b4)local b5=b4*b2-b3*C;local C=b3*b2+b4*C;local b2=b5;return C,A,b2 end;local function b7(C,A,b2,b3,b4)local j=b4*A-b3*C;local C=b3*A+b4*C;local A=j;return C,A end;local function b8(b9,ba,bb,bc)local bd,be=0,1;local bf,bg=0,1;local bh,bi=0,1;if ba==0 then ba=nil end;if ba then bd,be=a_(ba),b0(ba)end;if bb==0 then bb=nil end;if bb then bf,bg=a_(bb),b0(bb)end;if bc==0 then bc=nil end;if bc then bh,bi=a_(bc),b0(bc)end;local bj={}for bk,aV in pairs(b9)do local g,h,bl=aV[1],aV[2],aV[3]local i,j,b5=aV[4],aV[5],aV[6]local T,U,bm=aV[7],aV[8],aV[9]if bb then g,h,bl=b6(g,h,bl,bf,bg)i,j,b5=b6(i,j,b5,bf,bg)T,U,bm=b6(T,U,bm,bf,bg)end;if bc then g,h=b7(g,h,bl,bh,bi)i,j=b7(i,j,b5,bh,bi)T,U=b7(T,U,bm,bh,bi)end;if ba then g,h,bl=b1(g,h,bl,bd,be)i,j,b5=b1(i,j,b5,bd,be)T,U,bm=b1(T,U,bm,bd,be)end;bj[#bj+1]={g,h,bl,i,j,b5,T,U,bm}bj[#bj][10]=aV[10]bj[#bj][11]=aV[11]bj[#bj][12]=aV[12]bj[#bj][13]=aV[13]bj[#bj][14]=aV[14]bj[#bj][15]=aV[15]end;return bj end;local function bn(l,P,table)if table[l]==nil or table[P]==nil then return false end;if table[l][10]<table[P][10]then table[l],table[P]=table[P],table[l]return true end;return false end;local function bo(ai)for d=1,#ai do local aj=d;while bn(aj,aj+1,ai)do aj=aj-1 end end end;local function bp(ai)local al=#ai;local am=0;local an=ai[1][10]for d=2,al do local ao=ai[d][10]if ao<=an then am=am+1 end;an=ao end;local ap=am/(al-1)return ap end;local function bq(br,aO)local bs=aO[1]local bt=aO[2]local bu=aO[3]for d=1,#br do local bv=br[d]local bw=bv[1]local bx=bv[2]local by=bv[3]local bz=bw and bw-bs or 0;local bA=bx and bx-bt or 0;local bB=by and by-bu or 0;bv[10]=bz*bz+bA*bA+bB*bB end;local ap=bp(br)if ap==1 then elseif ap>0.7 then bo(br)else af(br,function(l,P)return l[10]>P[10]end)end end;local bC={}function bC.invertTriangles(b9)if not b9 or type(b9)~="table"then error("transforms.invertTriangles expected arg#1 to be a table (model)")end;for d=1,#b9 do local bD=b9[d]b9[d]={x1=bD.x1,y1=bD.y1,z1=bD.z1,x2=bD.x3,y2=bD.y3,z2=bD.z3,x3=bD.x2,y3=bD.y2,z3=bD.z2,c=bD.c,char=bD.char,charc=bD.charc,forceRender=bD.forceRender,outlineColor=bD.outlineColor}end;return b9 end;function bC.setOutline(b9,bE)if not b9 or type(b9)~="table"then error("transforms.invertTriangles expected arg#1 to be a table (model)")end;for d=1,#b9 do local bD=b9[d]if type(bE)=="table"then bD.outlineColor=bE[bD.c]or bD.outlineColor else bD.outlineColor=bE end end;return b9 end;function bC.mapColor(b9,bE)if not b9 or type(b9)~="table"then error("transforms.mapColor expected arg#1 to be a table (model)")end;for d=1,#b9 do local bD=b9[d]if type(bE)=="table"then bD.c=bE[bD.c]or bD.c else bD.c=bE end end;return b9 end;function bC.center(b9)local bF,bG=math.huge,-math.huge;local W,Y=math.huge,-math.huge;local bH,bI=math.huge,-math.huge;for d=1,#b9 do local bJ=b9[d]bF,bG=m(bF,bJ.x1),n(bG,bJ.x1)bF,bG=m(bF,bJ.x2),n(bG,bJ.x2)bF,bG=m(bF,bJ.x3),n(bG,bJ.x3)W,Y=m(W,bJ.y1),n(Y,bJ.y1)W,Y=m(W,bJ.y2),n(Y,bJ.y2)W,Y=m(W,bJ.y3),n(Y,bJ.y3)bH,bI=m(bH,bJ.z1),n(bI,bJ.z1)bH,bI=m(bH,bJ.z2),n(bI,bJ.z2)bH,bI=m(bH,bJ.z3),n(bI,bJ.z3)end;local bK=-(bG+bF)*0.5;local bL=-(Y+W)*0.5;local bM=-(bI+bH)*0.5;for d=1,#b9 do local bJ=b9[d]bJ.x1=bJ.x1+bK;bJ.x2=bJ.x2+bK;bJ.x3=bJ.x3+bK;bJ.y1=bJ.y1+bL;bJ.y2=bJ.y2+bL;bJ.y3=bJ.y3+bL;bJ.z1=bJ.z1+bM;bJ.z2=bJ.z2+bM;bJ.z3=bJ.z3+bM end;return b9 end;function bC.normalizeScale(b9)local bN=-math.huge;for d=1,#b9 do local bJ=b9[d]bN=n(bN,bJ.x1)bN=n(bN,bJ.x2)bN=n(bN,bJ.x3)bN=n(bN,bJ.y1)bN=n(bN,bJ.y2)bN=n(bN,bJ.y3)bN=n(bN,bJ.z1)bN=n(bN,bJ.z2)bN=n(bN,bJ.z3)end;for d=1,#b9 do local bJ=b9[d]bJ.x1=bJ.x1/bN;bJ.x2=bJ.x2/bN;bJ.x3=bJ.x3/bN;bJ.y1=bJ.y1/bN;bJ.y2=bJ.y2/bN;bJ.y3=bJ.y3/bN;bJ.z1=bJ.z1/bN;bJ.z2=bJ.z2/bN;bJ.z3=bJ.z3/bN end;return b9 end;function bC.normalizeScaleY(b9)local bN=-math.huge;for d=1,#b9 do local bJ=b9[d]bN=n(bN,bJ.y1)bN=n(bN,bJ.y2)bN=n(bN,bJ.y3)end;for d=1,#b9 do local bJ=b9[d]bJ.x1=bJ.x1/bN;bJ.x2=bJ.x2/bN;bJ.x3=bJ.x3/bN;bJ.y1=bJ.y1/bN;bJ.y2=bJ.y2/bN;bJ.y3=bJ.y3/bN;bJ.z1=bJ.z1/bN;bJ.z2=bJ.z2/bN;bJ.z3=bJ.z3/bN end;return b9 end;function bC.scale(b9,bO)for d=1,#b9 do local bJ=b9[d]bJ.x1=bJ.x1*bO;bJ.x2=bJ.x2*bO;bJ.x3=bJ.x3*bO;bJ.y1=bJ.y1*bO;bJ.y2=bJ.y2*bO;bJ.y3=bJ.y3*bO;bJ.z1=bJ.z1*bO;bJ.z2=bJ.z2*bO;bJ.z3=bJ.z3*bO end;return b9 end;function bC.translate(b9,k,K,bP)for d=1,#b9 do local bJ=b9[d]bJ.x1=bJ.x1+(k or 0)bJ.x2=bJ.x2+(k or 0)bJ.x3=bJ.x3+(k or 0)bJ.y1=bJ.y1+(K or 0)bJ.y2=bJ.y2+(K or 0)bJ.y3=bJ.y3+(K or 0)bJ.z1=bJ.z1+(bP or 0)bJ.z2=bJ.z2+(bP or 0)bJ.z3=bJ.z3+(bP or 0)end;return b9 end;function bC.rotate(b9,ba,bb,bc)local bd,be=0,1;local bf,bg=0,1;local bh,bi=0,1;if ba==0 then ba=nil end;if ba then bd,be=a_(ba),b0(ba)end;if bb==0 then bb=nil end;if bb then bf,bg=a_(bb),b0(bb)end;if bc==0 then bc=nil end;if bc then bh,bi=a_(bc),b0(bc)end;for d=1,#b9 do local aV=b9[d]local g,h,bl=aV.x1,aV.y1,aV.z1;local i,j,b5=aV.x2,aV.y2,aV.z2;local T,U,bm=aV.x3,aV.y3,aV.z3;if bb then g,h,bl=b6(g,h,bl,bf,bg)i,j,b5=b6(i,j,b5,bf,bg)T,U,bm=b6(T,U,bm,bf,bg)end;if bc then g,h=b7(g,h,bl,bh,bi)i,j=b7(i,j,b5,bh,bi)T,U=b7(T,U,bm,bh,bi)end;if ba then g,h,bl=b1(g,h,bl,bd,be)i,j,b5=b1(i,j,b5,bd,be)T,U,bm=b1(T,U,bm,bd,be)end;aV.x1,aV.y1,aV.z1=g,h,bl;aV.x2,aV.y2,aV.z2=i,j,b5;aV.x3,aV.y3,aV.z3=T,U,bm end;return b9 end;function bC.alignBottom(b9)local W=math.huge;for d=1,#b9 do local bJ=b9[d]W=m(W,bJ.y1)W=m(W,bJ.y2)W=m(W,bJ.y3)end;for d=1,#b9 do local bJ=b9[d]bJ.y1=bJ.y1-W;bJ.y2=bJ.y2-W;bJ.y3=bJ.y3-W end;return b9 end;function bC.decimate(b9,bQ,bR)local bS={}local bT={}local function bU(C,A,b2)for d=#bS,1,-1 do local bV=bS[d]if bV[1]==C and bV[2]==A and bV[3]==b2 then return d end end end;for d=1,#b9 do local bJ=b9[d]local bW=bU(bJ.x1,bJ.y1,bJ.z1)if not bW then bS[#bS+1]={bJ.x1,bJ.y1,bJ.z1}bW=#bS end;local bX=bU(bJ.x2,bJ.y2,bJ.z2)if not bX then bS[#bS+1]={bJ.x2,bJ.y2,bJ.z2}bX=#bS end;local bY=bU(bJ.x3,bJ.y3,bJ.z3)if not bY then bS[#bS+1]={bJ.x3,bJ.y3,bJ.z3}bY=#bS end;local bD={bW,bX,bY,bJ.c,bJ.char,bJ.charc,bJ.forceRender}bT[#bT+1]=bD end;local function bZ(b_,c0)local k=b_[1]-c0[1]local K=b_[2]-c0[2]local bP=b_[3]-c0[3]return(k*k+K*K+bP*bP)^0.5 end;local c1={}for d=1,#bT do local bD=bT[d]local c2=bZ(bS[bD[1]],bS[bD[2]])local c3=bZ(bS[bD[2]],bS[bD[3]])local c4=bZ(bS[bD[1]],bS[bD[3]])c1[#c1+1]={length=c2,vA=bD[1],vB=bD[2]}c1[#c1+1]={length=c3,vA=bD[2],vB=bD[3]}c1[#c1+1]={length=c4,vA=bD[1],vB=bD[3]}end;local function c5(c6,c7)local c8=bS[c6]local c9=bS[c7]local ca={(c8[1]+c9[1])*0.5,(c8[2]+c9[2])*0.5,(c8[3]+c9[3])*0.5}bS[#bS+1]=ca;local cb=#bS;for d=#bT,1,-1 do local cc=bT[d]if cc[1]==c6 or cc[1]==c7 or cc[2]==c6 or cc[2]==c7 or cc[3]==c6 or cc[3]==c7 then if cc[1]==c6 or cc[1]==c7 then cc[1]=cb end;if cc[2]==c6 or cc[2]==c7 then cc[2]=cb end;if cc[3]==c6 or cc[3]==c7 then cc[3]=cb end;if cc[1]==cc[2]or cc[2]==cc[3]or cc[1]==cc[3]then table.remove(bT,d)end end end;return cb end;local cd=bQ;if bR~="polys"then cd=#b9*bQ end;while#bT>cd do local ce=math.huge;local cf;for d=1,#c1 do local cg=c1[d]if cg.length<ce then ce=cg.length;cf=d end end;local ch=c1[cf]local cb=c5(ch.vA,ch.vB)for d=#c1,1,-1 do local cg=c1[d]local ci=cg.vA==ch.vA or cg.vA==ch.vB;local cj=cg.vB==ch.vA or cg.vB==ch.vB;if ci and cj then table.remove(c1,d)elseif ci then cg.vA=cb elseif cj then cg.vB=cb end end end;local ck={}for d=1,#bT do local bD=bT[d]local b_=bS[bD[1]]local c0=bS[bD[2]]local cl=bS[bD[3]]ck[#ck+1]={x1=b_[1],y1=b_[2],z1=b_[3],x2=c0[1],y2=c0[2],z2=c0[3],x3=cl[1],y3=cl[2],z3=cl[3],c=bD[4],char=bD[5],charc=bD[6],forceRender=bD[7]}end;for cm,cn in pairs(bC)do ck[cm]=cn end;return ck end;local co,cp;function bC.toLoD(b9,cq)cq=cq or{}local cr={minQuality=cq.minQuality or 0.1,variantCount=cq.variantCount or 4,qualityHalvingDistance=cq.qualityHalvingDistance or 5,quickInitWorseRuntime=cq.quickInitWorseRuntime or false}local cs,ct=cp(b9)local cu={{quality=1,collapsedModel=cs,size=ct}}local cv=b9;local cw=#cv;for d=1,cr.variantCount do local bQ=(1-cr.minQuality)*(1-d/cr.variantCount)+cr.minQuality;local cx=math.floor(cw*bQ+0.5)local cy=cv:decimate(cx,"polys")local cs,ct=cp(cy)cv=cy;local cz={quality=bQ,collapsedModel=cs,size=ct}cu[#cu+1]=cz end;local function cA(cB)local cC={}for d=1,#cB do local cz=cB[d]local b9=cz.collapsedModel;local cD={}for av=1,#b9 do local bJ=b9[av]local cE={bJ[1],bJ[2],bJ[3],bJ[4],bJ[5],bJ[6],bJ[7],bJ[8],bJ[9],bJ[10],bJ[11],bJ[12],bJ[13],bJ[14]}cD[av]=cE end;local cF={quality=cz.quality,size=cz.size,collapsedModel=cD}cC[d]=cF end;return cC end;local cG={}function cr:initObject(bv)local cH;if cr.quickInitWorseRuntime then cH=cu else cH=cA(cu)end;cG[bv]=cH;bv[7]=cH[1].collapsedModel;bv[8]=cH[1].size;bv[9]=cr end;function cr:update(bv,aO)local cH=cG[bv]if cH then local k=aO[1]-bv[1]local K=aO[2]-bv[2]local bP=aO[3]-bv[3]local aq=(k*k+K*K+bP*bP)^0.5;local cI=math.min(1,math.max(cr.minQuality,1/(aq/cr.qualityHalvingDistance)))local cJ=cr.variantCount+1-cr.variantCount*(cI-cr.minQuality)/(1-cr.minQuality)local cK=math.floor(cJ+0.5)local cz=cH[cK]bv[7]=cz.collapsedModel;bv[8]=cz.size end end;return cr end;local cL=math.sqrt;function cp(b9)local cM={}local cN=0;for d=1,#b9 do local aV=b9[d]cM[#cM+1]={}cM[#cM][1]=aV.x1;cM[#cM][2]=aV.y1;cM[#cM][3]=aV.z1;cM[#cM][4]=aV.x2;cM[#cM][5]=aV.y2;cM[#cM][6]=aV.z2;cM[#cM][7]=aV.x3;cM[#cM][8]=aV.y3;cM[#cM][9]=aV.z3;cM[#cM][10]=aV.forceRender;cM[#cM][11]=aV.c;cM[#cM][12]=aV.char;cM[#cM][13]=aV.charc;cM[#cM][14]=aV.outlineColor;cM[#cM][15]=d;local cO=cL(aV.x1*aV.x1+aV.y1*aV.y1+aV.z1*aV.z1)local cP=cL(aV.x2*aV.x2+aV.y2*aV.y2+aV.z2*aV.z2)local cQ=cL(aV.x3*aV.x3+aV.y3*aV.y3+aV.z3*aV.z3)if cO>cN then cN=cO end;if cP>cN then cN=cP end;if cQ>cN then cN=cQ end end;return cM,cN end;function co(cR)local cS=fs.open(cR,"r")if not cS then error("Could not find model for an object at path: "..cR)end;local cT=cS.readAll()cS.close()local b9=textutils.unserialise(cT)for cm,cn in pairs(bC)do b9[cm]=cn end;return b9 end;local cU=math.pi;local a_=math.sin;local b0=math.cos;local cV=math.tan;local cL=math.sqrt;local function cW(g,h,i,j)local y,cX=term.getSize()if g and i then y=i-g+1 end;if h and j then cX=j-h+1 end;local g=g or 1;local h=h or 1;local i=i or y-g+1;local j=j or cX-h+1;local cY={camera={0.000001,0.000001,0.000001,nil,0,0},buffer=q(g,h,i,j),x1=g,y1=h,x2=i,y2=j,width=y,height=cX,blittleOn=false,pixelratio=1.5}cY.FoV=90;cY.camera[7]=aZ(cY.FoV)cY.t=cV(aZ(cY.FoV/2))*2*0.0001;local cZ,c_,d0,d1;function cY:setBackgroundColor(I)local d2=self.buffer;d2.backgroundColor=I;d2:fastClear()end;local function d3()cZ=o(cY.width*0.5)+1;c_=o(cY.height*0.5)d0=0.0001*cY.width/cY.t;d1=-0.0001*cY.width/(cY.t*cY.height*cY.pixelratio)*cY.height end;function cY:setSize(g,h,i,j)self.x1=g;self.y1=h;self.x2=i;self.y2=j;if not self.blittleOn then self.buffer:setBufferSize(g,h,i,j)self.width=i-g+1;self.height=j-h+1;self.pixelratio=1.5 else self.width=(i-g+1)*2;self.height=(j-h+1)*3;self.pixelratio=1;self.buffer:setBufferSize(g,h,g+self.width-1,h+self.height-1)end;d3()end;function cY:highResMode(ae)self.blittleOn=ae;self.buffer:highResMode(ae)if ae then self.width=(self.x2-self.x1+1)*2;self.height=(self.y2-self.y1+1)*3;self.buffer:setBufferSize(self.x1,self.y1,self.x1+self.width-1,self.y1+self.height-1)self.pixelratio=1 else self.buffer:setBufferSize(self.x1,self.y1,self.x2,self.y2)self.width=self.x2-self.x1+1;self.height=self.y2-self.y1+1;self.pixelratio=1.5 end;d3()end;function cY:map3dTo2d(C,A,b2)local aO=self.camera;local d4=a_(aO[4]or 0)local d5=b0(aO[4]or 0)local d6=a_(-aO[5])local d7=b0(-aO[5])local d8=a_(aO[6])local d9=b0(aO[6])local bz=C-aO[1]local bA=A-aO[2]local bB=b2-aO[3]local da=d7*bz-d6*bB;bB=d6*bz+d7*bB;bz=da;local db=d9*bA-d8*bz;bz=d8*bA+d9*bz;bA=db;if d4~=0 then local dc=d4*bB-d5*bA;bA=d5*bB+d4*bA;bB=dc end;local dd=bB/bz*d0+cZ;local de=bA/bz*d1+c_;return dd,de,bz>=0.0001 end;function cY:drawObject(bv,aO,df)local bw=bv[1]local bx=bv[2]local by=bv[3]local d4=df[1]local d5=df[2]local d6=df[3]local d7=df[4]local d8=df[5]local d9=df[6]local dg=bw and bw-aO[1]or 0;local dh=bx and bx-aO[2]or 0;local di=by and by-aO[3]or 0;local cr=bv[9]if cr then cr:update(bv,aO)end;local b9=bv[7]if#b9<=0 then return end;local ct=bv[8]local bz=dg;local bA=dh;local bB=di;local da=d7*bz-d6*bB;local bB=d6*bz+d7*bB;local bz=da;local bz=d8*bA+d9*bz;if bz<-ct then return end;local dj=0.5*aO[7]local dk=a_(dj)local dl=b0(dj)if(bz+ct)*dk+(bB+ct)*dl<0 then return end;if(bz+ct)*dk-(bB-ct)*dl<0 then return end;local ba=bv[4]local bb=bv[5]local bc=bv[6]if ba and ba~=0 or bb and bb~=0 or bc and bc~=0 then b9=b8(b9,ba,bb,bc)end;aJ(b9,bw,bx,by,aO)local dm=dg*dg+dh*dh+di*di<ct*ct*4;local cZ=cZ;local c_=c_;local d0=d0;local d1=d1;local d4=d4;local d5=d5;local d6=d6;local d7=d7;local d8=d8;local d9=d9;local dg=dg;local dh=dh;local di=di;local function dn(bz,bA,bB)local da=d7*bz-d6*bB;bB=d6*bz+d7*bB;bz=da;local db=d9*bA-d8*bz;bz=d8*bA+d9*bz;bA=db;local dd=bB/bz*d0+cZ;local de=bA/bz*d1+c_;return dd,de,bz end;if d4~=0 then function dn(bz,bA,bB)local da=d7*bz-d6*bB;bB=d6*bz+d7*bB;bz=da;local db=d9*bA-d8*bz;bz=d8*bA+d9*bz;bA=db;local dc=d4*bB-d5*bA;bA=d5*bB+d4*bA;bB=dc;local dd=bB/bz*d0+cZ;local de=bA/bz*d1+c_;return dd,de,bz end end;local dp=b9;local d2=self.buffer;for d=1,#dp do local aV=dp[d]local g,h,dq=dn(aV[1]+dg,aV[2]+dh,aV[3]+di)if dq>0.00010000001 then local i,j,da=dn(aV[4]+dg,aV[5]+dh,aV[6]+di)if da>0.00010000001 then local T,U,dr=dn(aV[7]+dg,aV[8]+dh,aV[9]+di)if dr>0.00010000001 then if aV[10]or(i-g)*(U-j)-(j-h)*(T-i)<0 then d2:drawTriangle(g,h,i,j,T,U,aV[11],aV[12],aV[13],aV[14])end elseif dm then local function ds(C,A,b2)local bz=C+dg;local bA=A+dh;local bB=b2+di;local da=d7*bz-d6*bB;bB=d6*bz+d7*bB;bz=da;local db=d9*bA-d8*bz;bz=d8*bA+d9*bz;bA=db;if d4~=0 then local dc=d4*bB-d5*bA;bA=d5*bB+d4*bA;bB=dc end;local dd=bB/bz*d0+cZ;local de=bA/bz*d1+c_;return dd,de,bz,bA,bB end;local g,h,dq,dt,du=ds(aV[1],aV[2],aV[3])local i,j,da,db,dc=ds(aV[4],aV[5],aV[6])local T,U,dr,dv,dw=ds(aV[7],aV[8],aV[9])local dx=math.abs;local dy=dx(dr-0.0001)local dz=dx(dq-0.0001)local dA=dz+dy;local dB=(dw*dz+du*dy)/dA;local dC=(dv*dz+dt*dy)/dA;local cZ,d0,c_,d1=cZ,d0,c_,d1;local dD=dB*10000*d0+cZ;local dE=dC*10000*d1+c_;if aV[10]or(i-g)*(dE-j)-(j-h)*(dD-i)<0 then d2:drawTriangle(g,h,i,j,dD,dE,aV[11],aV[12],aV[13],aV[14])local dF=dx(da-0.0001)local dA=dF+dy;local dB=(dc*dy+dw*dF)/dA;local dC=(db*dy+dv*dF)/dA;local dG=dB*10000*d0+cZ;local dH=dC*10000*d1+c_;d2:drawTriangle(dG,dH,i,j,dD,dE,aV[11],aV[12],aV[13],aV[14])end end elseif dm then local function ds(C,A,b2)local bz=C+dg;local bA=A+dh;local bB=b2+di;local da=d7*bz-d6*bB;bB=d6*bz+d7*bB;bz=da;local db=d9*bA-d8*bz;bz=d8*bA+d9*bz;bA=db;if d4~=0 then local dc=d4*bB-d5*bA;bA=d5*bB+d4*bA;bB=dc end;local dd=bB/bz*d0+cZ;local de=bA/bz*d1+c_;return dd,de,bz,bA,bB end;local g,h,dq,dt,du=ds(aV[1],aV[2],aV[3])local i,j,da,db,dc=ds(aV[4],aV[5],aV[6])local T,U,dr,dv,dw=ds(aV[7],aV[8],aV[9])local dx=math.abs;if dr>0.00010000001 then local dF=dx(da-0.0001)local dz=dx(dq-0.0001)local dA=dz+dF;local dB=(dc*dz+du*dF)/dA;local dC=(db*dz+dt*dF)/dA;local cZ,d0,c_,d1=cZ,d0,c_,d1;local dD=dB*10000*d0+cZ;local dE=dC*10000*d1+c_;if aV[10]or(dD-g)*(U-dE)-(dE-h)*(T-dD)<0 then d2:drawTriangle(g,h,dD,dE,T,U,aV[11],aV[12],aV[13],aV[14])local dy=dx(dr-0.0001)local dA=dF+dy;local dB=(dc*dy+dw*dF)/dA;local dC=(db*dy+dv*dF)/dA;local dG=dB*10000*d0+cZ;local dH=dC*10000*d1+c_;d2:drawTriangle(dG,dH,dD,dE,T,U,aV[11],aV[12],aV[13],aV[14])end else local dz=dx(dq-0.0001)local dF=dx(da-0.0001)local dy=dx(dr-0.0001)local dI=dz+dF;local dJ=dz+dy;local dB=(du*dF+dc*dz)/dI;local dC=(dt*dF+db*dz)/dI;local cZ,d0,c_,d1=cZ,d0,c_,d1;local dD=dB*10000*d0+cZ;local dE=dC*10000*d1+c_;local dK=(du*dy+dw*dz)/dJ;local dL=(dt*dy+dv*dz)/dJ;local dG=dK*10000*d0+cZ;local dH=dL*10000*d1+c_;if aV[10]or(dD-g)*(dH-dE)-(dE-h)*(dG-dD)<0 then d2:drawTriangle(g,h,dD,dE,dG,dH,aV[11],aV[12],aV[13],aV[14])end end end elseif dm then local function ds(C,A,b2)local bz=C+dg;local bA=A+dh;local bB=b2+di;local da=d7*bz-d6*bB;bB=d6*bz+d7*bB;bz=da;local db=d9*bA-d8*bz;bz=d8*bA+d9*bz;bA=db;if d4~=0 then local dc=d4*bB-d5*bA;bA=d5*bB+d4*bA;bB=dc end;local dd=bB/bz*d0+cZ;local de=bA/bz*d1+c_;return dd,de,bz,bA,bB end;local g,h,dq,dt,du=ds(aV[1],aV[2],aV[3])local i,j,da,db,dc=ds(aV[4],aV[5],aV[6])local T,U,dr,dv,dw=ds(aV[7],aV[8],aV[9])local dx=math.abs;if da>0.00010000001 then if dr>0.00010000001 then local dz=dx(dq-0.0001)local dF=dx(da-0.0001)local dA=dz+dF;local dB=(du*dF+dc*dz)/dA;local dC=(dt*dF+db*dz)/dA;local cZ,d0,c_,d1=cZ,d0,c_,d1;local dD=dB*10000*d0+cZ;local dE=dC*10000*d1+c_;if aV[10]or(i-dD)*(U-j)-(j-dE)*(T-i)<0 then d2:drawTriangle(dD,dE,i,j,T,U,aV[11],aV[12],aV[13],aV[14])local dy=dx(dr-0.0001)local dA=dz+dy;local dB=(du*dy+dw*dz)/dA;local dC=(dt*dy+dv*dz)/dA;local dG=dB*10000*d0+cZ;local dH=dC*10000*d1+c_;d2:drawTriangle(dD,dE,dG,dH,T,U,aV[11],aV[12],aV[13],aV[14])end else local dz=dx(dq-0.0001)local dF=dx(da-0.0001)local dy=dx(dr-0.0001)local dI=dF+dz;local dJ=dF+dy;local dB=(du*dF+dc*dz)/dI;local dC=(dt*dF+db*dz)/dI;local cZ,d0,c_,d1=cZ,d0,c_,d1;local dD=dB*10000*d0+cZ;local dE=dC*10000*d1+c_;local dK=(dc*dy+dw*dF)/dJ;local dL=(db*dy+dv*dF)/dJ;local dG=dK*10000*d0+cZ;local dH=dL*10000*d1+c_;if aV[10]or(i-dD)*(dH-j)-(j-dE)*(dG-i)<0 then d2:drawTriangle(dD,dE,i,j,dG,dH,aV[11],aV[12],aV[13],aV[14])end end else if dr>0.00010000001 then local dz=dx(dq-0.0001)local dF=dx(da-0.0001)local dy=dx(dr-0.0001)local dI=dy+dz;local dJ=dy+dF;local dB=(du*dy+dw*dz)/dI;local dC=(dt*dy+dv*dz)/dI;local cZ,d0,c_,d1=cZ,d0,c_,d1;local dD=dB*10000*d0+cZ;local dE=dC*10000*d1+c_;local dK=(dc*dy+dw*dF)/dJ;local dL=(db*dy+dv*dF)/dJ;local dG=dK*10000*d0+cZ;local dH=dL*10000*d1+c_;if aV[10]or(dG-dD)*(U-dH)-(dH-dE)*(T-dG)<0 then d2:drawTriangle(dD,dE,dG,dH,T,U,aV[11],aV[12],aV[13],aV[14])end end end end end end;function cY:drawObjects(br)local aO=self.camera;local df={a_(aO[4]or 0),b0(aO[4]or 0),a_(-aO[5]),b0(-aO[5]),a_(aO[6]),b0(aO[6])}bq(br,aO)local br=br;for d=1,#br do self:drawObject(br[d],aO,df)end end;function cY:drawBuffer()local d2=self.buffer;d2:drawBuffer()d2:fastClear()end;function cY:setCamera(dM,dN,dO,ba,bb,bc)local aZ=math.rad;if type(dM)=="table"then local aO=dM;self.camera={aO.x or self.camera[1]or 0,aO.y or self.camera[2]or 0,aO.z or self.camera[3]or 0,aO.rotX and aZ(aO.rotX+90)or self.camera[4]or 0,aO.rotY and aZ(aO.rotY)or self.camera[5]or 0,aO.rotZ and aZ(aO.rotZ)or self.camera[6]or 0,self.camera[7]}else self.camera={dM or self.camera[1]or 0,dN or self.camera[2]or 0,dO or self.camera[3]or 0,ba and aZ(ba+90)or self.camera[4]or 0,bb and aZ(bb)or self.camera[5]or 0,bc and aZ(bc)or self.camera[6]or 0,self.camera[7]}end;if self.camera[4]==math.pi*0.5 then self.camera[4]=nil end end;function cY:setFoV(dj)self.FoV=dj or 90;self.t=cV(aZ(self.FoV/2))*2*0.0001;d3()self.camera[7]=aZ(self.FoV)end;function cY:setWireFrame(ae)self.buffer:useTriangleEdges(ae)end;function cY:getObjectIndexTrace(br,C,A)local function dP(dQ,dR,dS)return(dQ.x-dS.x)*(dR.y-dS.y)-(dR.x-dS.x)*(dQ.y-dS.y)end;local function dT(dU,dV,g,h,i,j,T,U,dW,dX,dY,dZ)local a4=dP({x=dU,y=dV},{x=g,y=h},{x=i,y=j})<0;local a6=dP({x=dU,y=dV},{x=i,y=j},{x=T,y=U})<0;local a8=dP({x=dU,y=dV},{x=T,y=U},{x=g,y=h})<0;return a4==a6 and a6==a8 end;local A=A-1;local d_={}if self.blittleOn then C=C*2;A=A*3+1 end;local aO=self.camera;local df={a_(aO[4]or 0),b0(aO[4]or 0),a_(-aO[5]),b0(-aO[5]),a_(aO[6]),b0(aO[6])}local d4=df[1]local d5=df[2]local d6=df[3]local d7=df[4]local d8=df[5]local d9=df[6]for d=1,#br do local bv=br[d]local b9=bv[7]local ba=bv[4]local bb=bv[5]local bc=bv[6]if ba and ba~=0 or bb and bb~=0 or bc and bc~=0 then b9=b8(b9,ba,bb,bc)end;local bw=bv[1]local bx=bv[2]local by=bv[3]local cZ=cZ;local c_=c_;local d0=d0;local d1=d1;local d4=d4;local d5=d5;local d6=d6;local d7=d7;local d8=d8;local d9=d9;local dg=bw-aO[1]local dh=bx-aO[2]local di=by-aO[3]local function dn(C,A,b2)local bz=C+dg;local bA=A+dh;local bB=b2+di;local da=d7*bz-d6*bB;bB=d6*bz+d7*bB;bz=da;local db=d9*bA-d8*bz;bz=d8*bA+d9*bz;bA=db;if d4~=0 then local dc=d4*bB-d5*bA;bA=d5*bB+d4*bA;bB=dc end;local dd=bB/bz*d0+cZ;local de=bA/bz*d1+c_;return dd,de,bz>0 end;for av=1,#b9 do local aV=b9[av]local g,h,e0=dn(aV[1],aV[2],aV[3])if e0 then local i,j,e1=dn(aV[4],aV[5],aV[6])if e1 then local T,U,e2=dn(aV[7],aV[8],aV[9])if e2 then if aV[10]or(i-g)*(U-j)-(j-h)*(T-i)<0 then if not self.blittleOn then if dT(C,A,g,h,i,j,T,U,self.x1,self.y1,self.x2,self.y2)then d_[#d_+1]={objectIndex=d,polygonIndex=aV[15]}end else if dT(C,A,g,h,i,j,T,U,(self.x2-1)*2+1,(self.y1-1)*3+1,self.x2*2,(self.y2+1)*3)then d_[#d_+1]={objectIndex=d,polygonIndex=aV[15]}end end end end end end end end;if#d_<=0 then return elseif#d_==1 then return d_[1].objectIndex,d_[1].polygonIndex end;local e3={}local e4=-1;local e5=math.huge;for d=1,#d_ do local bv=br[d_[d].objectIndex]local bz=aO[1]-bv[1]local bA=aO[2]-bv[2]local bB=aO[3]-bv[3]local e6=cL(bz*bz+bA*bA+bB*bB)if e6<e5 then e5=e6;e4=d_[d].objectIndex end end;for d=1,#d_ do local bv=br[d_[d].objectIndex]local bz=aO[1]-bv[1]local bA=aO[2]-bv[2]local bB=aO[3]-bv[3]local e6=cL(bz*bz+bA*bA+bB*bB)if e6==e5 then e3[#e3+1]=d_[d].polygonIndex end end;local bv=br[e4]local b9=bv[7]local e7=-1;local e8=math.huge;local aS=bv[1]-aO[1]local aT=bv[2]-aO[2]local aU=bv[3]-aO[3]for d=1,#e3 do local e9=e3[d]local aV=b9[e9]local aW=aS+(aV[1]+aV[4]+aV[7])/3;local aX=aT+(aV[2]+aV[5]+aV[8])/3;local aY=aU+(aV[3]+aV[6]+aV[9])/3;local e6=cL(aW*aW+aX*aX+aY*aY)if e6<e8 then e8=e6;e7=e3[d]end end;return e4,e7 end;function cY:newObject(b9,C,A,b2,ba,bb,bc)local cs=nil;local ct=nil;if type(b9)=="table"then if b9.initObject then else cs,ct=cp(b9)end else local ea=co(b9)cs,ct=cp(ea)end;local bv={C,A,b2,ba,bb,bc,cs,ct}bv.frame=self;function bv:setPos(eb,ec,ed)self[1]=eb or self[1]self[2]=ec or self[2]self[3]=ed or self[3]end;function bv:setRot(ee,ef,eg)self[4]=ee or self[4]self[5]=ef or self[5]self[6]=eg or self[6]end;function bv:setModel(eh)if type(eh)=="table"then cs,ct=cp(eh)self[7]=cs;self[8]=ct else local ea=co(eh)cs,ct=cp(ea)self[7]=cs;self[8]=ct end end;if type(b9)=="table"then if b9.initObject then b9:initObject(bv)end end;return bv end;d3()cY:highResMode(true)return cY end;local ei={}local function ej(g,h,bl,i,j,b5,T,U,bm,I)local bJ={x1=g,y1=h,z1=bl,x2=i,y2=j,z2=b5,x3=T,y3=U,z3=bm,c=I}return bJ end;function ei:cube(ek)ek.color=ek.color or colors.red;local el={ej(-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,ek.bottom or ek.color),ej(-.5,-.5,-.5,.5,-.5,-.5,.5,-.5,.5,ek.bottom2 or ek.bottom or ek.color),ej(-.5,.5,-.5,-.5,.5,.5,.5,.5,.5,ek.top or ek.color),ej(-.5,.5,-.5,.5,.5,.5,.5,.5,-.5,ek.top or ek.color),ej(-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,ek.side or ek.color),ej(-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,ek.side2 or ek.side or ek.color),ej(.5,-.5,-.5,.5,.5,.5,.5,-.5,.5,ek.side or ek.color),ej(.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,ek.side2 or ek.side or ek.color),ej(-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,ek.side or ek.color),ej(-.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5,ek.side2 or ek.side or ek.color),ej(-.5,-.5,.5,.5,-.5,.5,-.5,.5,.5,ek.side or ek.color),ej(.5,-.5,.5,.5,.5,.5,-.5,.5,.5,ek.side2 or ek.side or ek.color)}return el end;function ei:sphere(ek)ek.res=ek.res or 32;ek.color=ek.color or colors.red;local b9={}local em={}for d=0,ek.res do local A=0.5*b0(d/ek.res*cU)local en={}for av=0,ek.res do local eo=0.5*cL(1-A*2*A*2)local C=b0(av/ek.res*cU*2)*eo;local b2=a_(av/ek.res*cU*2)*eo;local i=b0((av+1)/ek.res*cU*2)*eo;local b5=a_((av+1)/ek.res*cU*2)*eo;if em[av]then b9[#b9+1]={x1=em[(av+1)%ek.res].x,y1=em[(av+1)%ek.res].y,z1=em[(av+1)%ek.res].z,x2=C,y2=A,z2=b2,x3=em[av].x,y3=em[av].y,z3=em[av].z,c=ek.color}b9[#b9+1]={x1=i,y1=A,z1=b5,x2=C,y2=A,z2=b2,x3=em[(av+1)%ek.res].x,y3=em[(av+1)%ek.res].y,z3=em[(av+1)%ek.res].z,c=ek.color2 or ek.color}end;en[av]={x=C,y=A,z=b2}end;em=en end;if ek.colors or ek.top or ek.bottom then for d=1,#b9 do local bJ=b9[d]local aX=(bJ.y1+bJ.y2+bJ.y3)/3;if ek.colors then local ep=o((-aX+0.5)*#ek.colors+1)bJ.c=ek.colors[ep]or bJ.c else if aX>=0 then bJ.c=ek.top or bJ.c else bJ.c=ek.bottom or bJ.c end end end end;return b9 end;function ei:icosphere(ek)ek.res=ek.res or 1;local eq=(1+cL(5))/2;local aH={{eq,1,0},{eq,-1,0},{-eq,-1,0},{-eq,1,0},{1,0,eq},{-1,0,eq},{-1,0,-eq},{1,0,-eq},{0,eq,1},{0,eq,-1},{0,-eq,-1},{0,-eq,1}}local function er(bW,bX,bY)return ej(aH[bW][1],aH[bW][2],aH[bW][3],aH[bX][1],aH[bX][2],aH[bX][3],aH[bY][1],aH[bY][2],aH[bY][3],ek.colors and 1 or ek.color)end;local b9={er(11,2,12),er(11,8,2),er(11,7,8),er(11,3,7),er(11,12,3),er(4,7,3),er(4,10,7),er(4,9,10),er(4,6,9),er(4,3,6),er(5,6,12),er(5,9,6),er(5,1,9),er(5,2,1),er(5,12,2),er(3,12,6),er(1,8,10),er(1,10,9),er(1,2,8),er(10,8,7)}local function es()local ck={}for d=1,#b9 do local bJ=b9[d]local et={x=(bJ.x1+bJ.x2)/2,y=(bJ.y1+bJ.y2)/2,z=(bJ.z1+bJ.z2)/2}local eu={x=(bJ.x1+bJ.x3)/2,y=(bJ.y1+bJ.y3)/2,z=(bJ.z1+bJ.z3)/2}local ev={x=(bJ.x2+bJ.x3)/2,y=(bJ.y2+bJ.y3)/2,z=(bJ.z2+bJ.z3)/2}local ew=bJ.c;if ek.colorsFractal then ew=ew%#ek.colors+1 end;ck[#ck+1]=ej(et.x,et.y,et.z,ev.x,ev.y,ev.z,eu.x,eu.y,eu.z,bJ.c)ck[#ck+1]=ej(bJ.x1,bJ.y1,bJ.z1,et.x,et.y,et.z,eu.x,eu.y,eu.z,ew)ck[#ck+1]=ej(et.x,et.y,et.z,bJ.x2,bJ.y2,bJ.z2,ev.x,ev.y,ev.z,ew)ck[#ck+1]=ej(eu.x,eu.y,eu.z,ev.x,ev.y,ev.z,bJ.x3,bJ.y3,bJ.z3,ew)end;b9=ck end;for d=1,ek.res-1 do es()end;local function ex(C,A,b2)local ey=math.sqrt(C*C+A*A+b2*b2)local ez=0.5/ey;return C*ez,A*ez,b2*ez end;for d=1,#b9 do local bJ=b9[d]bJ.x1,bJ.y1,bJ.z1=ex(bJ.x1,bJ.y1,bJ.z1)bJ.x2,bJ.y2,bJ.z2=ex(bJ.x2,bJ.y2,bJ.z2)bJ.x3,bJ.y3,bJ.z3=ex(bJ.x3,bJ.y3,bJ.z3)if not ek.colorsFractal then local aX=(bJ.y1+bJ.y2+bJ.y3)/3;if ek.colors then local ep=math.floor((-aX+0.5)*#ek.colors+1)bJ.c=ek.colors[ep]or bJ.c else if aX>=0 then bJ.c=ek.top or bJ.c else bJ.c=ek.bottom or bJ.c end end else bJ.c=ek.colors[bJ.c]end end;return b9 end;function ei:plane(ek)ek.color=ek.color or colors.lime;ek.size=ek.size or 1;ek.y=ek.y or 0;local eA={ej(-1*ek.size,ek.y,1*ek.size,1*ek.size,ek.y,-1*ek.size,-1*ek.size,ek.y,-1*ek.size,ek.color),ej(-1*ek.size,ek.y,1*ek.size,1*ek.size,ek.y,1*ek.size,1*ek.size,ek.y,-1*ek.size,ek.color)}return eA end;function ei:mountains(ek)ek.res=ek.res or 20;ek.randomOffset=ek.randomOffset or 0;ek.height=ek.height or 1;ek.randomHeight=ek.randomHeight or 0;ek.y=ek.y or 0;ek.scale=ek.scale or 100;ek.color=ek.color or colors.green;ek.snowColor=ek.snowColor or colors.white;local eB=3/ek.res*ek.height/(ek.randomHeight+1)local eC=3/ek.res*ek.height*(ek.randomHeight+1)local b9={}for d=0,ek.res do local eD=math.random(-ek.randomOffset*100,ek.randomOffset*100)/100;local eE=d+eD;local g=b0((eE-1)/ek.res*cU*2)*ek.scale;local bl=a_((eE-1)/ek.res*cU*2)*ek.scale;local i=b0((eE-0.5)/ek.res*cU*2)*ek.scale;local b5=a_((eE-0.5)/ek.res*cU*2)*ek.scale;local T=b0(eE/ek.res*cU*2)*ek.scale;local bm=a_(eE/ek.res*cU*2)*ek.scale;local eF=math.random(eB*100,eC*100)/100*ek.scale;local aV={x1=g,y1=ek.y,z1=bl,x2=T,y2=ek.y,z2=bm,x3=i,y3=ek.y+eF,z3=b5,c=ek.color,forceRender=true}b9[#b9+1]=aV;if ek.snow then local eG=0.93;local eH=ek.snowHeight or 0.5;local eI=1-eH*eC/(eF/ek.scale)eI=n(0,m(1,eI))if eI>0.2 then local eJ={x1=(g*eI+i*(1-eI))*eG,y1=ek.y+eF*(1-eI),z1=(bl*eI+b5*(1-eI))*eG,x2=(T*eI+i*(1-eI))*eG,y2=ek.y+eF*(1-eI),z2=(bm*eI+b5*(1-eI))*eG,x3=i*eG,y3=ek.y+eF,z3=b5*eG,c=ek.snowColor,forceRender=true}b9[#b9+1]=eJ end end end;return b9 end;return{newFrame=cW,loadModel=co,newBuffer=q,linear=f,models=ei}