local a=(...):match("(.-)[^%.]+$")local b=require(a.."betterblittle")local c=math.min;local d=math.max;local e=math.floor;local f=math.ceil;local function g(h,i,j,k)local l={x1=h,y1=i,x2=j,y2=k,width=j-h+1,height=k-i+1,screenBuffer={{}},blitWin=window.create(term.current(),h,i,j-h+1,k-i+1,false),backgroundColor=colors.lightBlue}function l:setBufferSize(m,n,o,p)self.x1=m;self.y1=n;self.x2=o;self.y2=p;self.width=o-m+1;self.height=p-n+1;self.blitWin.reposition(self.x1,self.y1,self.width,self.height)self:clear()end;function l:clear()local q=self.screenBuffer;q.c2={}q.depth={}local r=q.c2;local s=q.depth;local t=math.huge;local u=self.width;local v=self.backgroundColor;for w=1,self.height do r[w]={}s[w]={}local x=r[w]local y=s[w]for z=1,u do x[z]=v;y[z]=t end end end;function l:clearDepth()local q=self.screenBuffer;local s=q.depth;local t=-math.huge;local u=self.width;for w=1,self.height do local y=s[w]for z=1,u do y[z]=t end end end;function l:fastClear()local A=self.backgroundColor;local r=self.screenBuffer.c2;local u=self.width;for w=1,self.height do local x=r[w]for z=1,u do x[z]=A end end end;function l:setPixel(z,w,A)z=e(z+0.5)w=e(w+0.5)if z>=1 and z<=self.width then if w>=1 and w<=self.height then local q=self.screenBuffer;q.c2[w][z]=A end end end;function l:image(z,w,B,C,D)local q=self.screenBuffer;local u=self.width;local E=(e(z+0.5)-1)*2+(C or 0)local F=(e(w+0.5)-1)*3+(D or 0)local r=q.c2;for G,H in pairs(B)do local I=G+F;local x=r[I]if x then for J,K in pairs(H)do if K and K>0 then local L=J+E;if L>=1 and L<=u then x[L]=K end end end end end end;function l:loadLineNoInterp(h,i,j,k,A,M)local q=self.screenBuffer;local r=q.c2;local N=q.depth;local O=self.width;local P=self.height;local E=j-h;local F=k-i;if E~=0 then for z=d(f(c(h,j)),1),c(e(d(h,j)),O)do local Q=(z-h)/E;local w=e(i+Q*F+0.5)if w>0 and w<=P and M>=N[w][z]then r[w][z]=A;N[w][z]=M end end end;if F~=0 then for w=d(f(c(i,k)),1),c(e(d(i,k)),P)do local R=(w-i)/F;local z=e(h+R*E+0.5)if z>0 and z<=O and M>=N[w][z]then r[w][z]=A;N[w][z]=M end end end end;function l:loadLineInterp(h,i,j,k,A,S,T)local q=self.screenBuffer;local r=q.c2;local N=q.depth;local O=self.width;local P=self.height;h=h+0.5;j=j+0.5;i=i-0.5;k=k-0.5;local E=j-h;local F=k-i;local U=T-S;if E~=0 then for z=d(f(c(h,j)),1),c(e(d(h,j)),O)do local Q=(z-h)/E;local w=e(i+Q*F+0.5)local V=S+Q*U;if w>0 and w<=P and V>=N[w][z]then r[w][z]=A;N[w][z]=V end end end;if F~=0 then for w=d(f(c(i,k)),1),c(e(d(i,k)),P)do local R=(w-i)/F;local z=e(h+R*E+0.5)local V=S+R*U;if z>0 and z<=O and V>=N[w][z]then r[w][z]=A;N[w][z]=V end end end end;local W=colors.black;function l:drawTriangleNoInterp(h,i,j,k,X,Y,A,Z,s)if h<0 and j<0 and X<0 or i<1 and k<1 and Y<1 then return end;local O=self.width;if h>O and j>O and X>O then return end;local P=self.height;if i>P and k>P and Y>P then return end;if i>k then i,k=k,i;h,j=j,h end;if k>Y then Y,k=k,Y;X,j=j,X end;if i>k then i,k=k,i;h,j=j,h end;local q=self.screenBuffer;local e,f=e,f;local c,d=c,d;local _=c(d(1,f(i)),P)local a0=c(d(0,e(k)),P)local a1=c(d(1,e(Y)),P)local r=q.c2;local N=q.depth;local M=1/s;if i~=k and i~=Y then local a2=(j-h)/(k-i)local a3=(X-h)/(Y-i)for w=_,a0 do local F=w-i;local a4=h+F*a2;local a5=h+F*a3;if a5<a4 then a4,a5=a5,a4 end;local a6=e(a4+0.5)local a7=e(a5+0.5)if a6<1 then a6=1 end;if a7>O then a7=O end;local x=r[w]local y=N[w]for z=a6,a7 do if M>y[z]then y[z]=M;x[z]=A end end end end;if Y~=k and i~=Y then local a2=(j-X)/(k-Y)local a3=(h-X)/(i-Y)for w=a0+1,a1 do local F=w-Y;local a4=X+F*a2;local a5=X+F*a3;if a5<a4 then a4,a5=a5,a4 end;local a6=e(a4+0.5)local a7=e(a5+0.5)if a6<1 then a6=1 end;if a7>O then a7=O end;local x=r[w]local y=N[w]for z=a6,a7 do if M>y[z]then y[z]=M;x[z]=A end end end end;local Z=Z;if Z or self.triangleEdges then local a8=self.loadLineNoInterp;local A=Z or W;a8(self,h,i,j,k,A,M)a8(self,j,k,X,Y,A,M)a8(self,X,Y,h,i,A,M)end end;function l:drawTriangleInterp(h,i,j,k,X,Y,A,Z,a9,aa,ab,ac)if h<0 and j<0 and X<0 or i<1 and k<1 and Y<1 then return end;local O=self.width;if h>O and j>O and X>O then return end;local P=self.height;if i>P and k>P and Y>P then return end;if i>k then i,k=k,i;h,j=j,h;aa,ab=ab,aa end;if k>Y then Y,k=k,Y;X,j=j,X;ac,ab=ab,ac end;if i>k then i,k=k,i;h,j=j,h;aa,ab=ab,aa end;local q=self.screenBuffer;local e,f=e,f;local c,d=c,d;local _=c(d(1,f(i)),P)local a0=c(d(0,e(k)),P)local a1=c(d(1,e(Y)),P)local r=q.c2;local N=q.depth;local ad=1/ac;local T=1/ab;local S=1/aa;if i~=k and i~=Y then local ae=k-i;local af=Y-i;local a2=(j-h)/ae;local a3=(X-h)/af;local ag=T-S;local ah=ad-S;for w=_,a0 do local F=w-i;local a4=h+F*a2;local a5=h+F*a3;local ai=F/ae;local aj=F/af;local ak=S+ai*ag;local al=S+aj*ah;if a5<a4 then a4,a5=a5,a4;ak,al=al,ak end;local a6=e(a4+1.5)local a7=e(a5+0.5)if a6<1 then a6=1 end;if a7>O then a7=O end;a4=e(a4+0.5)a5=e(a5+1.5)local am=a5-a4;local x=r[w]local y=N[w]local an=al-ak;for z=a6,a7 do local Q=(z-a4)/am;local V=ak+Q*an;if V>y[z]then y[z]=V;x[z]=A end end end end;if Y~=k and i~=Y then local ao=k-Y;local ap=i-Y;local a2=(j-X)/ao;local a3=(h-X)/ap;local ag=T-ad;local ah=S-ad;for w=a0+1,a1 do local F=w-Y;local a4=X+F*a2;local a5=X+F*a3;local ai=F/ao;local aj=F/ap;local ak=ad+ai*ag;local al=ad+aj*ah;if a5<a4 then a4,a5=a5,a4;ak,al=al,ak end;local a6=e(a4+1.5)local a7=e(a5+0.5)if a6<1 then a6=1 end;if a7>O then a7=O end;a4=e(a4+0.5)a5=e(a5+1.5)local am=a5-a4;local x=r[w]local y=N[w]local an=al-ak;for z=a6,a7 do local Q=(z-a4)/am;local V=ak+Q*an;if V>y[z]then y[z]=V;x[z]=A end end end end;local Z=Z;if Z or self.triangleEdges then local a8=self.loadLineInterp;local A=Z or W;a8(self,h,i,j,k,A,S,T)a8(self,j,k,X,Y,A,T,ad)a8(self,X,Y,h,i,A,ad,S)end end;function l:drawBuffer()local aq=self.blitWin;b.drawBuffer(self.screenBuffer.c2,aq)aq.setVisible(true)aq.setVisible(false)end;function l:depthInterpolation(ar)self.drawTriangle=ar and self.drawTriangleInterp or self.drawTriangleNoInterp;self:clear()end;function l:useTriangleEdges(ar)self.triangleEdges=ar end;l:depthInterpolation(true)return l end;local function as(at,au,av,aw,ax)local ay=ax[1]local az=ax[2]local aA=ax[3]local aB=au and au-ay or 0;local aC=av and av-az or 0;local aD=aw and aw-aA or 0;for aE=1,#at do local aF=at[aE]local aG=aB+(aF[1]+aF[4]+aF[7])/3;local aH=aC+(aF[2]+aF[5]+aF[8])/3;local aI=aD+(aF[3]+aF[6]+aF[9])/3;aF[16]=aG*aG+aH*aH+aI*aI end end;local aJ=math.rad;local aK=math.sin;local aL=math.cos;local function aM(z,w,aN,aO,aP)local ab=aP*aN-aO*w;local w=aO*aN+aP*w;local aN=ab;return z,w,aN end;local function aQ(z,w,aN,aO,aP)local ab=aP*aN-aO*z;local z=aO*aN+aP*z;local aN=ab;return z,w,aN end;local function aR(z,w,aN,aO,aP)local k=aP*w-aO*z;local z=aO*w+aP*z;local w=k;return z,w end;local function aS(aT,aU,aV,aW)local aX,aY=0,1;local aZ,a_=0,1;local b0,b1=0,1;if aU==0 then aU=nil end;if aU then aX,aY=aK(aU),aL(aU)end;if aV==0 then aV=nil end;if aV then aZ,a_=aK(aV),aL(aV)end;if aW==0 then aW=nil end;if aW then b0,b1=aK(aW),aL(aW)end;local b2={}for b3,aF in pairs(aT)do local h,i,aa=aF[1],aF[2],aF[3]local j,k,ab=aF[4],aF[5],aF[6]local X,Y,ac=aF[7],aF[8],aF[9]if aV then h,i,aa=aQ(h,i,aa,aZ,a_)j,k,ab=aQ(j,k,ab,aZ,a_)X,Y,ac=aQ(X,Y,ac,aZ,a_)end;if aW then h,i=aR(h,i,aa,b0,b1)j,k=aR(j,k,ab,b0,b1)X,Y=aR(X,Y,ac,b0,b1)end;if aU then h,i,aa=aM(h,i,aa,aX,aY)j,k,ab=aM(j,k,ab,aX,aY)X,Y,ac=aM(X,Y,ac,aX,aY)end;b2[#b2+1]={h,i,aa,j,k,ab,X,Y,ac}b2[#b2][10]=aF[10]b2[#b2][11]=aF[11]b2[#b2][12]=aF[12]end;return b2 end;local b4={}function b4.invertTriangles(aT)if not aT or type(aT)~="table"then error("transforms.invertTriangles expected arg#1 to be a table (model)")end;for aE=1,#aT do local b5=aT[aE]aT[aE]={x1=b5.x1,y1=b5.y1,z1=b5.z1,x2=b5.x3,y2=b5.y3,z2=b5.z3,x3=b5.x2,y3=b5.y2,z3=b5.z2,c=b5.c,forceRender=b5.forceRender,outlineColor=b5.outlineColor}end;return aT end;function b4.setOutline(aT,b6)if not aT or type(aT)~="table"then error("transforms.invertTriangles expected arg#1 to be a table (model)")end;for aE=1,#aT do local b5=aT[aE]if type(b6)=="table"then b5.outlineColor=b6[b5.c]or b5.outlineColor else b5.outlineColor=b6 end end;return aT end;function b4.mapColor(aT,b6)if not aT or type(aT)~="table"then error("transforms.mapColor expected arg#1 to be a table (model)")end;for aE=1,#aT do local b5=aT[aE]if type(b6)=="table"then b5.c=b6[b5.c]or b5.c else b5.c=b6 end end;return aT end;function b4.center(aT)local b7,b8=math.huge,-math.huge;local _,a1=math.huge,-math.huge;local b9,ba=math.huge,-math.huge;for aE=1,#aT do local bb=aT[aE]b7,b8=c(b7,bb.x1),d(b8,bb.x1)b7,b8=c(b7,bb.x2),d(b8,bb.x2)b7,b8=c(b7,bb.x3),d(b8,bb.x3)_,a1=c(_,bb.y1),d(a1,bb.y1)_,a1=c(_,bb.y2),d(a1,bb.y2)_,a1=c(_,bb.y3),d(a1,bb.y3)b9,ba=c(b9,bb.z1),d(ba,bb.z1)b9,ba=c(b9,bb.z2),d(ba,bb.z2)b9,ba=c(b9,bb.z3),d(ba,bb.z3)end;local bc=-(b8+b7)*0.5;local bd=-(a1+_)*0.5;local be=-(ba+b9)*0.5;for aE=1,#aT do local bb=aT[aE]bb.x1=bb.x1+bc;bb.x2=bb.x2+bc;bb.x3=bb.x3+bc;bb.y1=bb.y1+bd;bb.y2=bb.y2+bd;bb.y3=bb.y3+bd;bb.z1=bb.z1+be;bb.z2=bb.z2+be;bb.z3=bb.z3+be end;return aT,bc,bd,be end;function b4.normalizeScale(aT)local bf=-math.huge;for aE=1,#aT do local bb=aT[aE]bf=d(bf,bb.x1)bf=d(bf,bb.x2)bf=d(bf,bb.x3)bf=d(bf,bb.y1)bf=d(bf,bb.y2)bf=d(bf,bb.y3)bf=d(bf,bb.z1)bf=d(bf,bb.z2)bf=d(bf,bb.z3)end;for aE=1,#aT do local bb=aT[aE]bb.x1=bb.x1/bf;bb.x2=bb.x2/bf;bb.x3=bb.x3/bf;bb.y1=bb.y1/bf;bb.y2=bb.y2/bf;bb.y3=bb.y3/bf;bb.z1=bb.z1/bf;bb.z2=bb.z2/bf;bb.z3=bb.z3/bf end;return aT end;function b4.normalizeScaleY(aT)local bf=-math.huge;for aE=1,#aT do local bb=aT[aE]bf=d(bf,bb.y1)bf=d(bf,bb.y2)bf=d(bf,bb.y3)end;for aE=1,#aT do local bb=aT[aE]bb.x1=bb.x1/bf;bb.x2=bb.x2/bf;bb.x3=bb.x3/bf;bb.y1=bb.y1/bf;bb.y2=bb.y2/bf;bb.y3=bb.y3/bf;bb.z1=bb.z1/bf;bb.z2=bb.z2/bf;bb.z3=bb.z3/bf end;return aT end;function b4.scale(aT,bg)for aE=1,#aT do local bb=aT[aE]bb.x1=bb.x1*bg;bb.x2=bb.x2*bg;bb.x3=bb.x3*bg;bb.y1=bb.y1*bg;bb.y2=bb.y2*bg;bb.y3=bb.y3*bg;bb.z1=bb.z1*bg;bb.z2=bb.z2*bg;bb.z3=bb.z3*bg end;return aT end;function b4.translate(aT,E,F,bh)for aE=1,#aT do local bb=aT[aE]bb.x1=bb.x1+(E or 0)bb.x2=bb.x2+(E or 0)bb.x3=bb.x3+(E or 0)bb.y1=bb.y1+(F or 0)bb.y2=bb.y2+(F or 0)bb.y3=bb.y3+(F or 0)bb.z1=bb.z1+(bh or 0)bb.z2=bb.z2+(bh or 0)bb.z3=bb.z3+(bh or 0)end;return aT end;function b4.rotate(aT,aU,aV,aW)local aX,aY=0,1;local aZ,a_=0,1;local b0,b1=0,1;if aU==0 then aU=nil end;if aU then aX,aY=aK(aU),aL(aU)end;if aV==0 then aV=nil end;if aV then aZ,a_=aK(aV),aL(aV)end;if aW==0 then aW=nil end;if aW then b0,b1=aK(aW),aL(aW)end;for aE=1,#aT do local aF=aT[aE]local h,i,aa=aF.x1,aF.y1,aF.z1;local j,k,ab=aF.x2,aF.y2,aF.z2;local X,Y,ac=aF.x3,aF.y3,aF.z3;if aV then h,i,aa=aQ(h,i,aa,aZ,a_)j,k,ab=aQ(j,k,ab,aZ,a_)X,Y,ac=aQ(X,Y,ac,aZ,a_)end;if aW then h,i=aR(h,i,aa,b0,b1)j,k=aR(j,k,ab,b0,b1)X,Y=aR(X,Y,ac,b0,b1)end;if aU then h,i,aa=aM(h,i,aa,aX,aY)j,k,ab=aM(j,k,ab,aX,aY)X,Y,ac=aM(X,Y,ac,aX,aY)end;aF.x1,aF.y1,aF.z1=h,i,aa;aF.x2,aF.y2,aF.z2=j,k,ab;aF.x3,aF.y3,aF.z3=X,Y,ac end;return aT end;function b4.alignBottom(aT)local _=math.huge;for aE=1,#aT do local bb=aT[aE]_=c(_,bb.y1)_=c(_,bb.y2)_=c(_,bb.y3)end;for aE=1,#aT do local bb=aT[aE]bb.y1=bb.y1-_;bb.y2=bb.y2-_;bb.y3=bb.y3-_ end;return aT end;function b4.decimate(aT,bi,bj)local bk={}local bl={}local function bm(z,w,aN)for aE=#bk,1,-1 do local bn=bk[aE]if bn[1]==z and bn[2]==w and bn[3]==aN then return aE end end end;for aE=1,#aT do local bb=aT[aE]local bo=bm(bb.x1,bb.y1,bb.z1)if not bo then bk[#bk+1]={bb.x1,bb.y1,bb.z1}bo=#bk end;local bp=bm(bb.x2,bb.y2,bb.z2)if not bp then bk[#bk+1]={bb.x2,bb.y2,bb.z2}bp=#bk end;local bq=bm(bb.x3,bb.y3,bb.z3)if not bq then bk[#bk+1]={bb.x3,bb.y3,bb.z3}bq=#bk end;local b5={bo,bp,bq,bb.c,bb.forceRender}bl[#bl+1]=b5 end;local function br(bs,bt)local E=bs[1]-bt[1]local F=bs[2]-bt[2]local bh=bs[3]-bt[3]return(E*E+F*F+bh*bh)^0.5 end;local bu={}for aE=1,#bl do local b5=bl[aE]local bv=br(bk[b5[1]],bk[b5[2]])local bw=br(bk[b5[2]],bk[b5[3]])local bx=br(bk[b5[1]],bk[b5[3]])bu[#bu+1]={length=bv,vA=b5[1],vB=b5[2]}bu[#bu+1]={length=bw,vA=b5[2],vB=b5[3]}bu[#bu+1]={length=bx,vA=b5[1],vB=b5[3]}end;local function by(bz,bA)local bB=bk[bz]local bC=bk[bA]local bD={(bB[1]+bC[1])*0.5,(bB[2]+bC[2])*0.5,(bB[3]+bC[3])*0.5}bk[#bk+1]=bD;local bE=#bk;for aE=#bl,1,-1 do local bF=bl[aE]if bF[1]==bz or bF[1]==bA or bF[2]==bz or bF[2]==bA or bF[3]==bz or bF[3]==bA then if bF[1]==bz or bF[1]==bA then bF[1]=bE end;if bF[2]==bz or bF[2]==bA then bF[2]=bE end;if bF[3]==bz or bF[3]==bA then bF[3]=bE end;if bF[1]==bF[2]or bF[2]==bF[3]or bF[1]==bF[3]then table.remove(bl,aE)end end end;return bE end;local bG=bi;if bj~="polys"then bG=#aT*bi end;while#bl>bG do local bH=math.huge;local bI;for aE=1,#bu do local bJ=bu[aE]if bJ.length<bH then bH=bJ.length;bI=aE end end;local bK=bu[bI]local bE=by(bK.vA,bK.vB)for aE=#bu,1,-1 do local bJ=bu[aE]local bL=bJ.vA==bK.vA or bJ.vA==bK.vB;local bM=bJ.vB==bK.vA or bJ.vB==bK.vB;if bL and bM then table.remove(bu,aE)elseif bL then bJ.vA=bE elseif bM then bJ.vB=bE end end end;local bN={}for aE=1,#bl do local b5=bl[aE]local bs=bk[b5[1]]local bt=bk[b5[2]]local bO=bk[b5[3]]bN[#bN+1]={x1=bs[1],y1=bs[2],z1=bs[3],x2=bt[1],y2=bt[2],z2=bt[3],x3=bO[1],y3=bO[2],z3=bO[3],c=b5[4],forceRender=b5[5]}end;for bP,bQ in pairs(b4)do bN[bP]=bQ end;return bN end;local bR,bS;function b4.toLoD(aT,bT)bT=bT or{}local bU={minQuality=bT.minQuality or 0.1,variantCount=bT.variantCount or 4,qualityHalvingDistance=bT.qualityHalvingDistance or 5,quickInitWorseRuntime=bT.quickInitWorseRuntime or false}local bV,bW=bS(aT)local bX={{quality=1,collapsedModel=bV,size=bW}}local bY=aT;local bZ=#bY;for aE=1,bU.variantCount do local bi=(1-bU.minQuality)*(1-aE/bU.variantCount)+bU.minQuality;local b_=math.floor(bZ*bi+0.5)local c0=bY:decimate(b_,"polys")local bV,bW=bS(c0)bY=c0;local c1={quality=bi,collapsedModel=bV,size=bW}bX[#bX+1]=c1 end;local function c2(c3)local c4={}for aE=1,#c3 do local c1=c3[aE]local aT=c1.collapsedModel;local c5={}for c6=1,#aT do local bb=aT[c6]local c7={bb[1],bb[2],bb[3],bb[4],bb[5],bb[6],bb[7],bb[8],bb[9],bb[10],bb[11],bb[12]}c5[c6]=c7 end;local c8={quality=c1.quality,size=c1.size,collapsedModel=c5}c4[aE]=c8 end;return c4 end;local c9={}function bU:initObject(ca)local cb;if bU.quickInitWorseRuntime then cb=bX else cb=c2(bX)end;c9[ca]=cb;ca[7]=cb[1].collapsedModel;ca[8]=cb[1].size;ca[9]=bU end;function bU:update(ca,ax)local cb=c9[ca]if cb then local E=ax[1]-ca[1]local F=ax[2]-ca[2]local bh=ax[3]-ca[3]local a9=(E*E+F*F+bh*bh)^0.5;local cc=math.min(1,math.max(bU.minQuality,1/(a9/bU.qualityHalvingDistance)))local cd=bU.variantCount+1-bU.variantCount*(cc-bU.minQuality)/(1-bU.minQuality)local ce=math.floor(cd+0.5)local c1=cb[ce]ca[7]=c1.collapsedModel;ca[8]=c1.size end end;return bU end;local cf=math.sqrt;function bS(aT)local cg={}local ch=0;for aE=1,#aT do local aF=aT[aE]cg[#cg+1]={}cg[#cg][1]=aF.x1;cg[#cg][2]=aF.y1;cg[#cg][3]=aF.z1;cg[#cg][4]=aF.x2;cg[#cg][5]=aF.y2;cg[#cg][6]=aF.z2;cg[#cg][7]=aF.x3;cg[#cg][8]=aF.y3;cg[#cg][9]=aF.z3;cg[#cg][10]=aF.forceRender;cg[#cg][11]=aF.c;cg[#cg][12]=aF.outlineColor;local ci=cf(aF.x1*aF.x1+aF.y1*aF.y1+aF.z1*aF.z1)local cj=cf(aF.x2*aF.x2+aF.y2*aF.y2+aF.z2*aF.z2)local ck=cf(aF.x3*aF.x3+aF.y3*aF.y3+aF.z3*aF.z3)if ci>ch then ch=ci end;if cj>ch then ch=cj end;if ck>ch then ch=ck end end;return cg,ch end;function bR(cl)local cm=fs.open(cl,"r")if not cm then error("Could not find model for an object at path: "..cl)end;local cn=cm.readAll()cm.close()if not cn then error("Failed to parse model for an object at path: "..cl)end;local aT=textutils.unserialise(cn)for bP,bQ in pairs(b4)do aT[bP]=bQ end;return aT end;local co=math.pi;local aK=math.sin;local aL=math.cos;local cp=math.tan;local cf=math.sqrt;local function cq(h,i,j,k)local u,cr=term.getSize()if h and j then u=j-h+1 end;if i and k then cr=k-i+1 end;local h=h or 1;local i=i or 1;local j=j or u-h+1;local k=k or cr-i+1;local cs={camera={0.000001,0.000001,0.000001,nil,0,0},buffer=g(h,i,j,k),x1=h,y1=i,x2=j,y2=k,width=u,height=cr}cs.FoV=90;cs.camera[7]=aJ(cs.FoV)cs.camera[8]=2*math.atan(math.tan(aJ(cs.FoV)*0.5)/(cs.width/cs.height/1.5))cs.t=cp(aJ(cs.FoV/2))*2*0.0001;local ct,cu,cv,cw;function cs:setBackgroundColor(A)local cx=self.buffer;cx.backgroundColor=A;cx:fastClear()end;local function cy()ct=e(cs.width*0.5)+1;cu=e(cs.height*0.5)cv=0.0001*cs.width/cs.t;cw=-0.0001*cs.width/(cs.t*cs.height)*cs.height end;function cs:setSize(h,i,j,k)self.x1=h;self.y1=i;self.x2=j;self.y2=k;self.width=(j-h+1)*2;self.height=(k-i+1)*3;self.buffer:setBufferSize(h,i,h+self.width-1,i+self.height-1)cy()end;function cs:depthInterpolation(ar)self.interpolateDepth=ar;self.buffer:depthInterpolation(ar)end;function cs:map3dTo2d(z,w,aN)local ax=self.camera;local cz=aK(ax[4]or 0)local cA=aL(ax[4]or 0)local cB=aK(-ax[5])local cC=aL(-ax[5])local cD=aK(ax[6])local cE=aL(ax[6])local cF=z-ax[1]local cG=w-ax[2]local cH=aN-ax[3]local cI=cC*cF-cB*cH;cH=cB*cF+cC*cH;cF=cI;local cJ=cE*cG-cD*cF;cF=cD*cG+cE*cF;cG=cJ;if cz~=0 then local cK=cz*cH-cA*cG;cG=cA*cH+cz*cG;cH=cK end;local cL=cH/cF*cv+ct;local cM=cG/cF*cw+cu;return cL,cM,cF>=0.0001 end;function cs:drawObject(ca,ax,cN)local cO=ca[1]local cP=ca[2]local cQ=ca[3]local cz=cN[1]local cA=cN[2]local cB=cN[3]local cC=cN[4]local cD=cN[5]local cE=cN[6]local cR=cO and cO-ax[1]or 0;local cS=cP and cP-ax[2]or 0;local cT=cQ and cQ-ax[3]or 0;local bU=ca[9]if bU then bU:update(ca,ax)end;local aT=ca[7]if#aT<=0 then return end;local bW=ca[8]local cF=cR;local cG=cS;local cH=cT;local cI=cC*cF-cB*cH;local cH=cB*cF+cC*cH;local cF=cI;local cJ=cE*cG-cD*cF;local cF=cD*cG+cE*cF;cG=cJ;if cF<-bW then return true end;local cU=0.5*ax[7]local cV=aK(cU)local cW=aL(cU)if(cF+bW)*cV+(cH+bW)*cW<0 then return true end;if(cF+bW)*cV-(cH-bW)*cW<0 then return true end;local cX=0.5*ax[8]local cV=aK(cX)local cY=aL(cX)if(cF+bW)*cV+(cG+bW)*cY<0 then return true end;if(cF+bW)*cV-(cG-bW)*cY<0 then return true end;local aU=ca[4]local aV=ca[5]local aW=ca[6]if aU and aU~=0 or aV and aV~=0 or aW and aW~=0 then aT=aS(aT,aU,aV,aW)end;as(aT,cO,cP,cQ,ax)local cZ=cR*cR+cS*cS+cT*cT<bW*bW*4;local ct=ct;local cu=cu;local cv=cv;local cw=cw;local cz=cz;local cA=cA;local cB=cB;local cC=cC;local cD=cD;local cE=cE;local cR=cR;local cS=cS;local cT=cT;local function c_(cF,cG,cH)local cI=cC*cF-cB*cH;cH=cB*cF+cC*cH;cF=cI;local cJ=cE*cG-cD*cF;cF=cD*cG+cE*cF;cG=cJ;local cL=cH/cF*cv+ct;local cM=cG/cF*cw+cu;return cL,cM,cF end;if cz~=0 then function c_(cF,cG,cH)local cI=cC*cF-cB*cH;cH=cB*cF+cC*cH;cF=cI;local cJ=cE*cG-cD*cF;cF=cD*cG+cE*cF;cG=cJ;local cK=cz*cH-cA*cG;cG=cA*cH+cz*cG;cH=cK;local cL=cH/cF*cv+ct;local cM=cG/cF*cw+cu;return cL,cM,cF end end;local d0=aT;local cx=self.buffer;for aE=1,#d0 do local aF=d0[aE]local s=aF[16]local h,i,d1=c_(aF[1]+cR,aF[2]+cS,aF[3]+cT)if d1>0.00010000001 then local j,k,cI=c_(aF[4]+cR,aF[5]+cS,aF[6]+cT)if cI>0.00010000001 then local X,Y,d2=c_(aF[7]+cR,aF[8]+cS,aF[9]+cT)if d2>0.00010000001 then if aF[10]or(j-h)*(Y-k)-(k-i)*(X-j)<0 then cx:drawTriangle(h,i,j,k,X,Y,aF[11],aF[12],s,d1,cI,d2)end elseif cZ then local function d3(z,w,aN)local cF=z+cR;local cG=w+cS;local cH=aN+cT;local cI=cC*cF-cB*cH;cH=cB*cF+cC*cH;cF=cI;local cJ=cE*cG-cD*cF;cF=cD*cG+cE*cF;cG=cJ;if cz~=0 then local cK=cz*cH-cA*cG;cG=cA*cH+cz*cG;cH=cK end;local cL=cH/cF*cv+ct;local cM=cG/cF*cw+cu;return cL,cM,cF,cG,cH end;local h,i,d1,d4,d5=d3(aF[1],aF[2],aF[3])local j,k,cI,cJ,cK=d3(aF[4],aF[5],aF[6])local X,Y,d2,d6,d7=d3(aF[7],aF[8],aF[9])local d8=math.abs;local d9=d8(d2-0.0001)local da=d8(d1-0.0001)local db=da+d9;local dc=(d7*da+d5*d9)/db;local dd=(d6*da+d4*d9)/db;local ct,cv,cu,cw=ct,cv,cu,cw;local de=dc*10000*cv+ct;local df=dd*10000*cw+cu;if aF[10]or(j-h)*(df-k)-(k-i)*(de-j)<0 then cx:drawTriangle(h,i,j,k,de,df,aF[11],aF[12],s,d1,cI,0.0001)local dg=d8(cI-0.0001)local db=dg+d9;local dc=(cK*d9+d7*dg)/db;local dd=(cJ*d9+d6*dg)/db;local dh=dc*10000*cv+ct;local di=dd*10000*cw+cu;cx:drawTriangle(dh,di,j,k,de,df,aF[11],aF[12],s,0.0001,cI,0.0001)end end elseif cZ then local function d3(z,w,aN)local cF=z+cR;local cG=w+cS;local cH=aN+cT;local cI=cC*cF-cB*cH;cH=cB*cF+cC*cH;cF=cI;local cJ=cE*cG-cD*cF;cF=cD*cG+cE*cF;cG=cJ;if cz~=0 then local cK=cz*cH-cA*cG;cG=cA*cH+cz*cG;cH=cK end;local cL=cH/cF*cv+ct;local cM=cG/cF*cw+cu;return cL,cM,cF,cG,cH end;local h,i,d1,d4,d5=d3(aF[1],aF[2],aF[3])local j,k,cI,cJ,cK=d3(aF[4],aF[5],aF[6])local X,Y,d2,d6,d7=d3(aF[7],aF[8],aF[9])local d8=math.abs;if d2>0.00010000001 then local dg=d8(cI-0.0001)local da=d8(d1-0.0001)local db=da+dg;local dc=(cK*da+d5*dg)/db;local dd=(cJ*da+d4*dg)/db;local ct,cv,cu,cw=ct,cv,cu,cw;local de=dc*10000*cv+ct;local df=dd*10000*cw+cu;if aF[10]or(de-h)*(Y-df)-(df-i)*(X-de)<0 then cx:drawTriangle(h,i,de,df,X,Y,aF[11],aF[12],s,d1,0.0001,d2)local d9=d8(d2-0.0001)local db=dg+d9;local dc=(cK*d9+d7*dg)/db;local dd=(cJ*d9+d6*dg)/db;local dh=dc*10000*cv+ct;local di=dd*10000*cw+cu;cx:drawTriangle(dh,di,de,df,X,Y,aF[11],aF[12],s,0.0001,0.0001,d2)end else local da=d8(d1-0.0001)local dg=d8(cI-0.0001)local d9=d8(d2-0.0001)local dj=da+dg;local dk=da+d9;local dc=(d5*dg+cK*da)/dj;local dd=(d4*dg+cJ*da)/dj;local ct,cv,cu,cw=ct,cv,cu,cw;local de=dc*10000*cv+ct;local df=dd*10000*cw+cu;local dl=(d5*d9+d7*da)/dk;local dm=(d4*d9+d6*da)/dk;local dh=dl*10000*cv+ct;local di=dm*10000*cw+cu;if aF[10]or(de-h)*(di-df)-(df-i)*(dh-de)<0 then cx:drawTriangle(h,i,de,df,dh,di,aF[11],aF[12],s,d1,0.0001,0.0001)end end end elseif cZ then local function d3(z,w,aN)local cF=z+cR;local cG=w+cS;local cH=aN+cT;local cI=cC*cF-cB*cH;cH=cB*cF+cC*cH;cF=cI;local cJ=cE*cG-cD*cF;cF=cD*cG+cE*cF;cG=cJ;if cz~=0 then local cK=cz*cH-cA*cG;cG=cA*cH+cz*cG;cH=cK end;local cL=cH/cF*cv+ct;local cM=cG/cF*cw+cu;return cL,cM,cF,cG,cH end;local h,i,d1,d4,d5=d3(aF[1],aF[2],aF[3])local j,k,cI,cJ,cK=d3(aF[4],aF[5],aF[6])local X,Y,d2,d6,d7=d3(aF[7],aF[8],aF[9])local d8=math.abs;if cI>0.00010000001 then if d2>0.00010000001 then local da=d8(d1-0.0001)local dg=d8(cI-0.0001)local db=da+dg;local dc=(d5*dg+cK*da)/db;local dd=(d4*dg+cJ*da)/db;local ct,cv,cu,cw=ct,cv,cu,cw;local de=dc*10000*cv+ct;local df=dd*10000*cw+cu;if aF[10]or(j-de)*(Y-k)-(k-df)*(X-j)<0 then cx:drawTriangle(de,df,j,k,X,Y,aF[11],aF[12],s,0.0001,cI,d2)local d9=d8(d2-0.0001)local db=da+d9;local dc=(d5*d9+d7*da)/db;local dd=(d4*d9+d6*da)/db;local dh=dc*10000*cv+ct;local di=dd*10000*cw+cu;cx:drawTriangle(de,df,dh,di,X,Y,aF[11],aF[12],s,0.0001,0.0001,d2)end else local da=d8(d1-0.0001)local dg=d8(cI-0.0001)local d9=d8(d2-0.0001)local dj=dg+da;local dk=dg+d9;local dc=(d5*dg+cK*da)/dj;local dd=(d4*dg+cJ*da)/dj;local ct,cv,cu,cw=ct,cv,cu,cw;local de=dc*10000*cv+ct;local df=dd*10000*cw+cu;local dl=(cK*d9+d7*dg)/dk;local dm=(cJ*d9+d6*dg)/dk;local dh=dl*10000*cv+ct;local di=dm*10000*cw+cu;if aF[10]or(j-de)*(di-k)-(k-df)*(dh-j)<0 then cx:drawTriangle(de,df,j,k,dh,di,aF[11],aF[12],s,0.0001,cI,0.0001)end end else if d2>0.00010000001 then local da=d8(d1-0.0001)local dg=d8(cI-0.0001)local d9=d8(d2-0.0001)local dj=d9+da;local dk=d9+dg;local dc=(d5*d9+d7*da)/dj;local dd=(d4*d9+d6*da)/dj;local ct,cv,cu,cw=ct,cv,cu,cw;local de=dc*10000*cv+ct;local df=dd*10000*cw+cu;local dl=(cK*d9+d7*dg)/dk;local dm=(cJ*d9+d6*dg)/dk;local dh=dl*10000*cv+ct;local di=dm*10000*cw+cu;if aF[10]or(dh-de)*(Y-di)-(di-df)*(X-dh)<0 then cx:drawTriangle(de,df,dh,di,X,Y,aF[11],aF[12],s,0.0001,0.0001,d2)end end end end end end;function cs:drawObjects(dn)self.buffer:clearDepth()local ax=self.camera;local cN={aK(ax[4]or 0),aL(ax[4]or 0),aK(-ax[5]),aL(-ax[5]),aK(ax[6]),aL(ax[6])}local dn=dn;for aE=1,#dn do self:drawObject(dn[aE],ax,cN)end end;function cs:drawBuffer()local cx=self.buffer;cx:drawBuffer()cx:fastClear()end;function cs:setCamera(dp,dq,dr,aU,aV,aW)local aJ=math.rad;if type(dp)=="table"then local ax=dp;self.camera={ax.x or self.camera[1]or 0,ax.y or self.camera[2]or 0,ax.z or self.camera[3]or 0,ax.rotX and aJ(ax.rotX+90)or self.camera[4]or 0,ax.rotY and aJ(ax.rotY)or self.camera[5]or 0,ax.rotZ and aJ(ax.rotZ)or self.camera[6]or 0,self.camera[7],self.camera[8]}else self.camera={dp or self.camera[1]or 0,dq or self.camera[2]or 0,dr or self.camera[3]or 0,aU and aJ(aU+90)or self.camera[4]or 0,aV and aJ(aV)or self.camera[5]or 0,aW and aJ(aW)or self.camera[6]or 0,self.camera[7],self.camera[8]}end;if self.camera[4]==math.pi*0.5 then self.camera[4]=nil end end;function cs:setFoV(cU)self.FoV=cU or 90;self.t=cp(aJ(self.FoV/2))*2*0.0001;cy()self.camera[7]=aJ(self.FoV)self.camera[8]=2*math.atan(math.tan(aJ(self.FoV)*0.5)/(self.width/self.height/1.5))end;function cs:setWireFrame(ar)self.buffer:useTriangleEdges(ar)end;function cs:getObjectIndexTrace(dn,z,w)local function ds(h,i,j,k,X,Y)return(h-X)*(k-Y)-(j-X)*(i-Y)end;local function dt(du,dv,h,i,j,k,X,Y,dw,dx,dy,dz)local dA=ds(du,dv,h,i,j,k)<0;local dB=ds(du,dv,j,k,X,Y)<0;local dC=ds(du,dv,X,Y,h,i)<0;return dA==dB and dB==dC end;local w=w-1;local dD=self.x1;local dE=self.y1;local dF=self.x2;local dG=self.y2;z=z*2;w=w*3+1;local ax=self.camera;local cN={aK(ax[4]or 0),aL(ax[4]or 0),aK(-ax[5]),aL(-ax[5]),aK(ax[6]),aL(ax[6])}local cz=cN[1]local cA=cN[2]local cB=cN[3]local cC=cN[4]local cD=cN[5]local cE=cN[6]local dH={}for aE=1,#dn do local ca=dn[aE]local aT=ca[7]local aU=ca[4]local aV=ca[5]local aW=ca[6]if aU and aU~=0 or aV and aV~=0 or aW and aW~=0 then aT=aS(aT,aU,aV,aW)end;local cO=ca[1]local cP=ca[2]local cQ=ca[3]as(aT,cO,cP,cQ,ax)local ct=ct;local cu=cu;local cv=cv;local cw=cw;local cz=cz;local cA=cA;local cB=cB;local cC=cC;local cD=cD;local cE=cE;local cR=cO-ax[1]local cS=cP-ax[2]local cT=cQ-ax[3]local function c_(z,w,aN)local cF=z+cR;local cG=w+cS;local cH=aN+cT;local cI=cC*cF-cB*cH;cH=cB*cF+cC*cH;cF=cI;local cJ=cE*cG-cD*cF;cF=cD*cG+cE*cF;cG=cJ;if cz~=0 then local cK=cz*cH-cA*cG;cG=cA*cH+cz*cG;cH=cK end;local cL=cH/cF*cv+ct;local cM=cG/cF*cw+cu;return cL,cM,cF>0 end;for c6=1,#aT do local aF=aT[c6]local h,i,dI=c_(aF[1],aF[2],aF[3])if dI then local j,k,dJ=c_(aF[4],aF[5],aF[6])if dJ then local X,Y,dK=c_(aF[7],aF[8],aF[9])if dK then if aF[10]or(j-h)*(Y-k)-(k-i)*(X-j)<0 then local aG=cR+(aF[1]+aF[4]+aF[7])/3;local aH=cS+(aF[2]+aF[5]+aF[8])/3;local aI=cT+(aF[3]+aF[6]+aF[9])/3;local s=aG*aG+aH*aH+aI*aI;if dt(z,w,h,i,j,k,X,Y,(dF-1)*2+1,(dE-1)*3+1,dF*2,(dG+1)*3)then dH[#dH+1]={objectIndex=aE,polygonIndex=c6,depth=s}end end end end end end end;if#dH<=0 then return elseif#dH==1 then return dH[1].objectIndex,dH[1].polygonIndex,dH[1].depth end;local dL=-1;local dM=math.huge;for aE=1,#dH do local dN=dH[aE]if dN.depth<dM then dM=dN.depth;dL=aE end end;local dN=dH[dL]return dN.objectIndex,dN.polygonIndex,dN.depth end;function cs:newObject(aT,z,w,aN,aU,aV,aW)local bV=nil;local bW=nil;if type(aT)=="table"then if aT.initObject then else bV,bW=bS(aT)end else local dO=bR(aT)bV,bW=bS(dO)end;local ca={z,w,aN,aU,aV,aW,bV,bW}ca.frame=self;function ca:setPos(dP,dQ,dR)self[1]=dP or self[1]self[2]=dQ or self[2]self[3]=dR or self[3]end;function ca:setRot(dS,dT,dU)self[4]=dS or self[4]self[5]=dT or self[5]self[6]=dU or self[6]end;function ca:setModel(dV)if type(dV)=="table"then bV,bW=bS(dV)self[7]=bV;self[8]=bW else local dO=bR(dV)bV,bW=bS(dO)self[7]=bV;self[8]=bW end end;if type(aT)=="table"then if aT.initObject then aT:initObject(ca)end end;return ca end;cs:depthInterpolation(true)cs.width=(cs.x2-cs.x1+1)*2;cs.height=(cs.y2-cs.y1+1)*3;cs.buffer:setBufferSize(cs.x1,cs.y1,cs.x1+cs.width-1,cs.y1+cs.height-1)cy()return cs end;local dW={}local function dX(h,i,aa,j,k,ab,X,Y,ac,A)local bb={x1=h,y1=i,z1=aa,x2=j,y2=k,z2=ab,x3=X,y3=Y,z3=ac,c=A}return bb end;function dW:cube(dY)dY.color=dY.color or colors.red;local dZ={dX(-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,dY.bottom or dY.color),dX(-.5,-.5,-.5,.5,-.5,-.5,.5,-.5,.5,dY.bottom2 or dY.bottom or dY.color),dX(-.5,.5,-.5,-.5,.5,.5,.5,.5,.5,dY.top or dY.color),dX(-.5,.5,-.5,.5,.5,.5,.5,.5,-.5,dY.top or dY.color),dX(-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,dY.side or dY.color),dX(-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,dY.side2 or dY.side or dY.color),dX(.5,-.5,-.5,.5,.5,.5,.5,-.5,.5,dY.side or dY.color),dX(.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,dY.side2 or dY.side or dY.color),dX(-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,dY.side or dY.color),dX(-.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5,dY.side2 or dY.side or dY.color),dX(-.5,-.5,.5,.5,-.5,.5,-.5,.5,.5,dY.side or dY.color),dX(.5,-.5,.5,.5,.5,.5,-.5,.5,.5,dY.side2 or dY.side or dY.color)}for bP,bQ in pairs(b4)do dZ[bP]=bQ end;return dZ end;function dW:sphere(dY)dY.res=dY.res or 32;dY.color=dY.color or colors.red;local aT={}local d_={}for aE=0,dY.res do local w=0.5*aL(aE/dY.res*co)local e0={}for c6=0,dY.res do local e1=0.5*cf(1-w*2*w*2)local z=aL(c6/dY.res*co*2)*e1;local aN=aK(c6/dY.res*co*2)*e1;local j=aL((c6+1)/dY.res*co*2)*e1;local ab=aK((c6+1)/dY.res*co*2)*e1;if d_[c6]then aT[#aT+1]={x1=d_[(c6+1)%dY.res].x,y1=d_[(c6+1)%dY.res].y,z1=d_[(c6+1)%dY.res].z,x2=z,y2=w,z2=aN,x3=d_[c6].x,y3=d_[c6].y,z3=d_[c6].z,c=dY.color}aT[#aT+1]={x1=j,y1=w,z1=ab,x2=z,y2=w,z2=aN,x3=d_[(c6+1)%dY.res].x,y3=d_[(c6+1)%dY.res].y,z3=d_[(c6+1)%dY.res].z,c=dY.color2 or dY.color}end;e0[c6]={x=z,y=w,z=aN}end;d_=e0 end;if dY.colors or dY.top or dY.bottom then for aE=1,#aT do local bb=aT[aE]local aH=(bb.y1+bb.y2+bb.y3)/3;if dY.colors then local e2=e((-aH+0.5)*#dY.colors+1)bb.c=dY.colors[e2]or bb.c else if aH>=0 then bb.c=dY.top or bb.c else bb.c=dY.bottom or bb.c end end end end;for bP,bQ in pairs(b4)do aT[bP]=bQ end;return aT end;function dW:icosphere(dY)dY.res=dY.res or 1;local e3=(1+cf(5))/2;local e4={{e3,1,0},{e3,-1,0},{-e3,-1,0},{-e3,1,0},{1,0,e3},{-1,0,e3},{-1,0,-e3},{1,0,-e3},{0,e3,1},{0,e3,-1},{0,-e3,-1},{0,-e3,1}}local function e5(bo,bp,bq)return dX(e4[bo][1],e4[bo][2],e4[bo][3],e4[bp][1],e4[bp][2],e4[bp][3],e4[bq][1],e4[bq][2],e4[bq][3],dY.colors and 1 or dY.color)end;local aT={e5(11,2,12),e5(11,8,2),e5(11,7,8),e5(11,3,7),e5(11,12,3),e5(4,7,3),e5(4,10,7),e5(4,9,10),e5(4,6,9),e5(4,3,6),e5(5,6,12),e5(5,9,6),e5(5,1,9),e5(5,2,1),e5(5,12,2),e5(3,12,6),e5(1,8,10),e5(1,10,9),e5(1,2,8),e5(10,8,7)}local function e6()local bN={}for aE=1,#aT do local bb=aT[aE]local e7={x=(bb.x1+bb.x2)/2,y=(bb.y1+bb.y2)/2,z=(bb.z1+bb.z2)/2}local e8={x=(bb.x1+bb.x3)/2,y=(bb.y1+bb.y3)/2,z=(bb.z1+bb.z3)/2}local e9={x=(bb.x2+bb.x3)/2,y=(bb.y2+bb.y3)/2,z=(bb.z2+bb.z3)/2}local ea=bb.c;if dY.colorsFractal then ea=ea%#dY.colors+1 end;bN[#bN+1]=dX(e7.x,e7.y,e7.z,e9.x,e9.y,e9.z,e8.x,e8.y,e8.z,bb.c)bN[#bN+1]=dX(bb.x1,bb.y1,bb.z1,e7.x,e7.y,e7.z,e8.x,e8.y,e8.z,ea)bN[#bN+1]=dX(e7.x,e7.y,e7.z,bb.x2,bb.y2,bb.z2,e9.x,e9.y,e9.z,ea)bN[#bN+1]=dX(e8.x,e8.y,e8.z,e9.x,e9.y,e9.z,bb.x3,bb.y3,bb.z3,ea)end;aT=bN end;for aE=1,dY.res-1 do e6()end;local function eb(z,w,aN)local ec=math.sqrt(z*z+w*w+aN*aN)local ed=0.5/ec;return z*ed,w*ed,aN*ed end;for aE=1,#aT do local bb=aT[aE]bb.x1,bb.y1,bb.z1=eb(bb.x1,bb.y1,bb.z1)bb.x2,bb.y2,bb.z2=eb(bb.x2,bb.y2,bb.z2)bb.x3,bb.y3,bb.z3=eb(bb.x3,bb.y3,bb.z3)if not dY.colorsFractal then local aH=(bb.y1+bb.y2+bb.y3)/3;if dY.colors then local e2=math.floor((-aH+0.5)*#dY.colors+1)bb.c=dY.colors[e2]or bb.c else if aH>=0 then bb.c=dY.top or bb.c else bb.c=dY.bottom or bb.c end end else bb.c=dY.colors[bb.c]end end;for bP,bQ in pairs(b4)do aT[bP]=bQ end;return aT end;function dW:plane(dY)dY.color=dY.color or colors.lime;dY.size=dY.size or 1;dY.y=dY.y or 0;local ee={dX(-1*dY.size,dY.y,1*dY.size,1*dY.size,dY.y,-1*dY.size,-1*dY.size,dY.y,-1*dY.size,dY.color),dX(-1*dY.size,dY.y,1*dY.size,1*dY.size,dY.y,1*dY.size,1*dY.size,dY.y,-1*dY.size,dY.color)}for bP,bQ in pairs(b4)do ee[bP]=bQ end;return ee end;function dW:mountains(dY)dY.res=dY.res or 20;dY.randomOffset=dY.randomOffset or 0;dY.height=dY.height or 1;dY.randomHeight=dY.randomHeight or 0;dY.y=dY.y or 0;dY.scale=dY.scale or 100;dY.color=dY.color or colors.green;dY.snowColor=dY.snowColor or colors.white;local ef=3/dY.res*dY.height/(dY.randomHeight+1)local eg=3/dY.res*dY.height*(dY.randomHeight+1)local aT={}for aE=0,dY.res do local eh=math.random(-dY.randomOffset*100,dY.randomOffset*100)/100;local ei=aE+eh;local h=aL((ei-1)/dY.res*co*2)*dY.scale;local aa=aK((ei-1)/dY.res*co*2)*dY.scale;local j=aL((ei-0.5)/dY.res*co*2)*dY.scale;local ab=aK((ei-0.5)/dY.res*co*2)*dY.scale;local X=aL(ei/dY.res*co*2)*dY.scale;local ac=aK(ei/dY.res*co*2)*dY.scale;local ej=math.random(ef*100,eg*100)/100*dY.scale;local aF={x1=h,y1=dY.y,z1=aa,x2=X,y2=dY.y,z2=ac,x3=j,y3=dY.y+ej,z3=ab,c=dY.color,forceRender=true}aT[#aT+1]=aF;if dY.snow then local ek=0.93;local el=dY.snowHeight or 0.5;local em=1-el*eg/(ej/dY.scale)em=d(0,c(1,em))if em>0.2 then local en={x1=(h*em+j*(1-em))*ek,y1=dY.y+ej*(1-em),z1=(aa*em+ab*(1-em))*ek,x2=(X*em+j*(1-em))*ek,y2=dY.y+ej*(1-em),z2=(ac*em+ab*(1-em))*ek,x3=j*ek,y3=dY.y+ej,z3=ab*ek,c=dY.snowColor,forceRender=true}aT[#aT+1]=en end end end;for bP,bQ in pairs(b4)do aT[bP]=bQ end;return aT end;return{newFrame=cq,loadModel=bR,newBuffer=g,models=dW,transforms=b4}