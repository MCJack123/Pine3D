local a=(...):match("(.-)[^%.]+$")local b=require(a.."betterblittle")local c={}for d=1,16 do c[2^(d-1)]=("0123456789abcdef"):sub(d,d)end;local e=math.pow(10,99)local function f(g,h,i,j)local k=i-g;if k==0 then return e,-e*g end;local l=(j-h)/k;return l,h-l*g end;local m=math.min;local n=math.max;local o=math.floor;local p=math.ceil;local function q(g,h,i,j)local r={x1=g,y1=h,x2=i,y2=j,width=i-g+1,height=j-h+1,screenBuffer={{}},blittleWindow=nil,blittleOn=false,backgroundColor=colors.lightBlue}function r:setBufferSize(s,t,u,v)self.x1=s;self.y1=t;self.x2=u;self.y2=v;self.width=u-s+1;self.height=v-t+1;if self.blittleWindow then self.blittleWindow=self.blittleWindow.reposition(self.x1,self.y1,self.x1+self.width-1,self.y1+self.height-1)end;self:clear()end;function r:clear()local w=self.screenBuffer;w.c2={}w.depth={}local x=w.c2;local y=w.depth;local z=math.huge;local A=self.width;local B=self.backgroundColor;if self.blittleOn then for C=1,self.height do x[C]={}y[C]={}local D=x[C]local E=y[C]for F=1,A do D[F]=B;E[F]=z end end else local G=c[B]w.c1={}local H=w.c1;w.chars={}local I=w.chars;for C=1,self.height do H[C]={}x[C]={}I[C]={}y[C]={}local J=H[C]local D=x[C]local K=I[C]local E=y[C]for F=1,A do J[F]=G;D[F]=G;K[F]=" "E[F]=z end end end end;function r:fastClearNormal()local L=self.backgroundColor;local w=self.screenBuffer;local I=w.chars;local H=w.c1;local x=w.c2;local y=self.screenBuffer.depth;local L=c[L]local z=math.huge;local A=self.width;for C=1,self.height do local K=I[C]local J=H[C]local D=x[C]local E=y[C]for F=1,A do K[F]=" "J[F]=L;D[F]=L;E[F]=z end end end;function r:fastClearBLittle()local L=self.backgroundColor;local x=self.screenBuffer.c2;local y=self.screenBuffer.depth;local z=math.huge;local A=self.width;for C=1,self.height do local D=x[C]local E=y[C]for F=1,A do D[F]=L;E[F]=z end end end;function r:setPixel(F,C,H,x,M)F=math.floor(F+0.5)C=math.floor(C+0.5)if F>=1 and F<=self.width then if C>=1 and C<=self.height then local w=self.screenBuffer;if self.blittleOn then w.c2[C][F]=x or H else w.c1[C][F]=c[H]w.c2[C][F]=c[x or H]w.chars[C][F]=" "end end end end;function r:image(k,N,O)for C,P in pairs(O)do for F,Q in pairs(P)do if Q and Q>0 then if self.blittleOn then self:setPixel(F+(k-1)*2,C+(N-1)*3,Q,Q," ")else self:setPixel(F+k-1,C+N-1,Q,Q," ")end end end end end;function r:loadLineNormal(g,h,i,j,L,M,R,l,S,y)local w=self.screenBuffer;local H=w.c1;local x=w.c2;local I=w.chars;local T=w.depth;local U=self.width;local V=self.height;if i>=g then for F=n(p(g),1),m(o(i),U)do local C=o(l*F+S+0.5)if C>0 and C<=V and y<=T[C][F]then H[C][F]=R;x[C][F]=L;I[C][F]=M;T[C][F]=y end end else for F=n(p(i),1),m(o(g),U)do local C=o(l*F+S+0.5)if C>0 and C<=V and y<=T[C][F]then H[C][F]=R;x[C][F]=L;I[C][F]=M;T[C][F]=y end end end;if j>=h then for C=n(p(h),1),m(o(j),V)do local F=o((C-S)/l+0.5)local W=T[C]if F>0 and F<=U and y<=W[F]then H[C][F]=R;x[C][F]=L;I[C][F]=M;W[F]=y end end else for C=n(p(j),1),m(o(h),V)do local F=o((C-S)/l+0.5)local W=T[C]if F>0 and F<=U and y<=W[F]then H[C][F]=R;x[C][F]=L;I[C][F]=M;W[F]=y end end end end;function r:loadLineBLittle(g,h,i,j,L,l,S,y)local w=self.screenBuffer;local x=w.c2;local T=w.depth;local U=self.width;local V=self.height;if i>=g then for F=n(p(g),1),m(o(i),U)do local C=o(l*F+S+0.5)if C>0 and C<=V and y<=T[C][F]then x[C][F]=L;T[C][F]=y end end else for F=n(p(i),1),m(o(g),U)do local C=o(l*F+S+0.5)if C>0 and C<=V and y<=T[C][F]then x[C][F]=L;T[C][F]=y end end end;if j>=h then for C=n(p(h),1),m(o(j),V)do local F=o((C-S)/l+0.5)local W=T[C]if F>0 and F<=U and y<=W[F]then x[C][F]=L;W[F]=y end end else for C=n(p(j),1),m(o(h),V)do local F=o((C-S)/l+0.5)local W=T[C]if F>0 and F<=U and y<=W[F]then x[C][F]=L;W[F]=y end end end end;local X=colors.black;function r:drawTriangleNormal(g,h,i,j,Y,Z,L,M,R,_,y)if g<1 and i<1 and Y<1 or h<1 and j<1 and Z<1 then return end;local U=self.width;if g>U and i>U and Y>U then return end;local V=self.height;if h>V and j>V and Z>V then return end;if h>j then h,j=j,h;g,i=i,g end;if j>Z then Z,j=j,Z;Y,i=i,Y end;if h>j then h,j=j,h;g,i=i,g end;local w=self.screenBuffer;local o,p=o,p;local m,n=m,n;local a0=m(n(1,p(h)),V)local a1=m(n(0,o(j)),V)local a2=m(n(1,o(Z)),V)local H=w.c1;local x=w.c2;local I=w.chars;local T=w.depth;local a3=(i-g)/(j-h)local a4=(g-Y)/(h-Z)M=M or" "R=R or L;local L=c[L]local R=c[R]if h~=j and h~=Z then for C=a0,a1 do local J=H[C]local D=x[C]local K=I[C]local E=T[C]local a5=(C-h)*a3+g;local a6=(C-Z)*a4+Y;if a6<a5 then a5,a6=a6,a5 end;if a5<1 then a5=1 end;if a5>U then a5=U+1 end;if a6<1 then a6=0 end;if a6>U then a6=U end;for F=o(a5+0.5),o(a6+0.5)do if y<E[F]then E[F]=y;J[F]=R;D[F]=L;K[F]=M end end end end;local a7=(Y-i)/(Z-j)local a4=(g-Y)/(h-Z)if Z~=j and h~=Z then for C=a1+1,a2 do local J=H[C]local D=x[C]local K=I[C]local E=T[C]local a5=(C-j)*a7+i;local a6=(C-Z)*a4+Y;if a6<a5 then a5,a6=a6,a5 end;if a5<1 then a5=1 end;if a5>U then a5=U+1 end;if a6<1 then a6=0 end;if a6>U then a6=U end;for F=o(a5+0.5),o(a6+0.5)do if y<E[F]then E[F]=y;J[F]=R;D[F]=L;K[F]=M end end end end;local _=_;if _ or self.triangleEdges then local a8,a9=f(g,h,i,j)local aa,ab=f(i,j,Y,Z)local ac,ad=f(g,h,Y,Z)local ae=self.loadLineNormal;local L=c[_ or X]ae(self,g,h,i,j,L,M,R,a8,a9,y)ae(self,i,j,Y,Z,L,M,R,aa,ab,y)ae(self,Y,Z,g,h,L,M,R,ac,ad,y)end end;function r:drawTriangleBLittle(g,h,i,j,Y,Z,L,M,R,_,y)if g<1 and i<1 and Y<1 or h<1 and j<1 and Z<1 then return end;local U=self.width;if g>U and i>U and Y>U then return end;local V=self.height;if h>V and j>V and Z>V then return end;if h>j then h,j=j,h;g,i=i,g end;if j>Z then Z,j=j,Z;Y,i=i,Y end;if h>j then h,j=j,h;g,i=i,g end;local w=self.screenBuffer;local o,p=o,p;local m,n=m,n;local a0=m(n(1,p(h)),V)local a1=m(n(0,o(j)),V)local a2=m(n(1,o(Z)),V)local x=w.c2;local T=w.depth;local a3=(i-g)/(j-h)local a4=(g-Y)/(h-Z)if h~=j and h~=Z then for C=a0,a1 do local D=x[C]local E=T[C]local a5=(C-h)*a3+g;local a6=(C-Z)*a4+Y;if a6<a5 then a5,a6=a6,a5 end;if a5<1 then a5=1 end;if a5>U then a5=U+1 end;if a6<1 then a6=0 end;if a6>U then a6=U end;for F=o(a5+0.5),o(a6+0.5)do if y<E[F]then E[F]=y;D[F]=L end end end end;local a7=(Y-i)/(Z-j)local a4=(g-Y)/(h-Z)if Z~=j and h~=Z then for C=a1+1,a2 do local D=x[C]local E=T[C]local a5=(C-j)*a7+i;local a6=(C-Z)*a4+Y;if a6<a5 then a5,a6=a6,a5 end;if a5<1 then a5=1 end;if a5>U then a5=U+1 end;if a6<1 then a6=0 end;if a6>U then a6=U end;for F=o(a5+0.5),o(a6+0.5)do if y<E[F]then E[F]=y;D[F]=L end end end end;local _=_;if _ or self.triangleEdges then local a8,a9=f(g,h,i,j)local aa,ab=f(i,j,Y,Z)local ac,ad=f(g,h,Y,Z)local ae=self.loadLineBLittle;local L=_ or X;ae(self,g,h,i,j,L,a8,a9,y)ae(self,i,j,Y,Z,L,aa,ab,y)ae(self,Y,Z,g,h,L,ac,ad,y)end end;function r:drawBufferNormal()local g=self.x1;local h=self.y1;local w=self.screenBuffer;local af=term.setCursorPos;local ag=term.blit;local I=w.chars;local H=w.c1;local x=w.c2;local ah=table.concat;for C=1,self.height do af(g,C+h-1)local I=ah(I[C])local H=ah(H[C])local x=ah(x[C])ag(I,H,x)end end;function r:drawBufferBLittle()local ai=self.blittleWindow;if not ai then self.blittleWindow=window.create(term.current(),self.x1,self.y1,self.x1+self.width-1,self.y1+self.height-1,false)ai=self.blittleWindow end;b.drawBuffer(self.screenBuffer.c2,ai)ai.setVisible(true)ai.setVisible(false)end;function r:highResMode(aj)self.blittleOn=aj;self.drawTriangle=aj and self.drawTriangleBLittle or self.drawTriangleNormal;self.fastClear=aj and self.fastClearBLittle or self.fastClearNormal;self.drawBuffer=aj and self.drawBufferBLittle or self.drawBufferNormal;self:clear()end;function r:useTriangleEdges(aj)self.triangleEdges=aj end;r:highResMode(true)return r end;local function ak(al,am,an,ao,ap)local aq=ap[1]local ar=ap[2]local as=ap[3]local at=am and am-aq or 0;local au=an and an-ar or 0;local av=ao and ao-as or 0;for d=1,#al do local aw=al[d]local ax=at+(aw[1]+aw[4]+aw[7])/3;local ay=au+(aw[2]+aw[5]+aw[8])/3;local az=av+(aw[3]+aw[6]+aw[9])/3;aw[16]=ax*ax+ay*ay+az*az end end;local aA=math.rad;local aB=math.sin;local aC=math.cos;local function aD(F,C,aE,aF,aG)local aH=aG*aE-aF*C;local C=aF*aE+aG*C;local aE=aH;return F,C,aE end;local function aI(F,C,aE,aF,aG)local aH=aG*aE-aF*F;local F=aF*aE+aG*F;local aE=aH;return F,C,aE end;local function aJ(F,C,aE,aF,aG)local j=aG*C-aF*F;local F=aF*C+aG*F;local C=j;return F,C end;local function aK(aL,aM,aN,aO)local aP,aQ=0,1;local aR,aS=0,1;local aT,aU=0,1;if aM==0 then aM=nil end;if aM then aP,aQ=aB(aM),aC(aM)end;if aN==0 then aN=nil end;if aN then aR,aS=aB(aN),aC(aN)end;if aO==0 then aO=nil end;if aO then aT,aU=aB(aO),aC(aO)end;local aV={}for aW,aw in pairs(aL)do local g,h,aX=aw[1],aw[2],aw[3]local i,j,aH=aw[4],aw[5],aw[6]local Y,Z,aY=aw[7],aw[8],aw[9]if aN then g,h,aX=aI(g,h,aX,aR,aS)i,j,aH=aI(i,j,aH,aR,aS)Y,Z,aY=aI(Y,Z,aY,aR,aS)end;if aO then g,h=aJ(g,h,aX,aT,aU)i,j=aJ(i,j,aH,aT,aU)Y,Z=aJ(Y,Z,aY,aT,aU)end;if aM then g,h,aX=aD(g,h,aX,aP,aQ)i,j,aH=aD(i,j,aH,aP,aQ)Y,Z,aY=aD(Y,Z,aY,aP,aQ)end;aV[#aV+1]={g,h,aX,i,j,aH,Y,Z,aY}aV[#aV][10]=aw[10]aV[#aV][11]=aw[11]aV[#aV][12]=aw[12]aV[#aV][13]=aw[13]aV[#aV][14]=aw[14]end;return aV end;local aZ={}function aZ.invertTriangles(aL)if not aL or type(aL)~="table"then error("transforms.invertTriangles expected arg#1 to be a table (model)")end;for d=1,#aL do local a_=aL[d]aL[d]={x1=a_.x1,y1=a_.y1,z1=a_.z1,x2=a_.x3,y2=a_.y3,z2=a_.z3,x3=a_.x2,y3=a_.y2,z3=a_.z2,c=a_.c,char=a_.char,charc=a_.charc,forceRender=a_.forceRender,outlineColor=a_.outlineColor}end;return aL end;function aZ.setOutline(aL,b0)if not aL or type(aL)~="table"then error("transforms.invertTriangles expected arg#1 to be a table (model)")end;for d=1,#aL do local a_=aL[d]if type(b0)=="table"then a_.outlineColor=b0[a_.c]or a_.outlineColor else a_.outlineColor=b0 end end;return aL end;function aZ.mapColor(aL,b0)if not aL or type(aL)~="table"then error("transforms.mapColor expected arg#1 to be a table (model)")end;for d=1,#aL do local a_=aL[d]if type(b0)=="table"then a_.c=b0[a_.c]or a_.c else a_.c=b0 end end;return aL end;function aZ.center(aL)local b1,b2=math.huge,-math.huge;local a0,a2=math.huge,-math.huge;local b3,b4=math.huge,-math.huge;for d=1,#aL do local b5=aL[d]b1,b2=m(b1,b5.x1),n(b2,b5.x1)b1,b2=m(b1,b5.x2),n(b2,b5.x2)b1,b2=m(b1,b5.x3),n(b2,b5.x3)a0,a2=m(a0,b5.y1),n(a2,b5.y1)a0,a2=m(a0,b5.y2),n(a2,b5.y2)a0,a2=m(a0,b5.y3),n(a2,b5.y3)b3,b4=m(b3,b5.z1),n(b4,b5.z1)b3,b4=m(b3,b5.z2),n(b4,b5.z2)b3,b4=m(b3,b5.z3),n(b4,b5.z3)end;local b6=-(b2+b1)*0.5;local b7=-(a2+a0)*0.5;local b8=-(b4+b3)*0.5;for d=1,#aL do local b5=aL[d]b5.x1=b5.x1+b6;b5.x2=b5.x2+b6;b5.x3=b5.x3+b6;b5.y1=b5.y1+b7;b5.y2=b5.y2+b7;b5.y3=b5.y3+b7;b5.z1=b5.z1+b8;b5.z2=b5.z2+b8;b5.z3=b5.z3+b8 end;return aL end;function aZ.normalizeScale(aL)local b9=-math.huge;for d=1,#aL do local b5=aL[d]b9=n(b9,b5.x1)b9=n(b9,b5.x2)b9=n(b9,b5.x3)b9=n(b9,b5.y1)b9=n(b9,b5.y2)b9=n(b9,b5.y3)b9=n(b9,b5.z1)b9=n(b9,b5.z2)b9=n(b9,b5.z3)end;for d=1,#aL do local b5=aL[d]b5.x1=b5.x1/b9;b5.x2=b5.x2/b9;b5.x3=b5.x3/b9;b5.y1=b5.y1/b9;b5.y2=b5.y2/b9;b5.y3=b5.y3/b9;b5.z1=b5.z1/b9;b5.z2=b5.z2/b9;b5.z3=b5.z3/b9 end;return aL end;function aZ.normalizeScaleY(aL)local b9=-math.huge;for d=1,#aL do local b5=aL[d]b9=n(b9,b5.y1)b9=n(b9,b5.y2)b9=n(b9,b5.y3)end;for d=1,#aL do local b5=aL[d]b5.x1=b5.x1/b9;b5.x2=b5.x2/b9;b5.x3=b5.x3/b9;b5.y1=b5.y1/b9;b5.y2=b5.y2/b9;b5.y3=b5.y3/b9;b5.z1=b5.z1/b9;b5.z2=b5.z2/b9;b5.z3=b5.z3/b9 end;return aL end;function aZ.scale(aL,ba)for d=1,#aL do local b5=aL[d]b5.x1=b5.x1*ba;b5.x2=b5.x2*ba;b5.x3=b5.x3*ba;b5.y1=b5.y1*ba;b5.y2=b5.y2*ba;b5.y3=b5.y3*ba;b5.z1=b5.z1*ba;b5.z2=b5.z2*ba;b5.z3=b5.z3*ba end;return aL end;function aZ.translate(aL,k,N,bb)for d=1,#aL do local b5=aL[d]b5.x1=b5.x1+(k or 0)b5.x2=b5.x2+(k or 0)b5.x3=b5.x3+(k or 0)b5.y1=b5.y1+(N or 0)b5.y2=b5.y2+(N or 0)b5.y3=b5.y3+(N or 0)b5.z1=b5.z1+(bb or 0)b5.z2=b5.z2+(bb or 0)b5.z3=b5.z3+(bb or 0)end;return aL end;function aZ.rotate(aL,aM,aN,aO)local aP,aQ=0,1;local aR,aS=0,1;local aT,aU=0,1;if aM==0 then aM=nil end;if aM then aP,aQ=aB(aM),aC(aM)end;if aN==0 then aN=nil end;if aN then aR,aS=aB(aN),aC(aN)end;if aO==0 then aO=nil end;if aO then aT,aU=aB(aO),aC(aO)end;for d=1,#aL do local aw=aL[d]local g,h,aX=aw.x1,aw.y1,aw.z1;local i,j,aH=aw.x2,aw.y2,aw.z2;local Y,Z,aY=aw.x3,aw.y3,aw.z3;if aN then g,h,aX=aI(g,h,aX,aR,aS)i,j,aH=aI(i,j,aH,aR,aS)Y,Z,aY=aI(Y,Z,aY,aR,aS)end;if aO then g,h=aJ(g,h,aX,aT,aU)i,j=aJ(i,j,aH,aT,aU)Y,Z=aJ(Y,Z,aY,aT,aU)end;if aM then g,h,aX=aD(g,h,aX,aP,aQ)i,j,aH=aD(i,j,aH,aP,aQ)Y,Z,aY=aD(Y,Z,aY,aP,aQ)end;aw.x1,aw.y1,aw.z1=g,h,aX;aw.x2,aw.y2,aw.z2=i,j,aH;aw.x3,aw.y3,aw.z3=Y,Z,aY end;return aL end;function aZ.alignBottom(aL)local a0=math.huge;for d=1,#aL do local b5=aL[d]a0=m(a0,b5.y1)a0=m(a0,b5.y2)a0=m(a0,b5.y3)end;for d=1,#aL do local b5=aL[d]b5.y1=b5.y1-a0;b5.y2=b5.y2-a0;b5.y3=b5.y3-a0 end;return aL end;function aZ.decimate(aL,bc,bd)local be={}local bf={}local function bg(F,C,aE)for d=#be,1,-1 do local bh=be[d]if bh[1]==F and bh[2]==C and bh[3]==aE then return d end end end;for d=1,#aL do local b5=aL[d]local bi=bg(b5.x1,b5.y1,b5.z1)if not bi then be[#be+1]={b5.x1,b5.y1,b5.z1}bi=#be end;local bj=bg(b5.x2,b5.y2,b5.z2)if not bj then be[#be+1]={b5.x2,b5.y2,b5.z2}bj=#be end;local bk=bg(b5.x3,b5.y3,b5.z3)if not bk then be[#be+1]={b5.x3,b5.y3,b5.z3}bk=#be end;local a_={bi,bj,bk,b5.c,b5.char,b5.charc,b5.forceRender}bf[#bf+1]=a_ end;local function bl(bm,bn)local k=bm[1]-bn[1]local N=bm[2]-bn[2]local bb=bm[3]-bn[3]return(k*k+N*N+bb*bb)^0.5 end;local bo={}for d=1,#bf do local a_=bf[d]local bp=bl(be[a_[1]],be[a_[2]])local bq=bl(be[a_[2]],be[a_[3]])local br=bl(be[a_[1]],be[a_[3]])bo[#bo+1]={length=bp,vA=a_[1],vB=a_[2]}bo[#bo+1]={length=bq,vA=a_[2],vB=a_[3]}bo[#bo+1]={length=br,vA=a_[1],vB=a_[3]}end;local function bs(bt,bu)local bv=be[bt]local bw=be[bu]local bx={(bv[1]+bw[1])*0.5,(bv[2]+bw[2])*0.5,(bv[3]+bw[3])*0.5}be[#be+1]=bx;local by=#be;for d=#bf,1,-1 do local bz=bf[d]if bz[1]==bt or bz[1]==bu or bz[2]==bt or bz[2]==bu or bz[3]==bt or bz[3]==bu then if bz[1]==bt or bz[1]==bu then bz[1]=by end;if bz[2]==bt or bz[2]==bu then bz[2]=by end;if bz[3]==bt or bz[3]==bu then bz[3]=by end;if bz[1]==bz[2]or bz[2]==bz[3]or bz[1]==bz[3]then table.remove(bf,d)end end end;return by end;local bA=bc;if bd~="polys"then bA=#aL*bc end;while#bf>bA do local bB=math.huge;local bC;for d=1,#bo do local bD=bo[d]if bD.length<bB then bB=bD.length;bC=d end end;local bE=bo[bC]local by=bs(bE.vA,bE.vB)for d=#bo,1,-1 do local bD=bo[d]local bF=bD.vA==bE.vA or bD.vA==bE.vB;local bG=bD.vB==bE.vA or bD.vB==bE.vB;if bF and bG then table.remove(bo,d)elseif bF then bD.vA=by elseif bG then bD.vB=by end end end;local bH={}for d=1,#bf do local a_=bf[d]local bm=be[a_[1]]local bn=be[a_[2]]local bI=be[a_[3]]bH[#bH+1]={x1=bm[1],y1=bm[2],z1=bm[3],x2=bn[1],y2=bn[2],z2=bn[3],x3=bI[1],y3=bI[2],z3=bI[3],c=a_[4],char=a_[5],charc=a_[6],forceRender=a_[7]}end;for bJ,bK in pairs(aZ)do bH[bJ]=bK end;return bH end;local bL,bM;function aZ.toLoD(aL,bN)bN=bN or{}local bO={minQuality=bN.minQuality or 0.1,variantCount=bN.variantCount or 4,qualityHalvingDistance=bN.qualityHalvingDistance or 5,quickInitWorseRuntime=bN.quickInitWorseRuntime or false}local bP,bQ=bM(aL)local bR={{quality=1,collapsedModel=bP,size=bQ}}local bS=aL;local bT=#bS;for d=1,bO.variantCount do local bc=(1-bO.minQuality)*(1-d/bO.variantCount)+bO.minQuality;local bU=math.floor(bT*bc+0.5)local bV=bS:decimate(bU,"polys")local bP,bQ=bM(bV)bS=bV;local bW={quality=bc,collapsedModel=bP,size=bQ}bR[#bR+1]=bW end;local function bX(bY)local bZ={}for d=1,#bY do local bW=bY[d]local aL=bW.collapsedModel;local b_={}for c0=1,#aL do local b5=aL[c0]local c1={b5[1],b5[2],b5[3],b5[4],b5[5],b5[6],b5[7],b5[8],b5[9],b5[10],b5[11],b5[12],b5[13],b5[14]}b_[c0]=c1 end;local c2={quality=bW.quality,size=bW.size,collapsedModel=b_}bZ[d]=c2 end;return bZ end;local c3={}function bO:initObject(c4)local c5;if bO.quickInitWorseRuntime then c5=bR else c5=bX(bR)end;c3[c4]=c5;c4[7]=c5[1].collapsedModel;c4[8]=c5[1].size;c4[9]=bO end;function bO:update(c4,ap)local c5=c3[c4]if c5 then local k=ap[1]-c4[1]local N=ap[2]-c4[2]local bb=ap[3]-c4[3]local c6=(k*k+N*N+bb*bb)^0.5;local c7=math.min(1,math.max(bO.minQuality,1/(c6/bO.qualityHalvingDistance)))local c8=bO.variantCount+1-bO.variantCount*(c7-bO.minQuality)/(1-bO.minQuality)local c9=math.floor(c8+0.5)local bW=c5[c9]c4[7]=bW.collapsedModel;c4[8]=bW.size end end;return bO end;local ca=math.sqrt;function bM(aL)local cb={}local cc=0;for d=1,#aL do local aw=aL[d]cb[#cb+1]={}cb[#cb][1]=aw.x1;cb[#cb][2]=aw.y1;cb[#cb][3]=aw.z1;cb[#cb][4]=aw.x2;cb[#cb][5]=aw.y2;cb[#cb][6]=aw.z2;cb[#cb][7]=aw.x3;cb[#cb][8]=aw.y3;cb[#cb][9]=aw.z3;cb[#cb][10]=aw.forceRender;cb[#cb][11]=aw.c;cb[#cb][12]=aw.char;cb[#cb][13]=aw.charc;cb[#cb][14]=aw.outlineColor;local cd=ca(aw.x1*aw.x1+aw.y1*aw.y1+aw.z1*aw.z1)local ce=ca(aw.x2*aw.x2+aw.y2*aw.y2+aw.z2*aw.z2)local cf=ca(aw.x3*aw.x3+aw.y3*aw.y3+aw.z3*aw.z3)if cd>cc then cc=cd end;if ce>cc then cc=ce end;if cf>cc then cc=cf end end;return cb,cc end;function bL(cg)local ch=fs.open(cg,"r")if not ch then error("Could not find model for an object at path: "..cg)end;local ci=ch.readAll()ch.close()local aL=textutils.unserialise(ci)for bJ,bK in pairs(aZ)do aL[bJ]=bK end;return aL end;local cj=math.pi;local aB=math.sin;local aC=math.cos;local ck=math.tan;local ca=math.sqrt;local function cl(g,h,i,j)local A,cm=term.getSize()if g and i then A=i-g+1 end;if h and j then cm=j-h+1 end;local g=g or 1;local h=h or 1;local i=i or A-g+1;local j=j or cm-h+1;local cn={camera={0.000001,0.000001,0.000001,nil,0,0},buffer=q(g,h,i,j),x1=g,y1=h,x2=i,y2=j,width=A,height=cm,blittleOn=false,pixelratio=1.5}cn.FoV=90;cn.camera[7]=aA(cn.FoV)cn.t=ck(aA(cn.FoV/2))*2*0.0001;local co,cp,cq,cr;function cn:setBackgroundColor(L)local cs=self.buffer;cs.backgroundColor=L;cs:fastClear()end;local function ct()co=o(cn.width*0.5)+1;cp=o(cn.height*0.5)cq=0.0001*cn.width/cn.t;cr=-0.0001*cn.width/(cn.t*cn.height*cn.pixelratio)*cn.height end;function cn:setSize(g,h,i,j)self.x1=g;self.y1=h;self.x2=i;self.y2=j;if not self.blittleOn then self.buffer:setBufferSize(g,h,i,j)self.width=i-g+1;self.height=j-h+1;self.pixelratio=1.5 else self.width=(i-g+1)*2;self.height=(j-h+1)*3;self.pixelratio=1;self.buffer:setBufferSize(g,h,g+self.width-1,h+self.height-1)end;ct()end;function cn:highResMode(aj)self.blittleOn=aj;self.buffer:highResMode(aj)if aj then self.width=(self.x2-self.x1+1)*2;self.height=(self.y2-self.y1+1)*3;self.buffer:setBufferSize(self.x1,self.y1,self.x1+self.width-1,self.y1+self.height-1)self.pixelratio=1 else self.buffer:setBufferSize(self.x1,self.y1,self.x2,self.y2)self.width=self.x2-self.x1+1;self.height=self.y2-self.y1+1;self.pixelratio=1.5 end;ct()end;function cn:map3dTo2d(F,C,aE)local ap=self.camera;local cu=aB(ap[4]or 0)local cv=aC(ap[4]or 0)local cw=aB(-ap[5])local cx=aC(-ap[5])local cy=aB(ap[6])local cz=aC(ap[6])local cA=F-ap[1]local cB=C-ap[2]local cC=aE-ap[3]local cD=cx*cA-cw*cC;cC=cw*cA+cx*cC;cA=cD;local cE=cz*cB-cy*cA;cA=cy*cB+cz*cA;cB=cE;if cu~=0 then local cF=cu*cC-cv*cB;cB=cv*cC+cu*cB;cC=cF end;local cG=cC/cA*cq+co;local cH=cB/cA*cr+cp;return cG,cH,cA>=0.0001 end;function cn:drawObject(c4,ap,cI)local cJ=c4[1]local cK=c4[2]local cL=c4[3]local cu=cI[1]local cv=cI[2]local cw=cI[3]local cx=cI[4]local cy=cI[5]local cz=cI[6]local cM=cJ and cJ-ap[1]or 0;local cN=cK and cK-ap[2]or 0;local cO=cL and cL-ap[3]or 0;local bO=c4[9]if bO then bO:update(c4,ap)end;local aL=c4[7]if#aL<=0 then return end;local bQ=c4[8]local cA=cM;local cB=cN;local cC=cO;local cD=cx*cA-cw*cC;local cC=cw*cA+cx*cC;local cA=cD;local cA=cy*cB+cz*cA;if cA<-bQ then return end;local cP=0.5*ap[7]local cQ=aB(cP)local cR=aC(cP)if(cA+bQ)*cQ+(cC+bQ)*cR<0 then return end;if(cA+bQ)*cQ-(cC-bQ)*cR<0 then return end;local aM=c4[4]local aN=c4[5]local aO=c4[6]if aM and aM~=0 or aN and aN~=0 or aO and aO~=0 then aL=aK(aL,aM,aN,aO)end;ak(aL,cJ,cK,cL,ap)local cS=cM*cM+cN*cN+cO*cO<bQ*bQ*4;local co=co;local cp=cp;local cq=cq;local cr=cr;local cu=cu;local cv=cv;local cw=cw;local cx=cx;local cy=cy;local cz=cz;local cM=cM;local cN=cN;local cO=cO;local function cT(cA,cB,cC)local cD=cx*cA-cw*cC;cC=cw*cA+cx*cC;cA=cD;local cE=cz*cB-cy*cA;cA=cy*cB+cz*cA;cB=cE;local cG=cC/cA*cq+co;local cH=cB/cA*cr+cp;return cG,cH,cA end;if cu~=0 then function cT(cA,cB,cC)local cD=cx*cA-cw*cC;cC=cw*cA+cx*cC;cA=cD;local cE=cz*cB-cy*cA;cA=cy*cB+cz*cA;cB=cE;local cF=cu*cC-cv*cB;cB=cv*cC+cu*cB;cC=cF;local cG=cC/cA*cq+co;local cH=cB/cA*cr+cp;return cG,cH,cA end end;local cU=aL;local cs=self.buffer;for d=1,#cU do local aw=cU[d]local y=aw[16]local g,h,cV=cT(aw[1]+cM,aw[2]+cN,aw[3]+cO)if cV>0.00010000001 then local i,j,cD=cT(aw[4]+cM,aw[5]+cN,aw[6]+cO)if cD>0.00010000001 then local Y,Z,cW=cT(aw[7]+cM,aw[8]+cN,aw[9]+cO)if cW>0.00010000001 then if aw[10]or(i-g)*(Z-j)-(j-h)*(Y-i)<0 then cs:drawTriangle(g,h,i,j,Y,Z,aw[11],aw[12],aw[13],aw[14],y)end elseif cS then local function cX(F,C,aE)local cA=F+cM;local cB=C+cN;local cC=aE+cO;local cD=cx*cA-cw*cC;cC=cw*cA+cx*cC;cA=cD;local cE=cz*cB-cy*cA;cA=cy*cB+cz*cA;cB=cE;if cu~=0 then local cF=cu*cC-cv*cB;cB=cv*cC+cu*cB;cC=cF end;local cG=cC/cA*cq+co;local cH=cB/cA*cr+cp;return cG,cH,cA,cB,cC end;local g,h,cV,cY,cZ=cX(aw[1],aw[2],aw[3])local i,j,cD,cE,cF=cX(aw[4],aw[5],aw[6])local Y,Z,cW,c_,d0=cX(aw[7],aw[8],aw[9])local d1=math.abs;local d2=d1(cW-0.0001)local d3=d1(cV-0.0001)local d4=d3+d2;local d5=(d0*d3+cZ*d2)/d4;local d6=(c_*d3+cY*d2)/d4;local co,cq,cp,cr=co,cq,cp,cr;local d7=d5*10000*cq+co;local d8=d6*10000*cr+cp;if aw[10]or(i-g)*(d8-j)-(j-h)*(d7-i)<0 then cs:drawTriangle(g,h,i,j,d7,d8,aw[11],aw[12],aw[13],aw[14],y)local d9=d1(cD-0.0001)local d4=d9+d2;local d5=(cF*d2+d0*d9)/d4;local d6=(cE*d2+c_*d9)/d4;local da=d5*10000*cq+co;local db=d6*10000*cr+cp;cs:drawTriangle(da,db,i,j,d7,d8,aw[11],aw[12],aw[13],aw[14],y)end end elseif cS then local function cX(F,C,aE)local cA=F+cM;local cB=C+cN;local cC=aE+cO;local cD=cx*cA-cw*cC;cC=cw*cA+cx*cC;cA=cD;local cE=cz*cB-cy*cA;cA=cy*cB+cz*cA;cB=cE;if cu~=0 then local cF=cu*cC-cv*cB;cB=cv*cC+cu*cB;cC=cF end;local cG=cC/cA*cq+co;local cH=cB/cA*cr+cp;return cG,cH,cA,cB,cC end;local g,h,cV,cY,cZ=cX(aw[1],aw[2],aw[3])local i,j,cD,cE,cF=cX(aw[4],aw[5],aw[6])local Y,Z,cW,c_,d0=cX(aw[7],aw[8],aw[9])local d1=math.abs;if cW>0.00010000001 then local d9=d1(cD-0.0001)local d3=d1(cV-0.0001)local d4=d3+d9;local d5=(cF*d3+cZ*d9)/d4;local d6=(cE*d3+cY*d9)/d4;local co,cq,cp,cr=co,cq,cp,cr;local d7=d5*10000*cq+co;local d8=d6*10000*cr+cp;if aw[10]or(d7-g)*(Z-d8)-(d8-h)*(Y-d7)<0 then cs:drawTriangle(g,h,d7,d8,Y,Z,aw[11],aw[12],aw[13],aw[14],y)local d2=d1(cW-0.0001)local d4=d9+d2;local d5=(cF*d2+d0*d9)/d4;local d6=(cE*d2+c_*d9)/d4;local da=d5*10000*cq+co;local db=d6*10000*cr+cp;cs:drawTriangle(da,db,d7,d8,Y,Z,aw[11],aw[12],aw[13],aw[14],y)end else local d3=d1(cV-0.0001)local d9=d1(cD-0.0001)local d2=d1(cW-0.0001)local dc=d3+d9;local dd=d3+d2;local d5=(cZ*d9+cF*d3)/dc;local d6=(cY*d9+cE*d3)/dc;local co,cq,cp,cr=co,cq,cp,cr;local d7=d5*10000*cq+co;local d8=d6*10000*cr+cp;local de=(cZ*d2+d0*d3)/dd;local df=(cY*d2+c_*d3)/dd;local da=de*10000*cq+co;local db=df*10000*cr+cp;if aw[10]or(d7-g)*(db-d8)-(d8-h)*(da-d7)<0 then cs:drawTriangle(g,h,d7,d8,da,db,aw[11],aw[12],aw[13],aw[14],y)end end end elseif cS then local function cX(F,C,aE)local cA=F+cM;local cB=C+cN;local cC=aE+cO;local cD=cx*cA-cw*cC;cC=cw*cA+cx*cC;cA=cD;local cE=cz*cB-cy*cA;cA=cy*cB+cz*cA;cB=cE;if cu~=0 then local cF=cu*cC-cv*cB;cB=cv*cC+cu*cB;cC=cF end;local cG=cC/cA*cq+co;local cH=cB/cA*cr+cp;return cG,cH,cA,cB,cC end;local g,h,cV,cY,cZ=cX(aw[1],aw[2],aw[3])local i,j,cD,cE,cF=cX(aw[4],aw[5],aw[6])local Y,Z,cW,c_,d0=cX(aw[7],aw[8],aw[9])local d1=math.abs;if cD>0.00010000001 then if cW>0.00010000001 then local d3=d1(cV-0.0001)local d9=d1(cD-0.0001)local d4=d3+d9;local d5=(cZ*d9+cF*d3)/d4;local d6=(cY*d9+cE*d3)/d4;local co,cq,cp,cr=co,cq,cp,cr;local d7=d5*10000*cq+co;local d8=d6*10000*cr+cp;if aw[10]or(i-d7)*(Z-j)-(j-d8)*(Y-i)<0 then cs:drawTriangle(d7,d8,i,j,Y,Z,aw[11],aw[12],aw[13],aw[14],y)local d2=d1(cW-0.0001)local d4=d3+d2;local d5=(cZ*d2+d0*d3)/d4;local d6=(cY*d2+c_*d3)/d4;local da=d5*10000*cq+co;local db=d6*10000*cr+cp;cs:drawTriangle(d7,d8,da,db,Y,Z,aw[11],aw[12],aw[13],aw[14],y)end else local d3=d1(cV-0.0001)local d9=d1(cD-0.0001)local d2=d1(cW-0.0001)local dc=d9+d3;local dd=d9+d2;local d5=(cZ*d9+cF*d3)/dc;local d6=(cY*d9+cE*d3)/dc;local co,cq,cp,cr=co,cq,cp,cr;local d7=d5*10000*cq+co;local d8=d6*10000*cr+cp;local de=(cF*d2+d0*d9)/dd;local df=(cE*d2+c_*d9)/dd;local da=de*10000*cq+co;local db=df*10000*cr+cp;if aw[10]or(i-d7)*(db-j)-(j-d8)*(da-i)<0 then cs:drawTriangle(d7,d8,i,j,da,db,aw[11],aw[12],aw[13],aw[14],y)end end else if cW>0.00010000001 then local d3=d1(cV-0.0001)local d9=d1(cD-0.0001)local d2=d1(cW-0.0001)local dc=d2+d3;local dd=d2+d9;local d5=(cZ*d2+d0*d3)/dc;local d6=(cY*d2+c_*d3)/dc;local co,cq,cp,cr=co,cq,cp,cr;local d7=d5*10000*cq+co;local d8=d6*10000*cr+cp;local de=(cF*d2+d0*d9)/dd;local df=(cE*d2+c_*d9)/dd;local da=de*10000*cq+co;local db=df*10000*cr+cp;if aw[10]or(da-d7)*(Z-db)-(db-d8)*(Y-da)<0 then cs:drawTriangle(d7,d8,da,db,Y,Z,aw[11],aw[12],aw[13],aw[14],y)end end end end end end;function cn:drawObjects(dg)local ap=self.camera;local cI={aB(ap[4]or 0),aC(ap[4]or 0),aB(-ap[5]),aC(-ap[5]),aB(ap[6]),aC(ap[6])}local dg=dg;for d=1,#dg do self:drawObject(dg[d],ap,cI)end end;function cn:drawBuffer()local cs=self.buffer;cs:drawBuffer()cs:fastClear()end;function cn:setCamera(dh,di,dj,aM,aN,aO)local aA=math.rad;if type(dh)=="table"then local ap=dh;self.camera={ap.x or self.camera[1]or 0,ap.y or self.camera[2]or 0,ap.z or self.camera[3]or 0,ap.rotX and aA(ap.rotX+90)or self.camera[4]or 0,ap.rotY and aA(ap.rotY)or self.camera[5]or 0,ap.rotZ and aA(ap.rotZ)or self.camera[6]or 0,self.camera[7]}else self.camera={dh or self.camera[1]or 0,di or self.camera[2]or 0,dj or self.camera[3]or 0,aM and aA(aM+90)or self.camera[4]or 0,aN and aA(aN)or self.camera[5]or 0,aO and aA(aO)or self.camera[6]or 0,self.camera[7]}end;if self.camera[4]==math.pi*0.5 then self.camera[4]=nil end end;function cn:setFoV(cP)self.FoV=cP or 90;self.t=ck(aA(self.FoV/2))*2*0.0001;ct()self.camera[7]=aA(self.FoV)end;function cn:setWireFrame(aj)self.buffer:useTriangleEdges(aj)end;function cn:getObjectIndexTrace(dg,F,C)local function dk(g,h,i,j,Y,Z)return(g-Y)*(j-Z)-(i-Y)*(h-Z)end;local function dl(dm,dn,g,h,i,j,Y,Z,dp,dq,dr,ds)local a9=dk(dm,dn,g,h,i,j)<0;local ab=dk(dm,dn,i,j,Y,Z)<0;local ad=dk(dm,dn,Y,Z,g,h)<0;return a9==ab and ab==ad end;local C=C-1;local dt=self.blittleOn;local du=self.x1;local dv=self.y1;local dw=self.x2;local dx=self.y2;if dt then F=F*2;C=C*3+1 end;local ap=self.camera;local cI={aB(ap[4]or 0),aC(ap[4]or 0),aB(-ap[5]),aC(-ap[5]),aB(ap[6]),aC(ap[6])}local cu=cI[1]local cv=cI[2]local cw=cI[3]local cx=cI[4]local cy=cI[5]local cz=cI[6]local dy={}for d=1,#dg do local c4=dg[d]local aL=c4[7]local aM=c4[4]local aN=c4[5]local aO=c4[6]if aM and aM~=0 or aN and aN~=0 or aO and aO~=0 then aL=aK(aL,aM,aN,aO)end;local cJ=c4[1]local cK=c4[2]local cL=c4[3]local co=co;local cp=cp;local cq=cq;local cr=cr;local cu=cu;local cv=cv;local cw=cw;local cx=cx;local cy=cy;local cz=cz;local cM=cJ-ap[1]local cN=cK-ap[2]local cO=cL-ap[3]local function cT(F,C,aE)local cA=F+cM;local cB=C+cN;local cC=aE+cO;local cD=cx*cA-cw*cC;cC=cw*cA+cx*cC;cA=cD;local cE=cz*cB-cy*cA;cA=cy*cB+cz*cA;cB=cE;if cu~=0 then local cF=cu*cC-cv*cB;cB=cv*cC+cu*cB;cC=cF end;local cG=cC/cA*cq+co;local cH=cB/cA*cr+cp;return cG,cH,cA>0 end;for c0=1,#aL do local aw=aL[c0]local g,h,dz=cT(aw[1],aw[2],aw[3])if dz then local i,j,dA=cT(aw[4],aw[5],aw[6])if dA then local Y,Z,dB=cT(aw[7],aw[8],aw[9])if dB then if aw[10]or(i-g)*(Z-j)-(j-h)*(Y-i)<0 then local ax=cM+(aw[1]+aw[4]+aw[7])/3;local ay=cN+(aw[2]+aw[5]+aw[8])/3;local az=cO+(aw[3]+aw[6]+aw[9])/3;local y=ax*ax+ay*ay+az*az;if not dt then if dl(F,C,g,h,i,j,Y,Z,du,dv,dw,dx)then dy[#dy+1]={objectIndex=d,polygonIndex=c0,depth=y}end else if dl(F,C,g,h,i,j,Y,Z,(dw-1)*2+1,(dv-1)*3+1,dw*2,(dx+1)*3)then dy[#dy+1]={objectIndex=d,polygonIndex=c0,depth=y}end end end end end end end end;if#dy<=0 then return elseif#dy==1 then return dy[1].objectIndex,dy[1].polygonIndex,dy[1].depth end;local dC=-1;local dD=math.huge;for d=1,#dy do local dE=dy[d]if dE.depth<dD then dD=dE.depth;dC=d end end;local dE=dy[dC]return dE.objectIndex,dE.polygonIndex,dE.depth end;function cn:newObject(aL,F,C,aE,aM,aN,aO)local bP=nil;local bQ=nil;if type(aL)=="table"then if aL.initObject then else bP,bQ=bM(aL)end else local dF=bL(aL)bP,bQ=bM(dF)end;local c4={F,C,aE,aM,aN,aO,bP,bQ}c4.frame=self;function c4:setPos(dG,dH,dI)self[1]=dG or self[1]self[2]=dH or self[2]self[3]=dI or self[3]end;function c4:setRot(dJ,dK,dL)self[4]=dJ or self[4]self[5]=dK or self[5]self[6]=dL or self[6]end;function c4:setModel(dM)if type(dM)=="table"then bP,bQ=bM(dM)self[7]=bP;self[8]=bQ else local dF=bL(dM)bP,bQ=bM(dF)self[7]=bP;self[8]=bQ end end;if type(aL)=="table"then if aL.initObject then aL:initObject(c4)end end;return c4 end;ct()cn:highResMode(true)return cn end;local dN={}local function dO(g,h,aX,i,j,aH,Y,Z,aY,L)local b5={x1=g,y1=h,z1=aX,x2=i,y2=j,z2=aH,x3=Y,y3=Z,z3=aY,c=L}return b5 end;function dN:cube(dP)dP.color=dP.color or colors.red;local dQ={dO(-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,dP.bottom or dP.color),dO(-.5,-.5,-.5,.5,-.5,-.5,.5,-.5,.5,dP.bottom2 or dP.bottom or dP.color),dO(-.5,.5,-.5,-.5,.5,.5,.5,.5,.5,dP.top or dP.color),dO(-.5,.5,-.5,.5,.5,.5,.5,.5,-.5,dP.top or dP.color),dO(-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,dP.side or dP.color),dO(-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,dP.side2 or dP.side or dP.color),dO(.5,-.5,-.5,.5,.5,.5,.5,-.5,.5,dP.side or dP.color),dO(.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,dP.side2 or dP.side or dP.color),dO(-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,dP.side or dP.color),dO(-.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5,dP.side2 or dP.side or dP.color),dO(-.5,-.5,.5,.5,-.5,.5,-.5,.5,.5,dP.side or dP.color),dO(.5,-.5,.5,.5,.5,.5,-.5,.5,.5,dP.side2 or dP.side or dP.color)}for bJ,bK in pairs(aZ)do dQ[bJ]=bK end;return dQ end;function dN:sphere(dP)dP.res=dP.res or 32;dP.color=dP.color or colors.red;local aL={}local dR={}for d=0,dP.res do local C=0.5*aC(d/dP.res*cj)local dS={}for c0=0,dP.res do local dT=0.5*ca(1-C*2*C*2)local F=aC(c0/dP.res*cj*2)*dT;local aE=aB(c0/dP.res*cj*2)*dT;local i=aC((c0+1)/dP.res*cj*2)*dT;local aH=aB((c0+1)/dP.res*cj*2)*dT;if dR[c0]then aL[#aL+1]={x1=dR[(c0+1)%dP.res].x,y1=dR[(c0+1)%dP.res].y,z1=dR[(c0+1)%dP.res].z,x2=F,y2=C,z2=aE,x3=dR[c0].x,y3=dR[c0].y,z3=dR[c0].z,c=dP.color}aL[#aL+1]={x1=i,y1=C,z1=aH,x2=F,y2=C,z2=aE,x3=dR[(c0+1)%dP.res].x,y3=dR[(c0+1)%dP.res].y,z3=dR[(c0+1)%dP.res].z,c=dP.color2 or dP.color}end;dS[c0]={x=F,y=C,z=aE}end;dR=dS end;if dP.colors or dP.top or dP.bottom then for d=1,#aL do local b5=aL[d]local ay=(b5.y1+b5.y2+b5.y3)/3;if dP.colors then local dU=o((-ay+0.5)*#dP.colors+1)b5.c=dP.colors[dU]or b5.c else if ay>=0 then b5.c=dP.top or b5.c else b5.c=dP.bottom or b5.c end end end end;for bJ,bK in pairs(aZ)do aL[bJ]=bK end;return aL end;function dN:icosphere(dP)dP.res=dP.res or 1;local dV=(1+ca(5))/2;local dW={{dV,1,0},{dV,-1,0},{-dV,-1,0},{-dV,1,0},{1,0,dV},{-1,0,dV},{-1,0,-dV},{1,0,-dV},{0,dV,1},{0,dV,-1},{0,-dV,-1},{0,-dV,1}}local function dX(bi,bj,bk)return dO(dW[bi][1],dW[bi][2],dW[bi][3],dW[bj][1],dW[bj][2],dW[bj][3],dW[bk][1],dW[bk][2],dW[bk][3],dP.colors and 1 or dP.color)end;local aL={dX(11,2,12),dX(11,8,2),dX(11,7,8),dX(11,3,7),dX(11,12,3),dX(4,7,3),dX(4,10,7),dX(4,9,10),dX(4,6,9),dX(4,3,6),dX(5,6,12),dX(5,9,6),dX(5,1,9),dX(5,2,1),dX(5,12,2),dX(3,12,6),dX(1,8,10),dX(1,10,9),dX(1,2,8),dX(10,8,7)}local function dY()local bH={}for d=1,#aL do local b5=aL[d]local dZ={x=(b5.x1+b5.x2)/2,y=(b5.y1+b5.y2)/2,z=(b5.z1+b5.z2)/2}local d_={x=(b5.x1+b5.x3)/2,y=(b5.y1+b5.y3)/2,z=(b5.z1+b5.z3)/2}local e0={x=(b5.x2+b5.x3)/2,y=(b5.y2+b5.y3)/2,z=(b5.z2+b5.z3)/2}local e1=b5.c;if dP.colorsFractal then e1=e1%#dP.colors+1 end;bH[#bH+1]=dO(dZ.x,dZ.y,dZ.z,e0.x,e0.y,e0.z,d_.x,d_.y,d_.z,b5.c)bH[#bH+1]=dO(b5.x1,b5.y1,b5.z1,dZ.x,dZ.y,dZ.z,d_.x,d_.y,d_.z,e1)bH[#bH+1]=dO(dZ.x,dZ.y,dZ.z,b5.x2,b5.y2,b5.z2,e0.x,e0.y,e0.z,e1)bH[#bH+1]=dO(d_.x,d_.y,d_.z,e0.x,e0.y,e0.z,b5.x3,b5.y3,b5.z3,e1)end;aL=bH end;for d=1,dP.res-1 do dY()end;local function e2(F,C,aE)local e3=math.sqrt(F*F+C*C+aE*aE)local e4=0.5/e3;return F*e4,C*e4,aE*e4 end;for d=1,#aL do local b5=aL[d]b5.x1,b5.y1,b5.z1=e2(b5.x1,b5.y1,b5.z1)b5.x2,b5.y2,b5.z2=e2(b5.x2,b5.y2,b5.z2)b5.x3,b5.y3,b5.z3=e2(b5.x3,b5.y3,b5.z3)if not dP.colorsFractal then local ay=(b5.y1+b5.y2+b5.y3)/3;if dP.colors then local dU=math.floor((-ay+0.5)*#dP.colors+1)b5.c=dP.colors[dU]or b5.c else if ay>=0 then b5.c=dP.top or b5.c else b5.c=dP.bottom or b5.c end end else b5.c=dP.colors[b5.c]end end;for bJ,bK in pairs(aZ)do aL[bJ]=bK end;return aL end;function dN:plane(dP)dP.color=dP.color or colors.lime;dP.size=dP.size or 1;dP.y=dP.y or 0;local e5={dO(-1*dP.size,dP.y,1*dP.size,1*dP.size,dP.y,-1*dP.size,-1*dP.size,dP.y,-1*dP.size,dP.color),dO(-1*dP.size,dP.y,1*dP.size,1*dP.size,dP.y,1*dP.size,1*dP.size,dP.y,-1*dP.size,dP.color)}for bJ,bK in pairs(aZ)do e5[bJ]=bK end;return e5 end;function dN:mountains(dP)dP.res=dP.res or 20;dP.randomOffset=dP.randomOffset or 0;dP.height=dP.height or 1;dP.randomHeight=dP.randomHeight or 0;dP.y=dP.y or 0;dP.scale=dP.scale or 100;dP.color=dP.color or colors.green;dP.snowColor=dP.snowColor or colors.white;local e6=3/dP.res*dP.height/(dP.randomHeight+1)local e7=3/dP.res*dP.height*(dP.randomHeight+1)local aL={}for d=0,dP.res do local e8=math.random(-dP.randomOffset*100,dP.randomOffset*100)/100;local e9=d+e8;local g=aC((e9-1)/dP.res*cj*2)*dP.scale;local aX=aB((e9-1)/dP.res*cj*2)*dP.scale;local i=aC((e9-0.5)/dP.res*cj*2)*dP.scale;local aH=aB((e9-0.5)/dP.res*cj*2)*dP.scale;local Y=aC(e9/dP.res*cj*2)*dP.scale;local aY=aB(e9/dP.res*cj*2)*dP.scale;local ea=math.random(e6*100,e7*100)/100*dP.scale;local aw={x1=g,y1=dP.y,z1=aX,x2=Y,y2=dP.y,z2=aY,x3=i,y3=dP.y+ea,z3=aH,c=dP.color,forceRender=true}aL[#aL+1]=aw;if dP.snow then local eb=0.93;local ec=dP.snowHeight or 0.5;local ed=1-ec*e7/(ea/dP.scale)ed=n(0,m(1,ed))if ed>0.2 then local ee={x1=(g*ed+i*(1-ed))*eb,y1=dP.y+ea*(1-ed),z1=(aX*ed+aH*(1-ed))*eb,x2=(Y*ed+i*(1-ed))*eb,y2=dP.y+ea*(1-ed),z2=(aY*ed+aH*(1-ed))*eb,x3=i*eb,y3=dP.y+ea,z3=aH*eb,c=dP.snowColor,forceRender=true}aL[#aL+1]=ee end end end;for bJ,bK in pairs(aZ)do aL[bJ]=bK end;return aL end;return{newFrame=cl,loadModel=bL,newBuffer=q,linear=f,models=dN}