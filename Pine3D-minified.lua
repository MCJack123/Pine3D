local a=(...):match("(.-)[^%.]+$")local b=require(a.."betterblittle")local c={}for d=1,16 do c[2^(d-1)]=("0123456789abcdef"):sub(d,d)end;local e=math.pow(10,99)local function f(g,h,i,j)local k=i-g;if k==0 then return e,-e*g end;local l=(j-h)/k;return l,h-l*g end;local m=math.min;local n=math.max;local o=math.floor;local p=math.ceil;local function q(g,h,i,j)local r={x1=g,y1=h,x2=i,y2=j,width=i-g+1,height=j-h+1,screenBuffer={{}},blittleWindow=nil,blittleOn=false,backgroundColor=colors.lightBlue}function r:setBufferSize(g,h,i,j)self.x1=g;self.y1=h;self.x2=i;self.y2=j;self.width=i-g+1;self.height=j-h+1;if self.blittleWindow then self.blittleWindow=self.blittleWindow.reposition(self.x1,self.y1,self.x1+self.width-1,self.y1+self.height-1)end;self:clear()end;function r:clear()local s=self.screenBuffer;s.c2={}local t=s.c2;local u=self.width;local v=self.backgroundColor;if self.blittleOn then for w=1,self.height do t[w]={}local x=t[w]for y=1,u do x[y]=v end end else local z=c[v]s.c1={}local A=s.c1;s.chars={}local B=s.chars;for w=1,self.height do A[w]={}t[w]={}B[w]={}local C=A[w]local x=t[w]local D=B[w]for y=1,u do C[y]=z;x[y]=z;D[y]=" "end end end end;function r:fastClearNormal()local E=self.backgroundColor;local s=self.screenBuffer;local B=s.chars;local A=s.c1;local t=s.c2;local E=c[E]local u=self.width;for w=1,self.height do local D=B[w]local C=A[w]local x=t[w]for y=1,u do D[y]=" "C[y]=E;x[y]=E end end end;function r:fastClearBLittle()local E=self.backgroundColor;local t=self.screenBuffer.c2;local u=self.width;for w=1,self.height do local x=t[w]for y=1,u do x[y]=E end end end;function r:setPixel(y,w,A,t,F)local y=math.floor(y+0.5)local w=math.floor(w+0.5)if y>=1 and y<=self.width then if w>=1 and w<=self.height then local s=self.screenBuffer;if self.blittleOn then s.c2[w][y]=t or A else s.c1[w][y]=c[A]s.c2[w][y]=c[t or A]s.chars[w][y]=" "end end end end;function r:image(k,G,H)for w,I in pairs(H)do for y,J in pairs(I)do if J and J>0 then if self.blittleOn then self:setPixel(y+(k-1)*2,w+(G-1)*3,J,J," ")else self:setPixel(y+k-1,w+G-1,J,J," ")end end end end end;function r:loadLineNormal(g,h,i,j,E,F,K,l,L)local s=self.screenBuffer;local A=s.c1;local t=s.c2;local B=s.chars;local M=self.width;local N=self.height;if i>=g then for y=n(p(g),1),m(o(i),M)do local w=o(l*y+L+0.5)if w>0 and w<=N then A[w][y]=K;t[w][y]=E;B[w][y]=F end end else for y=n(p(i),1),m(o(g),M)do local w=o(l*y+L+0.5)if w>0 and w<=N then A[w][y]=K;t[w][y]=E;B[w][y]=F end end end;if j>=h then for w=n(p(h),1),m(o(j),N)do local y=o((w-L)/l+0.5)if y>0 and y<=M then A[w][y]=K;t[w][y]=E;B[w][y]=F end end else for w=n(p(j),1),m(o(h),N)do local y=o((w-L)/l+0.5)if y>0 and y<=M then A[w][y]=K;t[w][y]=E;B[w][y]=F end end end end;function r:loadLineBLittle(g,h,i,j,E,l,L)local s=self.screenBuffer;local t=s.c2;local M=self.width;local N=self.height;if i>=g then for y=n(p(g),1),m(o(i),M)do local w=o(l*y+L+0.5)if w>0 and w<=N then t[w][y]=E end end else for y=n(p(i),1),m(o(g),M)do local w=o(l*y+L+0.5)if w>0 and w<=N then t[w][y]=E end end end;if j>=h then for w=n(p(h),1),m(o(j),N)do local y=o((w-L)/l+0.5)if y>0 and y<=M then t[w][y]=E end end else for w=n(p(j),1),m(o(h),N)do local y=o((w-L)/l+0.5)if y>0 and y<=M then t[w][y]=E end end end end;local O=colors.black;function r:drawTriangleNormal(g,h,i,j,P,Q,E,F,K,R)if g<1 and i<1 and P<1 or h<1 and j<1 and Q<1 then return end;local M=self.width;if g>M and i>M and P>M then return end;local N=self.height;if h>N and j>N and Q>N then return end;if h>j then h,j=j,h;g,i=i,g end;if j>Q then Q,j=j,Q;P,i=i,P end;if h>j then h,j=j,h;g,i=i,g end;local s=self.screenBuffer;local o,p=o,p;local m,n=m,n;local S=m(n(1,p(h)),N)local T=m(n(0,o(j)),N)local U=m(n(1,o(Q)),N)local A=s.c1;local t=s.c2;local B=s.chars;local V=(i-g)/(j-h)local W=(g-P)/(h-Q)F=F or" "K=K or E;local E=c[E]local K=c[K]for w=S,T do local C=A[w]local x=t[w]local D=B[w]local X=(w-h)*V+g;local Y=(w-Q)*W+P;if Y<X then X,Y=Y,X end;if X<1 then X=1 end;if X>M then X=M end;if Y<1 then Y=1 end;if Y>M then Y=M end;for y=o(X+0.5),o(Y+0.5)do C[y]=K;x[y]=E;D[y]=F end end;local Z=(P-i)/(Q-j)local W=(g-P)/(h-Q)for w=T+1,U do local C=A[w]local x=t[w]local D=B[w]local X=(w-j)*Z+i;local Y=(w-Q)*W+P;if Y<X then X,Y=Y,X end;if X<1 then X=1 end;if X>M then X=M end;if Y<1 then Y=1 end;if Y>M then Y=M end;for y=o(X+0.5),o(Y+0.5)do C[y]=K;x[y]=E;D[y]=F end end;local R=R;if R or self.triangleEdges then local _,a0=f(g,h,i,j)local a1,a2=f(i,j,P,Q)local a3,a4=f(g,h,P,Q)local a5=self.loadLineNormal;local E=c[R or O]a5(self,g,h,i,j,E,F,K,_,a0)a5(self,i,j,P,Q,E,F,K,a1,a2)a5(self,P,Q,g,h,E,F,K,a3,a4)end end;function r:drawTriangleBLittle(g,h,i,j,P,Q,E,F,K,R)if g<1 and i<1 and P<1 or h<1 and j<1 and Q<1 then return end;local M=self.width;if g>M and i>M and P>M then return end;local N=self.height;if h>N and j>N and Q>N then return end;if h>j then h,j=j,h;g,i=i,g end;if j>Q then Q,j=j,Q;P,i=i,P end;if h>j then h,j=j,h;g,i=i,g end;local s=self.screenBuffer;local o,p=o,p;local m,n=m,n;local S=m(n(1,p(h)),N)local T=m(n(0,o(j)),N)local U=m(n(1,o(Q)),N)local t=s.c2;local V=(i-g)/(j-h)local W=(g-P)/(h-Q)for w=S,T do local x=t[w]local X=(w-h)*V+g;local Y=(w-Q)*W+P;if Y<X then X,Y=Y,X end;if X<1 then X=1 end;if X>M then X=M end;if Y<1 then Y=1 end;if Y>M then Y=M end;for y=o(X+0.5),o(Y+0.5)do x[y]=E end end;local Z=(P-i)/(Q-j)local W=(g-P)/(h-Q)for w=T+1,U do local x=t[w]local X=(w-j)*Z+i;local Y=(w-Q)*W+P;if Y<X then X,Y=Y,X end;if X<1 then X=1 end;if X>M then X=M end;if Y<1 then Y=1 end;if Y>M then Y=M end;for y=o(X+0.5),o(Y+0.5)do x[y]=E end end;local R=R;if R or self.triangleEdges then local _,a0=f(g,h,i,j)local a1,a2=f(i,j,P,Q)local a3,a4=f(g,h,P,Q)local a5=self.loadLineBLittle;local E=R or O;a5(self,g,h,i,j,E,_,a0)a5(self,i,j,P,Q,E,a1,a2)a5(self,P,Q,g,h,E,a3,a4)end end;function r:drawBufferNormal()local g=self.x1;local h=self.y1;local s=self.screenBuffer;local a6=term.setCursorPos;local a7=term.blit;local B=s.chars;local A=s.c1;local t=s.c2;local a8=table.concat;for w=1,self.height do a6(g,w+h-1)local B=a8(B[w])local A=a8(A[w])local t=a8(t[w])a7(B,A,t)end end;function r:drawBufferBLittle()local a9=self.blittleWindow;if not a9 then self.blittleWindow=window.create(term.current(),self.x1,self.y1,self.x1+self.width-1,self.y1+self.height-1,false)a9=self.blittleWindow end;b.drawBuffer(self.screenBuffer.c2,a9)a9.setVisible(true)a9.setVisible(false)end;function r:highResMode(aa)self.blittleOn=aa;self.drawTriangle=aa and self.drawTriangleBLittle or self.drawTriangleNormal;self.fastClear=aa and self.fastClearBLittle or self.fastClearNormal;self.drawBuffer=aa and self.drawBufferBLittle or self.drawBufferNormal;self:clear()end;function r:useTriangleEdges(aa)self.triangleEdges=aa end;r:highResMode(true)return r end;local ab=math.sqrt;local ac=table.sort;function swapPoly16(l,L,table)if table[l]==nil or table[L]==nil then return false end;if table[l][16]<table[L][16]then table[l],table[L]=table[L],table[l]return true end;return false end;function bubblesort16(ad)for d=1,#ad do local ae=d;while swapPoly16(ae,ae+1,ad)do ae=ae-1 end end end;local function af(ad)local ag=#ad;local ah=0;local ai=ad[1][16]for d=2,ag do local aj=ad[d][16]if aj<=ai then ah=ah+1 end;ai=aj end;local ak=ah/(ag-1)return ak end;local l=8;local function L(E)local al=0;while E>=l do al=bit.bor(al,bit.band(E,1))E=bit.brshift(E,1)end;return E+al end;local function am(an,ao,ap)for d=ao+1,ap do local aq=an[d]local ar=aq[16]local as=d-1;while as>=ao and an[as][16]>ar do an[as+1]=an[as]as=as-1 end;an[as+1]=aq end end;local function at(an,ao,ap,ag,au,al)local av=au-ag+1;local aw=al-au;for ax=0,av-1 do ao[ax]=an[ag+ax]end;for ax=0,aw-1 do ap[ax]=an[au+1+ax]end;local d=0;local as=0;local ay=ag;while d<av and as<aw do if ao[d][16]<=ap[as][16]then an[ay]=ao[d]d=d+1 else an[ay]=ap[as]as=as+1 end;ay=ay+1 end;while d<av do an[ay]=ao[d]ay=ay+1;d=d+1 end;while as<aw do an[ay]=ap[as]ay=ay+1;as=as+1 end end;function timsort16(an)local E=#an;local az=L(l)local aA=math.min;for d=1,E,az do am(an,d,aA(d+l-1,E))end;local aB,aC={},{}local y=az;while y<=E do for ao=1,E,2*y do local w=ao+y-1;local ap=aA(w+y,E)if w<ap then at(an,aB,aC,ao,w,ap)end end;y=2*y end;for d=1,math.floor(E/2)do an[d],an[E-d+1]=an[E-d+1],an[d]end end;local function aD(aE,aF,aG,aH,aI)local aJ=aI[1]local aK=aI[2]local aL=aI[3]local aM=aF and aF-aJ or 0;local aN=aG and aG-aK or 0;local aO=aH and aH-aL or 0;for d=1,#aE do local aP=aE[d]local aQ=aM+(aP[1]+aP[4]+aP[7])/3;local aR=aN+(aP[2]+aP[5]+aP[8])/3;local aS=aO+(aP[3]+aP[6]+aP[9])/3;aP[16]=aQ*aQ+aR*aR+aS*aS end;local ak=af(aE)if ak==1 then elseif ak>0.7 then bubblesort16(aE)else timsort16(aE)end end;local aT=math.rad;local aU=math.sin;local aV=math.cos;local aW=math.atan2;local function aX(y,w,aY,aZ,a_)local b0=a_*aY-aZ*w;local w=aZ*aY+a_*w;local aY=b0;return y,w,aY end;local function b1(y,w,aY,aZ,a_)local b0=a_*aY-aZ*y;local y=aZ*aY+a_*y;local aY=b0;return y,w,aY end;local function b2(y,w,aY,aZ,a_)local j=a_*w-aZ*y;local y=aZ*w+a_*y;local w=j;return y,w end;local function b3(b4,b5,b6,b7)local b8,b9=0,1;local ba,bb=0,1;local bc,bd=0,1;if b5==0 then b5=nil end;if b5 then b8,b9=aU(b5),aV(b5)end;if b6==0 then b6=nil end;if b6 then ba,bb=aU(b6),aV(b6)end;if b7==0 then b7=nil end;if b7 then bc,bd=aU(b7),aV(b7)end;local be={}for bf,aP in pairs(b4)do local g,h,bg=aP[1],aP[2],aP[3]local i,j,b0=aP[4],aP[5],aP[6]local P,Q,bh=aP[7],aP[8],aP[9]if b6 then g,h,bg=b1(g,h,bg,ba,bb)i,j,b0=b1(i,j,b0,ba,bb)P,Q,bh=b1(P,Q,bh,ba,bb)end;if b7 then g,h=b2(g,h,bg,bc,bd)i,j=b2(i,j,b0,bc,bd)P,Q=b2(P,Q,bh,bc,bd)end;if b5 then g,h,bg=aX(g,h,bg,b8,b9)i,j,b0=aX(i,j,b0,b8,b9)P,Q,bh=aX(P,Q,bh,b8,b9)end;be[#be+1]={g,h,bg,i,j,b0,P,Q,bh}be[#be][10]=aP[10]be[#be][11]=aP[11]be[#be][12]=aP[12]be[#be][13]=aP[13]be[#be][14]=aP[14]be[#be][15]=aP[15]end;return be end;local l=8;local function L(E)local al=0;while E>=l do al=bit.bor(al,bit.band(E,1))E=bit.brshift(E,1)end;return E+al end;local function am(an,ao,ap)for d=ao+1,ap do local aq=an[d]local ar=aq[9]local as=d-1;while as>=ao and an[as][9]>ar do an[as+1]=an[as]as=as-1 end;an[as+1]=aq end end;local function at(an,ao,ap,ag,au,al)local av=au-ag+1;local aw=al-au;for ax=0,av-1 do ao[ax]=an[ag+ax]end;for ax=0,aw-1 do ap[ax]=an[au+1+ax]end;local d=0;local as=0;local ay=ag;while d<av and as<aw do if ao[d][9]<=ap[as][9]then an[ay]=ao[d]d=d+1 else an[ay]=ap[as]as=as+1 end;ay=ay+1 end;while d<av do an[ay]=ao[d]ay=ay+1;d=d+1 end;while as<aw do an[ay]=ap[as]ay=ay+1;as=as+1 end end;function timsort9(an)local E=#an;local az=L(l)local aA=math.min;for d=1,E,az do am(an,d,aA(d+l-1,E))end;local aB,aC={},{}local y=az;while y<=E do for ao=1,E,2*y do local w=ao+y-1;local ap=aA(w+y,E)if w<ap then at(an,aB,aC,ao,w,ap)end end;y=2*y end;for d=1,math.floor(E/2)do an[d],an[E-d+1]=an[E-d+1],an[d]end end;function swap9(l,L,table)if table[l]==nil or table[L]==nil then return false end;if table[l][9]<table[L][9]then table[l],table[L]=table[L],table[l]return true end;return false end;function bubblesort9(ad)for d=1,#ad do local ae=d;while swap9(ae,ae+1,ad)do ae=ae-1 end end end;local function bi(ad)local ag=#ad;local ah=0;local ai=ad[1][9]for d=2,ag do local aj=ad[d][9]if aj<=ai then ah=ah+1 end;ai=aj end;local ak=ah/(ag-1)return ak end;local function bj(bk,aI)local bl=aI[1]local bm=aI[2]local bn=aI[3]for d=1,#bk do local bo=bk[d]local bp=bo[1]local bq=bo[2]local br=bo[3]local bs=bp and bp-bl or 0;local bt=bq and bq-bm or 0;local bu=br and br-bn or 0;bo[9]=bs*bs+bt*bt+bu*bu end;local ak=bi(bk)if ak==1 then elseif ak>0.7 then bubblesort9(bk)else ac(bk,function(l,L)return l[9]>L[9]end)end end;local function bv(bw)local bx=fs.open(bw,"r")if not bx then error("Could not find model for an object at path: "..bw)end;local by=bx.readAll()bx.close()return textutils.unserialise(by)end;local bz=math.pi;local aU=math.sin;local aV=math.cos;local bA=math.tan;local ab=math.sqrt;local function bB(g,h,i,j)local u,bC=term.getSize()if g and i then u=i-g+1 end;if h and j then bC=j-h+1 end;local g=g or 1;local h=h or 1;local i=i or u-g+1;local j=j or bC-h+1;local bD={camera={0.000001,0.000001,0.000001,nil,0,0},buffer=q(g,h,i,j),x1=g,y1=h,x2=i,y2=j,width=u,height=bC,blittleOn=false,pixelratio=1.5}bD.FoV=90;bD.camera[7]=aT(bD.FoV)bD.t=bA(aT(bD.FoV/2))*2*0.0001;function bD:setBackgroundColor(E)local bE=self.buffer;bE.backgroundColor=E;bE:fastClear()end;function bD:setSize(g,h,i,j)self.x1=g;self.y1=h;self.x2=i;self.y2=j;if not self.blittleOn then self.buffer:setBufferSize(g,h,i,j)self.width=i-g+1;self.height=j-h+1;self.pixelratio=1.5 else self.width=(i-g+1)*2;self.height=(j-h+1)*3;self.pixelratio=1;self.buffer:setBufferSize(g,h,g+self.width-1,h+self.height-1)end;self:updateMappingConstants()end;function bD:highResMode(aa)self.blittleOn=aa;self.buffer:highResMode(aa)if aa then self.width=(self.x2-self.x1+1)*2;self.height=(self.y2-self.y1+1)*3;self.buffer:setBufferSize(self.x1,self.y1,self.x1+self.width-1,self.y1+self.height-1)self.pixelratio=1 else self.buffer:setBufferSize(self.x1,self.y1,self.x2,self.y2)self.width=self.x2-self.x1+1;self.height=self.y2-self.y1+1;self.pixelratio=1.5 end;self:updateMappingConstants()end;function bD:loadModelRaw(b4)local bF={}local bG=0;for d=1,#b4 do local aP=b4[d]bF[#bF+1]={}bF[#bF][1]=aP.x1;bF[#bF][2]=aP.y1;bF[#bF][3]=aP.z1;bF[#bF][4]=aP.x2;bF[#bF][5]=aP.y2;bF[#bF][6]=aP.z2;bF[#bF][7]=aP.x3;bF[#bF][8]=aP.y3;bF[#bF][9]=aP.z3;bF[#bF][10]=aP.forceRender;bF[#bF][11]=aP.c;bF[#bF][12]=aP.char;bF[#bF][13]=aP.charc;bF[#bF][14]=aP.outlineColor;bF[#bF][15]=d;local bH=ab(aP.x1*aP.x1+aP.y1*aP.y1+aP.z1*aP.z1)local bI=ab(aP.x2*aP.x2+aP.y2*aP.y2+aP.z2*aP.z2)local bJ=ab(aP.x3*aP.x3+aP.y3*aP.y3+aP.z3*aP.z3)if bH>bG then bG=bH end;if bI>bG then bG=bI end;if bJ>bG then bG=bJ end end;return bF,bG end;function bD:updateMappingConstants()self.renderOffsetX=o(self.width*0.5)+1;self.renderOffsetY=o(self.height*0.5)self.sXFactor=0.0001*self.width/self.t;self.sYFactor=-0.0001*self.width/(self.t*self.height*self.pixelratio)*self.height end;function bD:map3dTo2d(y,w,aY)local aI=self.camera;local bK=aU(aI[4]or 0)local bL=aV(aI[4]or 0)local bM=aU(-aI[5])local bN=aV(-aI[5])local bO=aU(aI[6])local bP=aV(aI[6])local bs=y-aI[1]local bt=w-aI[2]local bu=aY-aI[3]local bQ=bN*bs-bM*bu;bu=bM*bs+bN*bu;bs=bQ;local bR=bP*bt-bO*bs;bs=bO*bt+bP*bs;bt=bR;if bK~=0 then local bS=bK*bu-bL*bt;bt=bL*bu+bK*bt;bu=bS end;local bT=bu/bs*self.sXFactor+self.renderOffsetX;local bU=bt/bs*self.sYFactor+self.renderOffsetY;return bT,bU,bs>=0.0001 end;function bD:drawObject(bo,aI,bV)local bp=bo[1]local bq=bo[2]local br=bo[3]local bK=bV[1]local bL=bV[2]local bM=bV[3]local bN=bV[4]local bO=bV[5]local bP=bV[6]local bW=bp and bp-aI[1]or 0;local bX=bq and bq-aI[2]or 0;local bY=br and br-aI[3]or 0;local b4=bo[7]if#b4<=0 then return end;local bZ=bo[8]local bs=bW;local bt=bX;local bu=bY;local bQ=bN*bs-bM*bu;local bu=bM*bs+bN*bu;local bs=bQ;local bs=bO*bt+bP*bs;if bs<-bZ then return end;local b_=0.5*aI[7]local c0=aU(b_)local c1=aV(b_)if(bs+bZ)*c0+(bu+bZ)*c1<0 then return end;if(bs+bZ)*c0-(bu-bZ)*c1<0 then return end;local b5=bo[4]local b6=bo[5]local b7=bo[6]if b5 and b5~=0 or b6 and b6~=0 or b7 and b7~=0 then b4=b3(b4,b5,b6,b7)end;aD(b4,bp,bq,br,aI)local c2=bW*bW+bX*bX+bY*bY<bZ*bZ*4;local c3=self.renderOffsetX;local c4=self.renderOffsetY;local c5=self.sXFactor;local c6=self.sYFactor;local bK=bK;local bL=bL;local bM=bM;local bN=bN;local bO=bO;local bP=bP;local bW=bW;local bX=bX;local bY=bY;local function c7(bs,bt,bu)local bQ=bN*bs-bM*bu;bu=bM*bs+bN*bu;bs=bQ;local bR=bP*bt-bO*bs;bs=bO*bt+bP*bs;bt=bR;local bT=bu/bs*c5+c3;local bU=bt/bs*c6+c4;return bT,bU,bs end;if bK~=0 then function c7(bs,bt,bu)local bQ=bN*bs-bM*bu;bu=bM*bs+bN*bu;bs=bQ;local bR=bP*bt-bO*bs;bs=bO*bt+bP*bs;bt=bR;local bS=bK*bu-bL*bt;bt=bL*bu+bK*bt;bu=bS;local bT=bu/bs*c5+c3;local bU=bt/bs*c6+c4;return bT,bU,bs end end;local c8=b4;local bE=self.buffer;for d=1,#c8 do local aP=c8[d]local g,h,c9=c7(aP[1]+bW,aP[2]+bX,aP[3]+bY)if c9>0.00010000001 then local i,j,bQ=c7(aP[4]+bW,aP[5]+bX,aP[6]+bY)if bQ>0.00010000001 then local P,Q,ca=c7(aP[7]+bW,aP[8]+bX,aP[9]+bY)if ca>0.00010000001 then if aP[10]or(i-g)*(Q-j)-(j-h)*(P-i)<0 then bE:drawTriangle(g,h,i,j,P,Q,aP[11],aP[12],aP[13],aP[14])end elseif c2 then local function cb(y,w,aY)local bs=y+bW;local bt=w+bX;local bu=aY+bY;local bQ=bN*bs-bM*bu;bu=bM*bs+bN*bu;bs=bQ;local bR=bP*bt-bO*bs;bs=bO*bt+bP*bs;bt=bR;if bK~=0 then local bS=bK*bu-bL*bt;bt=bL*bu+bK*bt;bu=bS end;local bT=bu/bs*c5+c3;local bU=bt/bs*c6+c4;return bT,bU,bs,bt,bu end;local g,h,c9,cc,cd=cb(aP[1],aP[2],aP[3])local i,j,bQ,bR,bS=cb(aP[4],aP[5],aP[6])local P,Q,ca,ce,cf=cb(aP[7],aP[8],aP[9])local cg=math.abs;local ch=cg(ca-0.0001)local ci=cg(c9-0.0001)local cj=ci+ch;local ck=(cf*ci+cd*ch)/cj;local cl=(ce*ci+cc*ch)/cj;local c3,c5,c4,c6=c3,c5,c4,c6;local cm=ck*10000*c5+c3;local cn=cl*10000*c6+c4;if aP[10]or(i-g)*(cn-j)-(j-h)*(cm-i)<0 then bE:drawTriangle(g,h,i,j,cm,cn,aP[11],aP[12],aP[13],aP[14])local co=cg(bQ-0.0001)local cj=co+ch;local ck=(bS*ch+cf*co)/cj;local cl=(bR*ch+ce*co)/cj;local cp=ck*10000*c5+c3;local cq=cl*10000*c6+c4;bE:drawTriangle(cp,cq,i,j,cm,cn,aP[11],aP[12],aP[13],aP[14])end end elseif c2 then local function cb(y,w,aY)local bs=y+bW;local bt=w+bX;local bu=aY+bY;local bQ=bN*bs-bM*bu;bu=bM*bs+bN*bu;bs=bQ;local bR=bP*bt-bO*bs;bs=bO*bt+bP*bs;bt=bR;if bK~=0 then local bS=bK*bu-bL*bt;bt=bL*bu+bK*bt;bu=bS end;local bT=bu/bs*c5+c3;local bU=bt/bs*c6+c4;return bT,bU,bs,bt,bu end;local g,h,c9,cc,cd=cb(aP[1],aP[2],aP[3])local i,j,bQ,bR,bS=cb(aP[4],aP[5],aP[6])local P,Q,ca,ce,cf=cb(aP[7],aP[8],aP[9])local cg=math.abs;if ca>0.00010000001 then local co=cg(bQ-0.0001)local ci=cg(c9-0.0001)local cj=ci+co;local ck=(bS*ci+cd*co)/cj;local cl=(bR*ci+cc*co)/cj;local c3,c5,c4,c6=c3,c5,c4,c6;local cm=ck*10000*c5+c3;local cn=cl*10000*c6+c4;if aP[10]or(cm-g)*(Q-cn)-(cn-h)*(P-cm)<0 then bE:drawTriangle(g,h,cm,cn,P,Q,aP[11],aP[12],aP[13],aP[14])local ch=cg(ca-0.0001)local cj=co+ch;local ck=(bS*ch+cf*co)/cj;local cl=(bR*ch+ce*co)/cj;local cp=ck*10000*c5+c3;local cq=cl*10000*c6+c4;bE:drawTriangle(cp,cq,cm,cn,P,Q,aP[11],aP[12],aP[13],aP[14])end else local ci=cg(c9-0.0001)local co=cg(bQ-0.0001)local ch=cg(ca-0.0001)local cr=ci+co;local cs=ci+ch;local ck=(cd*co+bS*ci)/cr;local cl=(cc*co+bR*ci)/cr;local c3,c5,c4,c6=c3,c5,c4,c6;local cm=ck*10000*c5+c3;local cn=cl*10000*c6+c4;local ct=(cd*ch+cf*ci)/cs;local cu=(cc*ch+ce*ci)/cs;local cp=ct*10000*c5+c3;local cq=cu*10000*c6+c4;if aP[10]or(cm-g)*(cq-cn)-(cn-h)*(cp-cm)<0 then bE:drawTriangle(g,h,cm,cn,cp,cq,aP[11],aP[12],aP[13],aP[14])end end end elseif c2 then local function cb(y,w,aY)local bs=y+bW;local bt=w+bX;local bu=aY+bY;local bQ=bN*bs-bM*bu;bu=bM*bs+bN*bu;bs=bQ;local bR=bP*bt-bO*bs;bs=bO*bt+bP*bs;bt=bR;if bK~=0 then local bS=bK*bu-bL*bt;bt=bL*bu+bK*bt;bu=bS end;local bT=bu/bs*c5+c3;local bU=bt/bs*c6+c4;return bT,bU,bs,bt,bu end;local g,h,c9,cc,cd=cb(aP[1],aP[2],aP[3])local i,j,bQ,bR,bS=cb(aP[4],aP[5],aP[6])local P,Q,ca,ce,cf=cb(aP[7],aP[8],aP[9])local cg=math.abs;if bQ>0.00010000001 then if ca>0.00010000001 then local ci=cg(c9-0.0001)local co=cg(bQ-0.0001)local cj=ci+co;local ck=(cd*co+bS*ci)/cj;local cl=(cc*co+bR*ci)/cj;local c3,c5,c4,c6=c3,c5,c4,c6;local cm=ck*10000*c5+c3;local cn=cl*10000*c6+c4;if aP[10]or(i-cm)*(Q-j)-(j-cn)*(P-i)<0 then bE:drawTriangle(cm,cn,i,j,P,Q,aP[11],aP[12],aP[13],aP[14])local ch=cg(ca-0.0001)local cj=ci+ch;local ck=(cd*ch+cf*ci)/cj;local cl=(cc*ch+ce*ci)/cj;local cp=ck*10000*c5+c3;local cq=cl*10000*c6+c4;bE:drawTriangle(cm,cn,cp,cq,P,Q,aP[11],aP[12],aP[13],aP[14])end else local ci=cg(c9-0.0001)local co=cg(bQ-0.0001)local ch=cg(ca-0.0001)local cr=co+ci;local cs=co+ch;local ck=(cd*co+bS*ci)/cr;local cl=(cc*co+bR*ci)/cr;local c3,c5,c4,c6=c3,c5,c4,c6;local cm=ck*10000*c5+c3;local cn=cl*10000*c6+c4;local ct=(bS*ch+cf*co)/cs;local cu=(bR*ch+ce*co)/cs;local cp=ct*10000*c5+c3;local cq=cu*10000*c6+c4;if aP[10]or(i-cm)*(cq-j)-(j-cn)*(cp-i)<0 then bE:drawTriangle(cm,cn,i,j,cp,cq,aP[11],aP[12],aP[13],aP[14])end end else if ca>0.00010000001 then local ci=cg(c9-0.0001)local co=cg(bQ-0.0001)local ch=cg(ca-0.0001)local cr=ch+ci;local cs=ch+co;local ck=(cd*ch+cf*ci)/cr;local cl=(cc*ch+ce*ci)/cr;local c3,c5,c4,c6=c3,c5,c4,c6;local cm=ck*10000*c5+c3;local cn=cl*10000*c6+c4;local ct=(bS*ch+cf*co)/cs;local cu=(bR*ch+ce*co)/cs;local cp=ct*10000*c5+c3;local cq=cu*10000*c6+c4;if aP[10]or(cp-cm)*(Q-cq)-(cq-cn)*(P-cp)<0 then bE:drawTriangle(cm,cn,cp,cq,P,Q,aP[11],aP[12],aP[13],aP[14])end end end end end end;function bD:drawObjects(bk)local aI=self.camera;local bV={aU(aI[4]or 0),aV(aI[4]or 0),aU(-aI[5]),aV(-aI[5]),aU(aI[6]),aV(aI[6])}bj(bk,aI)local bk=bk;for d=1,#bk do self:drawObject(bk[d],aI,bV)end end;function bD:drawBuffer()local bE=self.buffer;bE:drawBuffer()bE:fastClear()end;function bD:setCamera(cv,cw,cx,b5,b6,b7)local aT=math.rad;if type(cv)=="table"then local aI=cv;self.camera={aI.x or self.camera[1]or 0,aI.y or self.camera[2]or 0,aI.z or self.camera[3]or 0,aI.rotX and aT(aI.rotX+90)or self.camera[4]or 0,aI.rotY and aT(aI.rotY)or self.camera[5]or 0,aI.rotZ and aT(aI.rotZ)or self.camera[6]or 0,self.camera[7]}else self.camera={cv or self.camera[1]or 0,cw or self.camera[2]or 0,cx or self.camera[3]or 0,b5 and aT(b5+90)or self.camera[4]or 0,b6 and aT(b6)or self.camera[5]or 0,b7 and aT(b7)or self.camera[6]or 0,self.camera[7]}end;if self.camera[4]==math.pi*0.5 then self.camera[4]=nil end end;function bD:setFoV(b_)self.FoV=b_ or 90;self.t=bA(aT(self.FoV/2))*2*0.0001;self:updateMappingConstants()self.camera[7]=aT(self.FoV)end;function bD:setWireFrame(aa)self.buffer:useTriangleEdges(aa)end;function bD:getObjectIndexTrace(bk,y,w)local function cy(cz,cA,cB)return(cz.x-cB.x)*(cA.y-cB.y)-(cA.x-cB.x)*(cz.y-cB.y)end;local function cC(cD,cE,g,h,i,j,P,Q,cF,cG,cH,cI)local a0=cy({x=cD,y=cE},{x=g,y=h},{x=i,y=j})<0;local a2=cy({x=cD,y=cE},{x=i,y=j},{x=P,y=Q})<0;local a4=cy({x=cD,y=cE},{x=P,y=Q},{x=g,y=h})<0;return a0==a2 and a2==a4 end;local w=w-1;local cJ={}if self.blittleOn then y=y*2;w=w*3+1 end;local aI=self.camera;local bV={aU(aI[4]or 0),aV(aI[4]or 0),aU(-aI[5]),aV(-aI[5]),aU(aI[6]),aV(aI[6])}local bK=bV[1]local bL=bV[2]local bM=bV[3]local bN=bV[4]local bO=bV[5]local bP=bV[6]for d=1,#bk do local bo=bk[d]local b4=bo[7]local b5=bo[4]local b6=bo[5]local b7=bo[6]if b5 and b5~=0 or b6 and b6~=0 or b7 and b7~=0 then b4=b3(b4,b5,b6,b7)end;local bp=bo[1]local bq=bo[2]local br=bo[3]local c3=self.renderOffsetX;local c4=self.renderOffsetY;local c5=self.sXFactor;local c6=self.sYFactor;local bK=bK;local bL=bL;local bM=bM;local bN=bN;local bO=bO;local bP=bP;local bW=bp-aI[1]local bX=bq-aI[2]local bY=br-aI[3]local function c7(y,w,aY)local bs=y+bW;local bt=w+bX;local bu=aY+bY;local bQ=bN*bs-bM*bu;bu=bM*bs+bN*bu;bs=bQ;local bR=bP*bt-bO*bs;bs=bO*bt+bP*bs;bt=bR;if bK~=0 then local bS=bK*bu-bL*bt;bt=bL*bu+bK*bt;bu=bS end;local bT=bu/bs*c5+c3;local bU=bt/bs*c6+c4;return bT,bU,bs>0 end;for aq=1,#b4 do local aP=b4[aq]local g,h,cK=c7(aP[1],aP[2],aP[3])if cK then local i,j,cL=c7(aP[4],aP[5],aP[6])if cL then local P,Q,cM=c7(aP[7],aP[8],aP[9])if cM then if aP[10]or(i-g)*(Q-j)-(j-h)*(P-i)<0 then if not self.blittleOn then if cC(y,w,g,h,i,j,P,Q,self.x1,self.y1,self.x2,self.y2)then cJ[#cJ+1]={objectIndex=d,polygonIndex=aP[15]}end else if cC(y,w,g,h,i,j,P,Q,(self.x2-1)*2+1,(self.y1-1)*3+1,self.x2*2,(self.y2+1)*3)then cJ[#cJ+1]={objectIndex=d,polygonIndex=aP[15]}end end end end end end end end;if#cJ<=0 then return elseif#cJ==1 then return cJ[1].objectIndex,cJ[1].polygonIndex end;local cN={}local cO=-1;local cP=math.huge;for d=1,#cJ do local bo=bk[cJ[d].objectIndex]local bs=aI[1]-bo[1]local bt=aI[2]-bo[2]local bu=aI[3]-bo[3]local cQ=ab(bs*bs+bt*bt+bu*bu)if cQ<cP then cP=cQ;cO=cJ[d].objectIndex end end;for d=1,#cJ do local bo=bk[cJ[d].objectIndex]local bs=aI[1]-bo[1]local bt=aI[2]-bo[2]local bu=aI[3]-bo[3]local cQ=ab(bs*bs+bt*bt+bu*bu)if cQ==cP then cN[#cN+1]=cJ[d].polygonIndex end end;local bo=bk[cO]local b4=bo[7]local cR=-1;local cS=math.huge;local aM=bo[1]-aI[1]local aN=bo[2]-aI[2]local aO=bo[3]-aI[3]for d=1,#cN do local cT=cN[d]local aP=b4[cT]local aQ=aM+(aP[1]+aP[4]+aP[7])/3;local aR=aN+(aP[2]+aP[5]+aP[8])/3;local aS=aO+(aP[3]+aP[6]+aP[9])/3;local cQ=ab(aQ*aQ+aR*aR+aS*aS)if cQ<cS then cS=cQ;cR=cN[d]end end;return cO,cR end;function bD:newObject(cU,y,w,aY,b5,b6,b7)local b4=nil;local bZ=nil;if type(cU)=="table"then b4,bZ=self:loadModelRaw(cU)else local cV=bv(cU)b4,bZ=self:loadModelRaw(cV)end;local bo={y,w,aY,b5,b6,b7,b4,bZ}bo.frame=self;function bo:setPos(y,w,aY)self[1]=y or self[1]self[2]=w or self[2]self[3]=aY or self[3]end;function bo:setRot(b5,b6,b7)self[4]=b5 or self[4]self[5]=b6 or self[5]self[6]=b7 or self[6]end;function bo:setModel(cU)if type(cU)=="table"then b4,bZ=self.frame:loadModelRaw(cU)self[7]=b4;self[8]=bZ else local cV=bv(cU)b4,bZ=self.frame:loadModelRaw(cV)self[7]=b4;self[8]=bZ end end;return bo end;bD:updateMappingConstants()bD:highResMode(true)return bD end;local cW={}local function cX(g,h,bg,i,j,b0,P,Q,bh,E)return{x1=g,y1=h,z1=bg,x2=i,y2=j,z2=b0,x3=P,y3=Q,z3=bh,c=E}end;function cW:cube(cY)cY.color=cY.color or colors.red;return{cX(-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,cY.bottom or cY.color),cX(-.5,-.5,-.5,.5,-.5,-.5,.5,-.5,.5,cY.bottom2 or cY.bottom or cY.color),cX(-.5,.5,-.5,-.5,.5,.5,.5,.5,.5,cY.top or cY.color),cX(-.5,.5,-.5,.5,.5,.5,.5,.5,-.5,cY.top or cY.color),cX(-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,cY.side or cY.color),cX(-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,cY.side2 or cY.side or cY.color),cX(.5,-.5,-.5,.5,.5,.5,.5,-.5,.5,cY.side or cY.color),cX(.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,cY.side2 or cY.side or cY.color),cX(-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,cY.side or cY.color),cX(-.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5,cY.side2 or cY.side or cY.color),cX(-.5,-.5,.5,.5,-.5,.5,-.5,.5,.5,cY.side or cY.color),cX(.5,-.5,.5,.5,.5,.5,-.5,.5,.5,cY.side2 or cY.side or cY.color)}end;function cW:sphere(cY)cY.res=cY.res or 32;cY.color=cY.color or colors.red;local cZ=1/cY.res;local b4={}local c_={}for d=0,cY.res do local w=0.5*aV(d/cY.res*bz)local d0={}for aq=0,cY.res do local d1=0.5*ab(1-w*2*w*2)local y=aV(aq/cY.res*bz*2)*d1;local aY=aU(aq/cY.res*bz*2)*d1;local i=aV((aq+1)/cY.res*bz*2)*d1;local b0=aU((aq+1)/cY.res*bz*2)*d1;if c_[aq]then b4[#b4+1]={x1=c_[(aq+1)%cY.res].x,y1=c_[(aq+1)%cY.res].y,z1=c_[(aq+1)%cY.res].z,x2=y,y2=w,z2=aY,x3=c_[aq].x,y3=c_[aq].y,z3=c_[aq].z,c=cY.color}b4[#b4+1]={x1=i,y1=w,z1=b0,x2=y,y2=w,z2=aY,x3=c_[(aq+1)%cY.res].x,y3=c_[(aq+1)%cY.res].y,z3=c_[(aq+1)%cY.res].z,c=cY.color2 or cY.color}end;d0[aq]={x=y,y=w,z=aY}end;c_=d0 end;if cY.colors or cY.top or cY.bottom then for d=1,#b4 do local d2=b4[d]local aR=(d2.y1+d2.y2+d2.y3)/3;if cY.colors then local d3=o((-aR+0.5)*#cY.colors+1)d2.c=cY.colors[d3]or d2.c else if aR>=0 then d2.c=cY.top or d2.c else d2.c=cY.bottom or d2.c end end end end;return b4 end;function cW:icosphere(cY)cY.res=cY.res or 1;local d4=(1+ab(5))/2;local aB={{d4,1,0},{d4,-1,0},{-d4,-1,0},{-d4,1,0},{1,0,d4},{-1,0,d4},{-1,0,-d4},{1,0,-d4},{0,d4,1},{0,d4,-1},{0,-d4,-1},{0,-d4,1}}local function d5(d6,d7,d8)return cX(aB[d6][1],aB[d6][2],aB[d6][3],aB[d7][1],aB[d7][2],aB[d7][3],aB[d8][1],aB[d8][2],aB[d8][3],cY.colors and 1 or cY.color)end;local b4={d5(11,2,12),d5(11,8,2),d5(11,7,8),d5(11,3,7),d5(11,12,3),d5(4,7,3),d5(4,10,7),d5(4,9,10),d5(4,6,9),d5(4,3,6),d5(5,6,12),d5(5,9,6),d5(5,1,9),d5(5,2,1),d5(5,12,2),d5(3,12,6),d5(1,8,10),d5(1,10,9),d5(1,2,8),d5(10,8,7)}local function d9()local da={}for d=1,#b4 do local d2=b4[d]local db={x=(d2.x1+d2.x2)/2,y=(d2.y1+d2.y2)/2,z=(d2.z1+d2.z2)/2}local dc={x=(d2.x1+d2.x3)/2,y=(d2.y1+d2.y3)/2,z=(d2.z1+d2.z3)/2}local dd={x=(d2.x2+d2.x3)/2,y=(d2.y2+d2.y3)/2,z=(d2.z2+d2.z3)/2}local de=d2.c;if cY.colorsFractal then de=de%#cY.colors+1 end;da[#da+1]=cX(db.x,db.y,db.z,dd.x,dd.y,dd.z,dc.x,dc.y,dc.z,d2.c)da[#da+1]=cX(d2.x1,d2.y1,d2.z1,db.x,db.y,db.z,dc.x,dc.y,dc.z,de)da[#da+1]=cX(db.x,db.y,db.z,d2.x2,d2.y2,d2.z2,dd.x,dd.y,dd.z,de)da[#da+1]=cX(dc.x,dc.y,dc.z,dd.x,dd.y,dd.z,d2.x3,d2.y3,d2.z3,de)end;b4=da end;for d=1,cY.res-1 do d9()end;local function df(y,w,aY)local dg=math.sqrt(y*y+w*w+aY*aY)local dh=0.5/dg;return y*dh,w*dh,aY*dh end;for d=1,#b4 do local d2=b4[d]d2.x1,d2.y1,d2.z1=df(d2.x1,d2.y1,d2.z1)d2.x2,d2.y2,d2.z2=df(d2.x2,d2.y2,d2.z2)d2.x3,d2.y3,d2.z3=df(d2.x3,d2.y3,d2.z3)if not cY.colorsFractal then local aR=(d2.y1+d2.y2+d2.y3)/3;if cY.colors then local d3=math.floor((-aR+0.5)*#cY.colors+1)d2.c=cY.colors[d3]or d2.c else if aR>=0 then d2.c=cY.top or d2.c else d2.c=cY.bottom or d2.c end end else d2.c=cY.colors[d2.c]end end;return b4 end;function cW:plane(cY)cY.color=cY.color or colors.lime;cY.size=cY.size or 1;cY.y=cY.y or 0;return{cX(-1*cY.size,cY.y,1*cY.size,1*cY.size,cY.y,-1*cY.size,-1*cY.size,cY.y,-1*cY.size,cY.color),cX(-1*cY.size,cY.y,1*cY.size,1*cY.size,cY.y,1*cY.size,1*cY.size,cY.y,-1*cY.size,cY.color)}end;function cW:mountains(cY)cY.res=cY.res or 20;cY.randomOffset=cY.randomOffset or 0;cY.height=cY.height or 1;cY.randomHeight=cY.randomHeight or 0;cY.y=cY.y or 0;cY.scale=cY.scale or 100;cY.color=cY.color or colors.green;cY.snowColor=cY.snowColor or colors.white;local di=3/cY.res*cY.height/(cY.randomHeight+1)local dj=3/cY.res*cY.height*(cY.randomHeight+1)local b4={}for d=0,cY.res do local dk=math.random(-cY.randomOffset*100,cY.randomOffset*100)/100;local dl=d+dk;local g=aV((dl-1)/cY.res*bz*2)*cY.scale;local bg=aU((dl-1)/cY.res*bz*2)*cY.scale;local i=aV((dl-0.5)/cY.res*bz*2)*cY.scale;local b0=aU((dl-0.5)/cY.res*bz*2)*cY.scale;local P=aV(dl/cY.res*bz*2)*cY.scale;local bh=aU(dl/cY.res*bz*2)*cY.scale;local dm=math.random(di*100,dj*100)/100*cY.scale;local aP={x1=g,y1=cY.y,z1=bg,x2=P,y2=cY.y,z2=bh,x3=i,y3=cY.y+dm,z3=b0,c=cY.color,forceRender=true}b4[#b4+1]=aP;if cY.snow then local dn=0.93;local dp=cY.snowHeight or 0.5;local dq=1-dp*dj/(dm/cY.scale)dq=n(0,m(1,dq))if dq>0.2 then local dr={x1=(g*dq+i*(1-dq))*dn,y1=cY.y+dm*(1-dq),z1=(bg*dq+b0*(1-dq))*dn,x2=(P*dq+i*(1-dq))*dn,y2=cY.y+dm*(1-dq),z2=(bh*dq+b0*(1-dq))*dn,x3=i*dn,y3=cY.y+dm,z3=b0*dn,c=cY.snowColor,forceRender=true}b4[#b4+1]=dr end end end;return b4 end;local ds={}function ds:invertTriangles(b4)if not b4 or type(b4)~="table"then error("transforms:invertTriangles expected arg#1 to be a table (model)")end;local da={}for d=1,#b4 do local dt=b4[d]local du={x1=dt.x1,y1=dt.y1,z1=dt.z1,x2=dt.x3,y2=dt.y3,z2=dt.z3,x3=dt.x2,y3=dt.y2,z3=dt.z2,c=dt.c,char=dt.char,charc=dt.charc,forceRender=dt.forceRender,outlineColor=dt.outlineColor}da[d]=du end;return da end;function ds:setOutline(b4,cY)if not b4 or type(b4)~="table"then error("transforms:invertTriangles expected arg#1 to be a table (model)")end;for d=1,#b4 do local dt=b4[d]if type(cY)=="table"then dt.outlineColor=cY[dt.c]or dt.outlineColor else dt.outlineColor=cY end end;return b4 end;return{newFrame=bB,loadModel=bv,newBuffer=q,linear=f,models=cW,transforms=ds}
